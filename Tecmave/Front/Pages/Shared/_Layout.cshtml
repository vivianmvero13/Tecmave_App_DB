@using Microsoft.AspNetCore.Identity
@using Tecmave.Front.Models
@inject SignInManager<Usuario> SignInManager
@inject UserManager<Usuario> UserManager

@{
    var roles = new List<string>();
    Usuario? currentUser = null;

    if (SignInManager.IsSignedIn(User))
    {
        currentUser = await UserManager.GetUserAsync(User);
        if (currentUser != null)
        {
            roles = (await UserManager.GetRolesAsync(currentUser)).ToList();
        }
    }

    bool isAdmin = roles.Contains("Admin");
    bool isCliente = roles.Contains("Cliente");
}
<!DOCTYPE html>
<html lang="es" class="@(roles.Contains("Admin") ? "role-admin" : "")">
<head>
    <meta name="api-base" content="https://tecmave-api.azurewebsites.net">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - TECMAVE CR</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="~/assets/css/styles.css" />
    <link rel="stylesheet" href="~/assets/css/disney-style.css" />
    <link rel="stylesheet" href="~/assets/css/dark-theme.css" />
    <link rel="stylesheet" href="~/assets/css/dashboard.css" />
    <link rel="stylesheet" href="~/assets/css/theme-lighten.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="~/assets/css/brand-red-hard.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="~/css/adminDashboard.css" />
</head>
<body data-user-id="@(currentUser?.Id)"
      data-user-name="@(currentUser?.UserName ?? "Usuario")"
      data-is-admin="@(isAdmin.ToString().ToLower())"
      data-is-cliente="@(isCliente.ToString().ToLower())">

    <div class="app">
        <aside class="sidebar">
            <div class="brand">
                <img src="~/assets/img/tecmave_logo_innovacion.jpg" alt="Tecmave" />
                <span>Tecmave</span>
            </div>
            <div class="subtle">Gestión</div>
            <nav class="nav">

                @if (isCliente)
                {
                    <a asp-page="/Index"><i class="fa-solid fa-gauge-high"></i> Panel</a>
                    <a asp-page="/Home"><i class="fa-solid fa-house"></i> Home</a>
                    <a asp-page="/Servicios/Index"><i class="fa-solid fa-screwdriver-wrench"></i> Agendar servicio</a>
                    <a asp-page="/Vehiculos/Crear"><i class="fa-solid fa-car-side"></i> Mis vehículos</a>
                    <a asp-page="/Promociones/NuestrasPromociones"><i class="fa-solid fa-tags"></i> Promociones</a>
                    <a asp-page="/Colaboradores/MisMantenimientos"><i class="fa-solid fa-clipboard-list"></i> Mis mantenimientos</a>
                    <a asp-page="/Factura/MisFacturas"><i class="fa-solid fa-clipboard-list"></i> Mis facturas</a>
                }

                @if (isAdmin)
                {
                    <nav class="nav">
                        <a asp-page="/Index"><i class="fa-solid fa-gauge-high"></i> Panel</a>
                        <a asp-page="/Home"><i class="fa-solid fa-house"></i> Home</a>
                        <a asp-page="/Usuarios/Index"><i class="fa-solid fa-user-group"></i> Usuarios</a>
                        <a asp-page="/Vehiculos/Index"><i class="fa-solid fa-car"></i> Vehículos</a>
                        <a asp-page="/Promociones/Index"><i class="fa-solid fa-car"></i> Promociones</a>
                        <a asp-page="/Mantenimientos/Index"><i class="fa-solid fa-user-group"></i> Mantenimientos</a>
                        <a asp-page="/Revisiones/Index"><i class="fa-solid fa-id-badge"></i> Revisiones</a>
                        <a asp-page="/Colaboradores/Index"><i class="fa-solid fa-id-badge"></i> Colaboradores</a>
                        <a asp-page="/Factura/Index"><i class="fa-solid fa-file-invoice-dollar"></i> Facturación</a>
                        <a asp-page="/Planillas/Index"><i class="fa-solid fa-file-invoice-dollar"></i> Planillas</a>
                        <a asp-page="/Estadisticas/Index"><i class="fa-solid fa-chart-line"></i> Auditoría</a>
                    </nav>
                }
            </nav>

            <div class="subtle">Cuenta</div>
            <nav class="nav">
                @if (SignInManager.IsSignedIn(User) && currentUser != null)
                {
                    <a asp-page="/Usuarios/Editar" asp-route-id="@currentUser.Id">
                        <i class="fa-regular fa-circle-user"></i> Administrar perfil
                    </a>

                    <!-- FORMULARIO OCULTO DE LOGOUT -->
                    <form id="logout-form"
                          method="post"
                          asp-page="/Account/Logout"
                          asp-route-returnUrl="/"
                          style="display:none;">
                    </form>


                    <!-- BOTÓN QUE EJECUTA EL LOGOUT -->
                    <a href="#" id="logout-btn">
                        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
                    </a>
                }
                else
                {
                    <a id="login-link" asp-page="/Account/Login">
                        <i class="fa-regular fa-circle-user"></i> Iniciar sesión
                    </a>
                }
            </nav>
        </aside>

        <header class="topbar">
            <button class="iconbtn" data-toggle-sidebar><i class="fa-solid fa-bars"></i></button>
            <div id="site-header" class="brand2">
                <img class="logo-xs" src="~/assets/img/tecmave_logo_innovacion.jpg" alt="Tecmave"
                     style="width:20px;height:20px;border-radius:6px;margin-right:6px;" />
                <span>@ViewData["Title"] | TECMAVE</span>
            </div>
            <div class="search">
                <input type="search" placeholder="Buscar clientes, placas, servicios…" />
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M21 21l-4.3-4.3M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="1.6" />
                </svg>
            </div>
            <partial name="_LoginPartial" />
        </header>

        <main class="main" style="padding-bottom:0;margin-bottom:0;">
            @RenderBody()
        </main>

    </div>

    <!-- Modal global -->
    <div id="appFeedbackModal" class="app-modal">
        <div class="app-modal-dialog">
            <div class="app-modal-icon" id="appModalIcon">
                <i class="fa-solid fa-circle-info"></i>
            </div>
            <div class="app-modal-content">
                <h4 class="app-modal-title" id="appModalTitle">Aviso</h4>
                <p class="app-modal-message" id="appModalMessage"></p>
                <div class="app-modal-footer">
                    <button type="button" id="appModalClose" class="btn primary">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="~/js/dashboard.js"></script>
    <script defer src="~/js/global-modal.js"></script>
    <script defer src="~/js/nav-active.js"></script>
    <script defer src="~/js/role-ui.js"></script>
    <script defer src="~/js/carousel-polish.js"></script>
    <script defer src="~/js/app.js"></script>

    <footer class="footer-v2" id="site-footer">
        <div class="footer-v2-main">
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-col">
                        <img src="~/assets/img/tecmave_logo_innovacion.jpg" alt="Tecmave Logo" class="footer-logo" />
                        <p class="footer-slogan">Simply #1 Real Estate Theme</p>
                        <div class="footer-v2-socials">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-pinterest"></i></a>
                            <a href="#"><i class="fab fa-youtube"></i></a>
                            <a href="#"><i class="fas fa-rss"></i></a>
                        </div>
                    </div>
                    <div class="footer-col">
                        <h4>Quick Links</h4>
                        <ul class="footer-list">
                            <li><a href="/Index">Home</a></li>
                            <li><a href="#">List Layout</a></li>
                            <li><a href="/Informacion">Blog</a></li>
                            <li><a href="/Contacto">Contact</a></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Contact Us</h4>
                        <ul class="footer-list contact-info">
                            <li><i class="fas fa-map-marker-alt"></i> <span>3015 Grand Ave, Coconut Grove, Merrick Way, FL 12345</span></li>
                            <li><i class="fas fa-phone-alt"></i> <span>+123-456-789</span></li>
                            <li><i class="fas fa-envelope"></i> <span>sales@example.com</span></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Remain Updated</h4>
                        <form class="subscribe-form">
                            <input type="email" placeholder="Your email address" />
                            <button type="submit">Sign up</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-v2-bottom">
            <div class="container">
                <p>© 2025 All rights reserved.</p>
                <p>Designed by TECMAVE</p>
            </div>
        </div>
    </footer>

    <script src="~/assets/js/dashboard.js"></script>
    <script src="~/assets/js/nav-active.js"></script>
    <script src="~/assets/js/global-features.js"></script>
    <script src="~/assets/js/footer-config.js"></script>
    <script src="~/assets/js/translator.js"></script>

    <script>
        (function () {
            document.addEventListener('DOMContentLoaded', function () {
                try {
                    var body = document.body;
                    if (!body) return;
                    var isAdmin = (body.getAttribute('data-is-admin') || 'false') === 'true';
                    var isCliente = (body.getAttribute('data-is-cliente') || 'false') === 'true';
                    var userName = body.getAttribute('data-user-name') || 'Usuario';
                    var userId = body.getAttribute('data-user-id') || null;

                    var role = 'anon';
                    if (isAdmin) role = 'admin';
                    else if (isCliente) role = 'cliente';

                    var userObj = { id: userId, name: userName, role: role };
                    if (window.localStorage) {
                        localStorage.setItem('user', JSON.stringify(userObj));
                    }
                } catch (e) {
                    console && console.warn && console.warn('No se pudo sincronizar el usuario para el chatbot', e);
                }
            });
        })();
    </script>
    <script src="~/assets/js/chatbot.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            try {
                var sidebar = document.querySelector('.sidebar');
                if (!sidebar) return;

                var overlay = document.querySelector('.sidebar-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'sidebar-overlay';
                    document.body.appendChild(overlay);
                }

                function setClosed() {
                    sidebar.classList.remove('open');
                    sidebar.style.transform = 'translateX(-100%)';
                    sidebar.style.visibility = '';
                    sidebar.style.opacity = '';
                    overlay.classList.remove('active');
                }

                function setOpen() {
                    sidebar.classList.add('open');
                    sidebar.style.transform = 'translateX(0)';
                    sidebar.style.visibility = 'visible';
                    sidebar.style.opacity = '1';
                    overlay.classList.add('active');
                }

                setClosed();

                document.addEventListener('click', function (ev) {
                    var toggleBtn = ev.target.closest('[data-toggle-sidebar]');
                    if (toggleBtn) {
                        ev.preventDefault();
                        var isOpen = sidebar.classList.contains('open');
                        if (isOpen) setClosed(); else setOpen();
                    }
                });

                overlay.addEventListener('click', function (ev) {
                    ev.preventDefault();
                    setClosed();
                });
            } catch (e) {
                console && console.error && console.error('Error inicializando sidebar:', e);
            }
        });
    </script>

    @RenderSection("Scripts", required: false)

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const logoutBtn = document.getElementById("logout-btn");
            const logoutForm = document.getElementById("logout-form");

            if (logoutBtn && logoutForm) {
                logoutBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    logoutForm.submit();
                });
            }
        });
    </script>

</body>
</html>
