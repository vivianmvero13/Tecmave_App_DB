@page
@model Front.Pages.Roles.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Roles Registrados";
}

<h1>Roles Registrados</h1>

<div class="table-responsive mt-4">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Rol</th>
                <th>Descripción</th>
                <th>Activo</th>
            </tr>
        </thead>
        <tbody id="rolTable"></tbody>
    </table>
</div>

<hr class="my-5" />

<h2>Asignar rol a usuarios</h2>
<p class="text-muted">
    Política: un único rol por usuario. Si ya tiene uno, se pedirá confirmación para reemplazarlo.
</p>

<!-- ==================== SELECT DE CANTIDAD ==================== -->
<div class="d-flex align-items-center gap-3 mb-2">
    <label class="mb-0">Mostrar:</label>
    <select id="rolesPageSize" class="form-select form-select-sm" style="width:80px;">
        <option value="5" selected>5</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
    </select>
</div>

<!-- ==================== TABLA DE USUARIOS ==================== -->
<div class="table-responsive mt-3">
    <table class="table table-bordered align-middle">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Rol actual</th>
                <th>Asignar rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="usuariosRolesTable"></tbody>
    </table>

    <!-- ==================== PAGINACIÓN ==================== -->
    <nav aria-label="Paginación usuarios roles" class="roles-pagination-nav mt-3">
        <ul class="pagination pagination-sm mb-0 d-flex flex-row align-items-center gap-2"
            style="list-style:none; margin:0; padding:0;">

            <li class="page-item" id="rolesPrevPageItem" style="list-style:none;">
                <button class="page-link" id="rolesPrevPageBtn" type="button">&laquo;</button>
            </li>

            <li class="page-item disabled" style="list-style:none;">
                <span class="page-link" id="rolesPageInfo">1 / 1</span>
            </li>

            <li class="page-item" id="rolesNextPageItem" style="list-style:none;">
                <button class="page-link" id="rolesNextPageBtn" type="button">&raquo;</button>
            </li>

        </ul>
    </nav>

    <div class="mt-4 d-flex gap-2">
        <a class="btn btn-secondary" asp-page="/Usuarios/Index">Volver</a>
    </div>
</div>

<script src="~/lib/jquery/jquery.min.js"></script>
<script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>

<style>
    /* ================= Paginación Profesional ================= */
    .roles-pagination-nav .pagination {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0.5rem !important;
    }

    .roles-pagination-nav .page-item {
        list-style: none !important;
    }

    .roles-pagination-nav .page-link {
        display: flex !important;
        align-items: center;
        justify-content: center;
        padding: .35rem .65rem;
        border-radius: 8px;
        cursor: pointer;
    }
</style>

<script>
    const API = 'http://kaledcrc-001-site1.mtempurl.com';
    const ROLES_URL = `${API}/api/roles`;
    const USERS_URL = `${API}/api/usuarios`;

    // ================= VARIABLES DE PAGINACIÓN ================
    let rolesPage = 1;
    let rolesPageSize = 5;
    let allUsersRoles = [];

    $(function () {
        cargarRoles();
        cargarUsuariosConRol();
        $("#rolesPageSize").on("change", () => {
            rolesPageSize = Number($("#rolesPageSize").val());
            rolesPage = 1;
            renderRolesPaged();
        });

        $("#rolesPrevPageBtn").on("click", () => {
            if (rolesPage > 1) {
                rolesPage--;
                renderRolesPaged();
            }
        });

        $("#rolesNextPageBtn").on("click", () => {
            const totalPages = Math.ceil(allUsersRoles.length / rolesPageSize);
            if (rolesPage < totalPages) {
                rolesPage++;
                renderRolesPaged();
            }
        });
    });

    // Helpers de escape
    function safe(v) { return v == null ? "" : escapeHtml(String(v)); }
    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;',
            '"': '&quot;', "'": '&#39;'
        }[m]));
    }

    // ================== CARGAR ROLES ==================
    function cargarRoles() {
        $.getJSON(ROLES_URL, roles => {
            const $tbody = $('#rolTable').empty();

            roles.forEach(r => {
                const tr = `
                    <tr>
                        <td>${safe(r.name ?? r.Name)}</td>
                        <td>${safe(r.description ?? r.Description) || "<span class='text-muted'>—</span>"}</td>
                        <td>${(r.isActive ?? r.is_active) ? "<span class='badge bg-success'>Sí</span>" : "<span class='badge bg-secondary'>No</span>"}</td>
                    </tr>`;
                $tbody.append(tr);
            });

            window.__rolesActivos = roles.filter(r => r.isActive ?? r.is_active)
                .map(r => ({ name: r.name }));
        });
    }

    // =============== CARGAR USUARIOS Y PAGINAR ===============
    async function cargarUsuariosConRol() {
        const res = await fetch(USERS_URL);
        const usuarios = await res.json();

        allUsersRoles = [];

        for (const u of usuarios) {
            const r = await fetch(`${USERS_URL}/${u.id}/role`);
            const rData = r.ok ? await r.json() : {};
            const rolActual = rData.role || null;

            allUsersRoles.push({
                id: u.id,
                nombre: u.nombre ?? u.userName,
                rol: rolActual
            });
        }

        renderRolesPaged();
    }

    function renderRolesPaged() {
        const $tbody = $("#usuariosRolesTable").empty();

        const start = (rolesPage - 1) * rolesPageSize;
        const end = start + rolesPageSize;
        const pageItems = allUsersRoles.slice(start, end);

        pageItems.forEach(u => {
            const selectHtml = buildRolesSelect(u.id);

            const tr = `
                <tr>
                    <td>${safe(u.nombre)}</td>
                    <td>${u.rol ? safe(u.rol) : "<i class='text-muted'>Sin rol</i>"}</td>
                    <td>${selectHtml}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario(${u.id})">Eliminar usuario</button>
                    </td>
                </tr>`;
            $tbody.append(tr);
        });

        const totalPages = Math.ceil(allUsersRoles.length / rolesPageSize);
        $("#rolesPageInfo").text(`${rolesPage} / ${totalPages}`);

        $("#rolesPrevPageItem").toggleClass("disabled", rolesPage <= 1);
        $("#rolesNextPageItem").toggleClass("disabled", rolesPage >= totalPages);
    }

    function buildRolesSelect(userId) {
        const roles = window.__rolesActivos || [];
        return `
            <div class="input-group">
                <select class="form-select" id="sel_${userId}">
                    <option value="" disabled selected>Seleccionar…</option>
                    ${roles.map(r => `<option value="${safe(r.name)}">${safe(r.name)}</option>`).join("")}
                </select>
                <button class="btn btn-outline-success" onclick="asignarRol(${userId})">Asignar</button>
            </div>`;
    }

    // ================= ASIGNAR ROL =================
    async function asignarRol(userId) {
        const sel = document.getElementById(`sel_${userId}`);
        if (!sel || !sel.value) return alert("Selecciona un rol.");

        const body = { roleName: sel.value, forceReplace: true };

        const res = await fetch(`${USERS_URL}/${userId}/role`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            cargarUsuariosConRol();
            alert("Rol asignado correctamente.");
        } else {
            alert("Error asignando rol.");
        }
    }

    // ================= ELIMINAR USUARIO =================
    async function eliminarUsuario(userId) {
        if (!confirm("¿Eliminar usuario definitivamente?")) return;

        const res = await fetch(`${USERS_URL}/${userId}`, { method: "DELETE" });

        if (res.ok) {
            cargarUsuariosConRol();
            alert("Usuario eliminado.");
        } else {
            alert("Error eliminando usuario.");
        }
    }
</script>
