@page
@model Front.Pages.Roles.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Roles Registrados";
}

<h1>Roles Registrados</h1>

<div class="table-responsive mt-4">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Rol</th>
                <th>Descripción</th>
                <th>Activo</th>
            </tr>
        </thead>
        <tbody id="rolTable"></tbody>
    </table>
</div>

<hr class="my-5" />

<h2>Asignar rol a usuarios</h2>
<p class="text-muted">
    Política: un único rol por usuario. Si ya tiene uno, se pedirá confirmación para reemplazarlo.
</p>

<div class="table-responsive mt-3">
    <table class="table table-bordered align-middle">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Rol actual</th>
                <th>Asignar rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="usuariosRolesTable"></tbody>
    </table>
</div>

<script src="~/lib/jquery/jquery.min.js"></script>
<script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>

<script>
    const API = 'https://tecmave-api.azurewebsites.net';
    const ROLES_URL = `${API}/api/roles`;
    const USERS_URL = `${API}/api/usuarios`;

    $(function () {
        cargarRoles();
        cargarUsuariosConRol();
    });

    // Helpers de escape
    function safe(v) {
        return v === null || v === undefined ? '' : escapeHtml(String(v));
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        }[m]));
    }

    function escapeAttr(s) {
        return String(s).replace(/"/g, '&quot;');
    }

    // ================== ROLES ==================
    function cargarRoles() {
        $.getJSON(ROLES_URL, function (roles) {
            const $tbody = $('#rolTable').empty();

            roles.forEach(r => {
                const name = r.name ?? r.Name ?? '';
                const desc = r.description ?? r.Description ?? '';
                const isActive = (r.is_active ?? r.isActive ?? r.IsActive) === true;

                const tr = `
                    <tr>
                        <td>${safe(name)}</td>
                        <td>${desc ? safe(desc) : '<span class="text-muted">—</span>'}</td>
                        <td>${
                            isActive
                                ? '<span class="badge bg-success">Sí</span>'
                                : '<span class="badge bg-secondary">No</span>'
                        }</td>
                    </tr>`;
                $tbody.append(tr);
            });

            // Guardar roles activos para selects
            window.__rolesActivos = roles
                .filter(r => (r.is_active ?? r.isActive ?? r.IsActive) === true)
                .map(r => ({
                    name: r.name ?? r.Name ?? ''
                }));
        }).fail(err => {
            console.error('Error cargando roles', err);
            alert('No se pudieron cargar los roles.');
        });
    }

    function verDetallesRol(roleId) {
        $.getJSON(`${ROLES_URL}/${roleId}/details`, function (det) {
            $('#detNombre').text(det.name ?? '');
            $('#detDescripcion').text(det.description ?? '—');
            $('#detActivo').html(det.isActive ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>');
            const perms = (det.permissions || []);
            $('#detPermisos').html(perms.length
                ? '<ul>' + perms.map(p => `<li>${escapeHtml(p)}</li>`).join('') + '</ul>'
                : '<span class="text-muted">Sin permisos definidos</span>');
            const modal = new bootstrap.Modal(document.getElementById('roleDetailsModal'));
            modal.show();
        }).fail(err => {
            console.error('Error obteniendo detalles del rol', err);
            alert('No se pudieron obtener los detalles del rol.');
        });
    }

    // ================== USUARIOS + ROLES ==================
    async function cargarUsuariosConRol() {
        try {
            const uRes = await fetch(USERS_URL);
            if (!uRes.ok) throw new Error('Error al obtener usuarios');
            const usuarios = await uRes.json();

            const $tbody = $('#usuariosRolesTable').empty();

            for (const u of usuarios) {
                const rRes = await fetch(`${USERS_URL}/${u.id}/role`);
                const rJson = rRes.ok ? await rRes.json() : {};
                const currentRole = rJson.role || rJson.Role || null;

                const selectHtml = buildRolesSelect(u.id);
                const nombreMostrar = u.nombre ?? u.Nombre ?? u.userName ?? u.UserName ?? '';

                const tr = `
                    <tr>
                      <td>${safe(nombreMostrar)}</td>
                      <td>${currentRole ? safe(currentRole) : '<i class="text-muted">Sin rol</i>'}</td>
                      <td>${selectHtml}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-danger" type="button" onclick="eliminarUsuario(${u.id})">
                            Eliminar usuario
                        </button>
                      </td>
                    </tr>`;
                $tbody.append(tr);
            }
        } catch (err) {
            console.error('Error cargando usuarios/roles', err);
            alert('No se pudieron cargar los usuarios y sus roles.');
        }
    }

    function buildRolesSelect(userId) {
        const roles = window.__rolesActivos || [];
        const options = roles
            .map(r => `<option value="${escapeAttr(r.name)}">${escapeHtml(r.name)}</option>`)
            .join('');
        return `
            <div class="input-group">
                <select class="form-select" id="sel_${userId}">
                    <option value="" selected disabled>Selecciona rol…</option>
                    ${options}
                </select>
                <button class="btn btn-outline-success" type="button" onclick="asignarRol(${userId})">Asignar</button>
            </div>
        `;
    }

    async function asignarRol(userId) {
        const sel = document.getElementById(`sel_${userId}`);
        if (!sel || !sel.value) {
            alert('Selecciona un rol.');
            return;
        }
        const roleName = sel.value;
        let body = { roleName, forceReplace: false };

        let res = await fetch(`${USERS_URL}/${userId}/role`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            await recargarUsuarios();
            alert('Rol asignado correctamente.');
            return;
        }

        if (res.status === 409) {
            const data = await res.json();
            const msg = data.message || data.Message || `El usuario ya tiene un rol.`;
            const previous = data.previous || data.Previous;
            const ok = confirm(`${msg}\n\n¿Deseas reemplazar el rol '${previous}' por '${roleName}'?`);
            if (ok) {
                body.forceReplace = true;
                res = await fetch(`${USERS_URL}/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    await recargarUsuarios();
                    alert('Rol reemplazado correctamente.');
                    return;
                }
            }
        }

        try {
            const err = await res.json();
            alert(`Error: ${err.Message || err.message || 'No se pudo asignar el rol.'}`);
        } catch {
            alert('No se pudo asignar el rol.');
        }
    }

    // ================== ELIMINAR USUARIO ==================
    async function eliminarUsuario(userId) {
        if (!confirm('⚠️ Vas a ELIMINAR este usuario y todos sus datos relacionados. Esta acción es irreversible. ¿Deseas continuar?')) {
            return;
        }

        const res = await fetch(`${USERS_URL}/${userId}`, { method: 'DELETE' });

        if (res.ok) {
            await recargarUsuarios();
            alert('Usuario eliminado correctamente.');
        } else {
            try {
                const err = await res.json();
                alert(`Error al eliminar usuario: ${err.message || err.Message || 'No se pudo eliminar.'}`);
            } catch {
                alert('No se pudo eliminar el usuario (error desconocido).');
            }
        }
    }

    async function recargarUsuarios() {
        await cargarUsuariosConRol();
    }
</script>
