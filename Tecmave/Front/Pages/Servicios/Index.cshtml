@page
@model Front.Pages.Servicios.IndexModel
@{
    ViewData["Title"] = "Agendar Revisión";
}

<style>
    /* ========================
                   ESTILOS MEJORADOS
                   ======================== */

    /* Tarjetas */
    .card {
        background: #1a1a1a;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        color: #ddd;
    }

    h3 {
        margin-bottom: 1rem;
        color: #000 !important;
    }

    /* Inputs */
    .input, select {
        width: 100%;
        padding: .7rem;
        background: #111;
        border: 1px solid #333;
        color: #eee;
        border-radius: 8px;
        margin-top: .3rem;
    }

        .input:focus {
            border-color: #5a9cff;
        }

    /* Tabla */
    .table {
        width: 100%;
        margin-top: 1rem;
        color: #111111 !important;
    }

        .table th {
            background: #222;
            padding: .5rem;
        }

        .table td {
            padding: .5rem;
            border-bottom: 1px solid #333;
        }

    /* Botón */
    #btnAgendar, .btn-proforma {
        background: #5a9cff;
        padding: .7rem 1rem;
        border: none;
        border-radius: 8px;
        margin-top: 1rem;
        color: white;
        cursor: pointer;
        transition: 0.2s;
    }

        #btnAgendar:hover, .btn-proforma:hover {
            background: #7ab3ff;
        }

    .btn-proforma {
        margin-right: .25rem;
    }

    /* ================
                   MODAL MEJORADO
                   ================ */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
        z-index: 9999;
        animation: fadeIn .2s ease-in-out;
    }

    .modal-content {
        background: #f9fafb;
        padding: 2rem;
        border-radius: 15px;
        width: 45%;
        max-height: 80vh;
        overflow-y: auto;
        color: #000 !important;
        border: 1px solid #444;
        animation: slideUp .25s ease;
        position: relative;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            transform: translateY(20px);
        }

        to {
            transform: translateY(0);
        }
    }

    .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.6rem;
        cursor: pointer;
        color: #555;
    }

        .close:hover {
            color: #000;
        }

    .btn-pdf {
        background: #28a745;
        padding: .6rem 1rem;
        color: #fff;
        border: none;
        margin-top: .8rem;
        border-radius: 8px;
        cursor: pointer;
        float: right;
    }

    /* ============= ACCORDION PERMISIONS ============= */

    .accordion-item {
        border: 1px solid #333;
        border-radius: 8px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .accordion-header {
        background: #111;
        padding: .7rem 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        color: #ddd;
        border-bottom: 1px solid #333;
    }

        .accordion-header:hover {
            background: #1a1a1a;
        }

    .accordion-body {
        display: none;
        background: #f9fafb;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
        color: #111111 !important;
    }

        .accordion-body label,
        #pertenencias *,
        #pertenencias-container * {
            margin-bottom: .25rem;
            display: flex;
            align-items: center;
            gap: .4rem;
            color: #111111 !important;
        }

    #pertenencias-container {
        display: block;
    }

    #pertenencias {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: .35rem 1rem;
    }

    /* === Correcciones visuales específicas de esta página (Servicios) === */
    select,
    select option {
        color: #ffffff !important;
        background-color: #111111 !important;
    }

    /* Texto dentro de la proforma (modal) más legible y en negro */
    #proformaContent,
    #proformaContent * {
        color: #111111 !important;
    }

    /* Texto del modal de cancelar en negro */
    #cancelarContent,
    #cancelarContent * {
        color: #111111 !important;
    }
</style>

<section class="section">
    <div class="container grid cols-2">

        <!-- Formulario -->
        <div class="card">
            <h3>Agendar Revisión</h3>

            <div>
                <label>Vehículo</label>
                <select class="input" id="vehiculo_id"></select>
            </div>

            <div>
                <label>Tipo de Servicio</label>
                <select class="input" id="tipo_servicio_id"></select>
            </div>

            <div>
                <label>Servicio</label>
                <select class="input" id="servicio_id"></select>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="togglePertenencias()">
                    <span>Pertenencias</span>
                    <span id="arrow-pertenencias">▼</span>
                </div>
                <div id="pertenencias-container" class="accordion-body">
                    <div id="pertenencias" class="grid cols-2"></div>
                </div>
            </div>

            <div>
                <label>Fecha</label>
                <input class="input" id="fecha" type="date" />
            </div>

            <div>
                <label>Hora</label>
                <select class="input" id="hora"></select>
            </div>

            <button id="btnAgendar" type="button">Agendar Revisión</button>
        </div>

        <!-- Listado -->
        <div class="card">
            <h3>Mis Revisiones</h3>

            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Vehículo</th>
                        <th>Servicio</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</section>

<!-- Modal Proforma -->
<div id="modalProforma" style="display:none;">
    <div class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <button class="btn-pdf" onclick="descargarPDF()">
                Descargar PDF
            </button>
            <div id="proformaContent"></div>
        </div>
    </div>
</div>

<!-- Modal Cancelar Cita -->
<div id="modalCancelar" style="display:none;">
    <div class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalCancelar()">&times;</span>
            <div id="cancelarContent"></div>
            <div style="margin-top: 1rem; text-align: right;">
                <button type="button" class="btn-proforma" onclick="confirmarCancelar()">
                    Confirmar cancelación
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Overlay de Carga -->
<div id="loadingOverlay" style="display:none;">
    <div class="modal">
        <div class="modal-content">
            <p>Cargando, por favor espere un momento...</p>
        </div>
    </div>
</div>

<script>
    /* =================================================================================
       CONFIG
       ================================================================================= */
    const API = {
        AGENDAMIENTO: "https://tecmave-api.azurewebsites.net/Agendamiento",
        REVISION: "https://tecmave-api.azurewebsites.net/Revision",
        REV_PERT: "https://tecmave-api.azurewebsites.net/api/RevisionPertenencias",
        SERV_REV: "https://tecmave-api.azurewebsites.net/ServiciosRevision",
        VEHICULO: "https://tecmave-api.azurewebsites.net/Vehiculos",
        SERV: "https://tecmave-api.azurewebsites.net/Servicios",
        TIPO_SERV: "https://tecmave-api.azurewebsites.net/TipoServicios",
        ESTADOS: "https://tecmave-api.azurewebsites.net/Estados"
    };

    const userId = "@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value";

    let cacheVehiculos = {}, cacheServicios = {}, cacheTipos = {}, cacheEstados = {};
    let cacheAgendamientos = [], cacheRevisiones = [];

    let ultimaProforma = null;

    // Para cancelar en modal
    let revisionACancelar = null;
    let agendamientoACancelar = null;

    /* =================================================================================
       INIT
       ================================================================================= */
    $(document).ready(async () => {
        await cargarVehiculos();
        await cargarTipos();
        await cargarServicios();
        await cargarAgendamientos();
        await cargarEstados();
        await cargarRevisiones();
        renderPertenencias();
    });


    /* =================================================================================
       HELPERS LOADING
       ================================================================================= */
    function mostrarLoading() {
        $("#loadingOverlay").show();
    }

    function ocultarLoading() {
        $("#loadingOverlay").hide();
    }

    /* =================================================================================
       CARGA DE DATOS
       ================================================================================= */
    function cargarVehiculos() {
        return $.get(API.VEHICULO, v => {
            const propios = v.filter(x => x.cliente_id == userId);
            $("#vehiculo_id").html(`<option value="">Seleccione</option>`);

            propios.forEach(x => {
                cacheVehiculos[x.id_vehiculo] = x;
                $("#vehiculo_id").append(`<option value="${x.id_vehiculo}">${x.placa} - ${x.modelo}</option>`);
            });
        });
    }

    function cargarTipos() {
        return $.get(API.TIPO_SERV, ts => {
            $("#tipo_servicio_id").html(`<option value="">Seleccione</option>`);
            ts.forEach(x => {
                cacheTipos[x.id_tipo_servicio] = x;
                $("#tipo_servicio_id").append(`<option value="${x.id_tipo_servicio}">${x.nombre}</option>`);
            });
        });
    }

    function cargarServicios() {
        return $.get(API.SERV, s => {
            s.forEach(x => cacheServicios[x.id_servicio] = x);

            $("#tipo_servicio_id").on("change", function () {
                const tipo = $(this).val();
                $("#servicio_id").html(`<option value="">Seleccione</option>`);

                Object.values(cacheServicios)
                    .filter(s => s.tipo_servicio_id == tipo)
                    .forEach(s => $("#servicio_id").append(`<option value="${s.id_servicio}">${s.nombre}</option>`));
            });
        });
    }

    function cargarAgendamientos() {
        return $.get(API.AGENDAMIENTO, a => cacheAgendamientos = a);
    }

    function cargarEstados() {
        return $.get(API.ESTADOS, e => {
            e.forEach(x => {
                cacheEstados[x.id_estado] = x;
            });
        });
    }

    function obtenerIdEstadoPorNombre(nombreBuscado) {
        if (!nombreBuscado) return null;
        const estados = Object.values(cacheEstados);
        const encontrado = estados.find(e => (e.nombre || "").toLowerCase() === nombreBuscado.toLowerCase());
        return encontrado ? encontrado.id_estado : null;
    }

    /* =================================================================================
       PERTENENCIAS
       ================================================================================= */
    function renderPertenencias() {
        const list = ["Radio","Encendedor","Gar Celular","Antena","Espejo","Alfombras","Halogeno","Llave Rana"
        ,"Gata Mec/HD","Herramienta","Triangulos","Lagartos","Llanta de repuesto","Copas","Paraguas","Botiquin"
        ,"Chaleco","Booster","Linga","Extintor"];
        list.forEach(p => {
            $("#pertenencias").append(`
                <label><input type="checkbox" value="${p}"> ${p}</label>
            `);
        });
    }


    /* =================================================================================
       VALIDACIÓN FECHA-HORA
       ================================================================================= */
    $("#fecha").on("change", function () {
        const f = $(this).val();
        if (!f) return;

        const hoy = new Date();
        if (new Date(f) <= hoy) {
            alert("Debe seleccionar una fecha futura.");
            $(this).val("");
            return;
        }

        cargarHorasDisponibles(f);
    });

    function cargarHorasDisponibles(fecha) {
        const horas = generarHoras();

        const ocupadas = cacheAgendamientos
            .filter(a => a.fecha_estimada === fecha)
            .map(a => a.hora_llegada.substring(0, 5));

        const disponibles = horas.filter(h => !ocupadas.includes(h));

        $("#hora").html("");

        if (disponibles.length === 0) {
            $("#hora").append(`<option value="">No hay campos este día</option>`);
            return;
        }

        disponibles.forEach(h => {
            $("#hora").append(`<option value="${h}">${h}</option>`);
        });
    }

    function generarHoras() {
        const lista = [];
        let h = new Date();
        h.setHours(7, 30, 0);

        let fin = new Date();
        fin.setHours(18, 0, 0);

        while (h <= fin) {
            lista.push(h.toTimeString().substring(0, 5));
            h.setMinutes(h.getMinutes() + 30);
        }

        return lista;
    }


    /* =================================================================================
       CREAR REVISIÓN COMPLETA
       ================================================================================= */
    $("#btnAgendar").on("click", async function () {
        const btn = $(this);

        const vehId = $("#vehiculo_id").val();
        const servId = $("#servicio_id").val();
        const fecha = $("#fecha").val();
        const hora = $("#hora").val();

        const pertenencias = $("#pertenencias input:checked")
            .map((_, el) => $(el).val()).get();

        if (!vehId || !servId || !fecha || !hora) {
            alert("Complete todos los campos.");
            return;
        }

        mostrarLoading();
        btn.prop("disabled", true);

        try {
            /* Agendamiento */
            const ag = await $.ajax({
                url: API.AGENDAMIENTO,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    cliente_id: parseInt(userId),
                    vehiculo_id: parseInt(vehId),
                    fecha_agregada: fecha,
                    fecha_estimada: fecha,
                    hora_llegada: hora,
                    id_estado: 12
                })
            });

            /* Revisión */
            const rev = await $.ajax({
                url: API.REVISION,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    vehiculo_id: parseInt(vehId),
                    fecha_ingreso: new Date().toISOString(),
                    id_estado: 4,
                    id_agendamiento: ag.id_agendamiento
                })
            });

            /* Servicio */
            await $.ajax({
                url: API.SERV_REV,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    revision_id: rev.id_revision,
                    servicio_id: parseInt(servId)
                })
            });

            /* Pertenencias */
            for (let p of pertenencias) {
                await $.ajax({
                    url: API.REV_PERT,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        revision_id: rev.id_revision,
                        nombre: p,
                        presente: true
                    })
                });
            }

            alert("Revisión agendada correctamente.");

            await cargarAgendamientos();
            await cargarRevisiones();
        } catch (err) {
            console.error(err);
            alert("Ocurrió un error al agendar la revisión.");
        } finally {
            ocultarLoading();
            btn.prop("disabled", false);
        }
    });


    /* =================================================================================
       LISTADO
       ================================================================================= */
    async function cargarRevisiones() {
        const data = await $.get(API.REVISION);

        const propias = data.filter(r => cacheVehiculos[r.vehiculo_id]?.cliente_id == userId);
        cacheRevisiones = propias;

        $("table tbody").html("");

        for (const r of propias) {
            let servRev;
            try {
                servRev = await $.get(`${API.SERV_REV}/ByRevision/${r.id_revision}`);
            } catch {
                servRev = null;
            }

            const serv = servRev ? cacheServicios[servRev.servicio_id] : null;
            const servicioId = servRev ? servRev.servicio_id : null; // <<<

            const ag = cacheAgendamientos.find(a => a.id_agendamiento === r.id_agendamiento);
            const veh = cacheVehiculos[r.vehiculo_id];
            const estado = ag ? cacheEstados[ag.id_estado] : null;

            $("table tbody").append(`
                <tr>
                    <td>${r.id_revision}</td>
                    <td>${veh?.placa || "-"}</td>
                    <td>${serv?.nombre || "Desconocido"}</td>
                    <td>${ag?.fecha_estimada || "-"}</td>
                    <td>${ag?.hora_llegada || "-"}</td>
                    <td>${estado?.nombre || "-"}</td>
                    <td>
                        <button class="btn-proforma" onclick="verProforma(${r.id_revision})">
                            Ver Proforma
                        </button>
                        <button class="btn-proforma" onclick="cancelarRevision(${r.id_revision})">
                            Cancelar
                        </button>
                        <button class="btn-proforma" onclick="reagendarRevision(${r.id_revision}, ${servicioId ?? 'null'})">
                            Reagendar
                        </button>
                    </td>
                </tr>
            `);
        }
    }


    /* =================================================================================
       PROFORMA
       ================================================================================= */
    function verProforma(id) {
        $.get(`${API.REVISION}/Detalle/${id}`, function (d) {

            ultimaProforma = {
                idRevision: id,
                vehiculo: d.vehiculo,
                servicio: d.servicio,
                tipoServicio: d.tipo_servicio,
                agendamiento: d.agendamiento,
                pertenencias: d.pertenencias || [],
                trabajos: d.trabajos || []
            };


            const veh = d.vehiculo;
            const s = d.servicio;
            const t = d.tipo_servicio;
            const ag = d.agendamiento;

            let html = `
                <h2>Proforma Detallada</h2>

                <h3>Vehículo</h3>
                <p>${veh.placa} - ${veh.modelo} (${veh.id_marca})</p>

                <h3>Servicio</h3>
                <p>${s?.nombre || "No registrado"}</p>
                <small>${t?.nombre || "-"}</small>

                <h3>Fecha y Hora</h3>
                <p>${ag.fecha_estimada} ${ag.hora_llegada}</p>

                <h3>Pertenencias</h3>
            `;

            if (d.pertenencias.length === 0) {
                html += `<p>No registradas.</p>`;
            } else {
                html += `<ul>`;
                d.pertenencias.forEach(p => html += `<li>${p.nombre} — ${p.presente ? "Sí" : "No"}</li>`);
                html += `</ul>`;
            }

            html += `<h3>Trabajos</h3>`;

            if (d.trabajos.length === 0) {
                html += `<p>No se han registrado trabajos.</p>`;
            } else {
                html += `<ul>`;
                d.trabajos.forEach(t2 => html += `<li>${t2.nombre}</li>`);
                html += `</ul>`;
            }

            $("#proformaContent").html(html);
            $("#modalProforma").show();
        });
    }

    function cerrarModal() {
        document.getElementById("modalProforma").style.display = "none";
    }

    async function descargarPDF() {

        if (!ultimaProforma) {
            alert("No hay datos cargados para exportar.");
            return;
        }

        const { jsPDF } = window.jspdf;

        const doc = new jsPDF({
            unit: "mm",
            format: "a4"
        });

        const pageWidth = doc.internal.pageSize.getWidth();
        let y = 12;

        const v = ultimaProforma.vehiculo || {};
        const s = ultimaProforma.servicio || {};
        const ts = ultimaProforma.tipoServicio || {};
        const ag = ultimaProforma.agendamiento || {};
        const pertenencias = ultimaProforma.pertenencias || [];
        const trabajos = ultimaProforma.trabajos || [];

        /* ========================================================
           ENCABEZADO
           ======================================================== */
        doc.setFillColor(26, 26, 26);
        doc.rect(0, 0, pageWidth, 20, "F");

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(255, 255, 255);
        doc.text("Innovación Tecmave — Proforma de Servicio", 10, 12);

        doc.setFontSize(10);
        doc.text(`N.º ${ultimaProforma.idRevision}`, pageWidth - 10, 12, { align: "right" });
        doc.text(`Fecha: ${new Date().toLocaleDateString()}`, pageWidth - 10, 17, { align: "right" });

        // Reset texto
        doc.setTextColor(0, 0, 0);

        y = 30;

        /* ========================================================
           DATOS DEL VEHÍCULO
           ======================================================== */
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Datos del vehículo", 10, y);
        y += 6;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Placa: ${v.placa || "-"}`, 10, y);
        doc.text(`Modelo: ${v.modelo || "-"}`, 80, y);
        y += 5;

        doc.text(`Marca ID: ${v.id_marca || "-"}`, 10, y);
        y += 10;

        /* ========================================================
           DETALLE DEL SERVICIO
           ======================================================== */
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Detalle del servicio", 10, y);
        y += 6;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Tipo de servicio: ${ts?.nombre || "-"}`, 10, y);
        y += 5;

        doc.text(`Servicio seleccionado: ${s?.nombre || "-"}`, 10, y);
        y += 10;

        /* ========================================================
           FECHA Y HORA
           ======================================================== */
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Fecha y hora de revisión", 10, y);
        y += 6;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Fecha: ${ag?.fecha_estimada || "-"}`, 10, y);
        doc.text(`Hora: ${ag?.hora_llegada || "-"}`, 80, y);
        y += 10;

        /* ========================================================
           PERTENENCIAS
           ======================================================== */
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Pertenencias registradas", 10, y);
        y += 7;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);

        if (pertenencias.length === 0) {
            doc.text("No registradas.", 10, y);
            y += 10;
        } else {

            // Encabezado tabla
            doc.setFillColor(230, 230, 230);
            doc.rect(10, y, 80, 6, "F");
            doc.rect(90, y, 30, 6, "F");
            doc.setFont("helvetica", "bold");
            doc.text("Pertenencia", 12, y + 4);
            doc.text("Presente", 92, y + 4);
            y += 8;

            doc.setFont("helvetica", "normal");

            pertenencias.forEach(p => {
                if (y > 265) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(p.nombre || "-", 12, y);
                doc.text(p.presente ? "Sí" : "No", 92, y);
                y += 6;
            });

            y += 10;
        }

        /* ========================================================
           TRABAJOS
           ======================================================== */
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Trabajos registrados", 10, y);
        y += 7;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);

        if (trabajos.length === 0) {
            doc.text("No se han registrado trabajos.", 10, y);
            y += 10;
        } else {
            trabajos.forEach(t => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`• ${t.nombre}`, 12, y);
                y += 5;
            });
            y += 10;
        }

        /* ========================================================
           FIRMA
           ======================================================== */
        if (y > 260) {
            doc.addPage();
            y = 40;
        }

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text("__________________________________", 10, y);
        y += 5;
        doc.text("Firma del cliente", 10, y);

        /* ========================================================
           EXPORTAR
           ======================================================== */
        doc.save(`Proforma_${ultimaProforma.idRevision}.pdf`);
    }

    function togglePertenencias() {
        const body = document.getElementById("pertenencias-container");
        const arrow = document.getElementById("arrow-pertenencias");

        if (body.style.display === "block") {
            body.style.display = "none";
            arrow.textContent = "▼";
        } else {
            body.style.display = "block";
            arrow.textContent = "▲";
        }
    }

    /* =================================================================================
       CANCELAR / REAGENDAR
       ================================================================================= */
    function cancelarRevision(idRevision) {
        const rev = cacheRevisiones.find(r => r.id_revision === idRevision);
        if (!rev) {
            alert("No se encontró la revisión.");
            return;
        }

        const ag = cacheAgendamientos.find(a => a.id_agendamiento === rev.id_agendamiento);
        if (!ag) {
            alert("No se encontró el agendamiento asociado.");
            return;
        }

        const veh = cacheVehiculos[rev.vehiculo_id];

        revisionACancelar = rev;
        agendamientoACancelar = ag;

        const html = `
            <h2>Cancelar cita</h2>
            <p>Está a punto de cancelar la revisión <strong>#${rev.id_revision}</strong>.</p>
            <p><strong>Vehículo:</strong> ${veh?.placa || "-"} - ${veh?.modelo || "-"}</p>
            <p><strong>Fecha:</strong> ${ag.fecha_estimada}</p>
            <p><strong>Hora:</strong> ${ag.hora_llegada}</p>
            <p>¿Desea continuar y cancelar esta cita?</p>
        `;

        $("#cancelarContent").html(html);
        $("#modalCancelar").show();
    }

    function cerrarModalCancelar() {
        $("#modalCancelar").hide();
        revisionACancelar = null;
        agendamientoACancelar = null;
    }

    async function confirmarCancelar() {
        if (!agendamientoACancelar) {
            alert("No se encontró la cita a cancelar.");
            return;
        }

        const ag = agendamientoACancelar;

        const payload = {
            id_agendamiento: ag.id_agendamiento,
            cliente_id: ag.cliente_id,
            vehiculo_id: ag.vehiculo_id,
            fecha_agregada: ag.fecha_agregada,
            fecha_estimada: ag.fecha_estimada,
            hora_llegada: ag.hora_llegada,
            id_estado: 11
        };

        $("#modalCancelar").hide();
        mostrarLoading();

        try {
            await $.ajax({
                url: API.AGENDAMIENTO,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload)
            });

            alert("Revisión cancelada correctamente.");

            await cargarAgendamientos();
            await cargarRevisiones();
        } catch (err) {
            console.error(err);
            alert("Ocurrió un error al cancelar la revisión.");
        } finally {
            ocultarLoading();
            revisionACancelar = null;
            agendamientoACancelar = null;
        }
    }

    // <<< NUEVO: Reagendar precargando el formulario de "Agendar Revisión"
    async function reagendarRevision(idRevision, servicioId) {
        const rev = cacheRevisiones.find(r => r.id_revision === idRevision);
        if (!rev) {
            alert("No se encontró la revisión.");
            return;
        }

        let ag = cacheAgendamientos.find(a => a.id_agendamiento === rev.id_agendamiento);
        if (!ag) {
            alert("No se encontró el agendamiento asociado.");
            return;
        }

        // Si no vino el servicioId en el onclick, lo intentamos obtener desde la API
        if (!servicioId) {
            try {
                const servRev = await $.get(`${API.SERV_REV}/ByRevision/${idRevision}`);
                servicioId = servRev?.servicio_id || null;
            } catch {
                servicioId = null;
            }
        }

        // 1) Vehículo
        $("#vehiculo_id").val(rev.vehiculo_id);

        // 2) Tipo de servicio y servicio
        if (servicioId && cacheServicios[servicioId]) {
            const servicio = cacheServicios[servicioId];
            const tipoId = servicio.tipo_servicio_id;

            // Setear tipo de servicio y disparar el cambio para cargar los servicios
            $("#tipo_servicio_id").val(tipoId);
            $("#tipo_servicio_id").trigger("change");

            // Como el cambio rellena #servicio_id en base a cacheServicios, podemos
            // setear el valor inmediatamente después
            setTimeout(() => {
                $("#servicio_id").val(servicioId);
            }, 0);
        } else {
            // Si no conocemos el servicio, limpiamos selects dependientes
            $("#tipo_servicio_id").val("");
            $("#servicio_id").html(`<option value="">Seleccione</option>`);
        }

        // 3) Fecha y hora
        if (ag.fecha_estimada) {
            $("#fecha").val(ag.fecha_estimada);
            cargarHorasDisponibles(ag.fecha_estimada);

            const horaStr = ag.hora_llegada ? ag.hora_llegada.substring(0, 5) : "";

            if (horaStr) {
                // Si la hora actual no está en la lista (por restricciones), la agregamos
                if ($("#hora option[value='" + horaStr + "']").length === 0) {
                    $("#hora").append(`<option value="${horaStr}">${horaStr}</option>`);
                }
                $("#hora").val(horaStr);
            }
        }

        // 4) Limpiar pertenencias (para que el usuario las marque nuevamente si quiere)
        $("#pertenencias input[type='checkbox']").prop("checked", false);

        // 5) Llevar al usuario al formulario
        window.scrollTo({ top: 0, behavior: "smooth" });
    }
</script>
