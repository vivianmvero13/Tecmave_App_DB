@page
@model Front.Pages.Mantenimientos.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Administrar Agendamientos";
}

<h1>Administrar Agendamientos</h1>

<div class="row g-3 align-items-end mt-3">
    <div class="col-12 col-md-4">
        <label for="estadoFilter" class="form-label">Filtrar por estado</label>
        <select id="estadoFilter" class="form-select">
            <option value="">(Todos)</option>
        </select>
    </div>
    <div class="col-12 col-md-8">
        <label for="searchAg" class="form-label">Buscar</label>
        <div class="input-group">
            <input id="searchAg" class="form-control" placeholder="Buscar por cliente, placa, estado…" />
            <button id="clearSearchAg" class="btn btn-outline-secondary" type="button">Limpiar</button>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mt-3">
    <small id="agResultsBadge" class="text-muted">Mostrando 0 de 0</small>
    <div class="d-flex gap-2">
        <button id="exportAgBtn" class="btn btn-orange btn-sm" type="button">
            <i class="fa-solid fa-file-excel"></i> Exportar
        </button>
    </div>
</div>

<div class="table-responsive mt-2">
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Cliente</th>
                <th>Vehículo</th>
                <th>Estado</th>
                <th>Fecha de Entrega</th>
                <th>Costo</th>
                <th style="width:180px;">Acciones</th>
            </tr>
        </thead>
        <tbody id="agTable">
            <tr><td colspan="8">Cargando agendamientos…</td></tr>
        </tbody>
    </table>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #9FAA13 !important;
        }

    .badge-estado {
        font-size: .75rem;
        padding: .25rem .5rem;
        border-radius: .5rem;
    }
</style>

<script>
    const API_BASE  = 'https://tecmave-api.azurewebsites.net';
    const AG_URL    = `${API_BASE}/Agendamiento`;
    const VEH_URL   = `${API_BASE}/Vehiculos`;
    const USERS_URL = `${API_BASE}/api/usuarios`;
    const EST_URL   = `${API_BASE}/Estados`;

    let allAgendamientos = [];
    let vehById   = {};
    let userById  = {};
    let estados   = [];
    let estadosById = {};

    const U = s => (s ?? '').toString().trim().toUpperCase();
    const esc = s => String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');

    function debounce(fn, d=250){
        let t;
        return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); };
    }

    function formatFecha(f){
        if(!f) return '-';
        return f.toString().substring(0,10);
    }

    function formatHora(h){
        if(!h) return '-';
        return h.toString().substring(0,5);
    }

    function buildClienteName(u){
        if(!u) return '(Sin usuario)';
        const n = (u.nombre ?? u.Nombre ?? '').trim();
        const a = (u.apellidos ?? u.Apellidos ?? '').trim();
        const full = [n,a].filter(Boolean).join(' ').trim();
        return full || (u.userName ?? u.UserName ?? 'Usuario');
    }

    function loadEstadosFilter(){
        const $sel = $('#estadoFilter').empty();
        $sel.append(`<option value="">(Todos)</option>`);
        estados
            .slice()
            .sort((a,b) => (a.nombre ?? a.Nombre ?? '').localeCompare(b.nombre ?? b.Nombre ?? ''))
            .forEach(e => {
                const nombre = e.nombre ?? e.Nombre ?? '';
                $sel.append(`<option value="${e.id_estado}">${esc(nombre)}</option>`);
            });
    }

    function applyAgFilters(){
        const estadoSel = $('#estadoFilter').val();
        const q = ($('#searchAg').val() || '').toLowerCase();

        return allAgendamientos.filter(a => {
            if(estadoSel && String(a.id_estado) !== String(estadoSel)) return false;
            if(!q) return true;

            const u = userById[a.cliente_id];
            const v = vehById[a.vehiculo_id];
            const e = estadosById[a.id_estado];

            const nombreCliente = buildClienteName(u);
            const placa  = v?.placa ?? v?.Placa ?? '';
            const modelo = v?.modelo ?? v?.Modelo ?? '';
            const estadoNombre = e?.nombre ?? e?.Nombre ?? '';

            const fechaEntregaRaw = a.fecha_estimada_entrega ?? a.fecha_estimada;
            const costoRaw = a.costo_mantenimiento ?? a.costo;

            const haystack = [
                nombreCliente,
                placa,
                modelo,
                estadoNombre,
                formatFecha(a.fecha_estimada),
                formatFecha(fechaEntregaRaw),
                (costoRaw ?? '').toString()
            ].join(' ').toLowerCase();

            return haystack.includes(q);
        });
    }

    function buildEstadoSelect(agId, currentEstadoId){
        let html = `<select class="form-select form-select-sm estado-select" data-id="${agId}">`;
        estados.forEach(e => {
            const idEst = e.id_estado;
            const nombre = e.nombre ?? e.Nombre ?? '';
            const sel = String(idEst) === String(currentEstadoId) ? 'selected' : '';
            html += `<option value="${idEst}" ${sel}>${esc(nombre)}</option>`;
        });
        html += `</select>`;
        return html;
    }

    function getEstadoCode(ag){
        const e = estadosById[ag.id_estado];
        return e?.id_estado ?? ag.id_estado;
    }

    // HTML para fecha de entrega (con mensajes estéticos)
    function formatFechaEntregaHtml(ag){
        const raw = ag.fecha_estimada_entrega ?? ag.fecha_estimada_entrega_raw ?? ag.fecha_estimada;
        const code = getEstadoCode(ag);

        if(!raw){
            const needsUpdate = (code === 9 || code === 10); // Finalizado / Entregado
            const text = needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos';
            const cls  = needsUpdate ? 'badge bg-warning text-dark' : 'badge bg-secondary';
            return `<span class="${cls}">${esc(text)}</span>`;
        }

        return esc(formatFecha(raw));
    }

    // HTML para costo (con mensajes estéticos)
    function formatCostoHtml(ag){
        const raw = ag.costo_mantenimiento ?? ag.costo;
        const code = getEstadoCode(ag);

        if(raw == null || raw === ''){
            const needsUpdate = (code === 9 || code === 10);
            const text = needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos';
            const cls  = needsUpdate ? 'badge bg-warning text-dark' : 'badge bg-secondary';
            return `<span class="${cls}">${esc(text)}</span>`;
        }

        const num = Number(raw);
        if (isNaN(num)){
            return esc(String(raw));
        }

        // Formato moneda CR
        const formatted = num.toLocaleString('es-CR', {
            style: 'currency',
            currency: 'CRC'
        });

        return esc(formatted);
    }

    async function updateAgEstado(agId, newEstadoId, selectEl){
        const ag = allAgendamientos.find(x => Number(x.id_agendamiento) === Number(agId));
        if(!ag){
            alert('No se encontró el agendamiento.');
            return;
        }

        const oldVal = ag.id_estado;
        ag.id_estado = newEstadoId; // optimista

        const $sel = $(selectEl);
        $sel.prop('disabled', true);

        const payload = {
            id_agendamiento:          ag.id_agendamiento,
            cliente_id:               ag.cliente_id,
            vehiculo_id:              ag.vehiculo_id,
            fecha_agregada:           ag.fecha_agregada,
            fecha_estimada:           ag.fecha_estimada,
            hora_llegada:             ag.hora_llegada,
            id_estado:                newEstadoId,
            // nuevos campos (si existen en el backend los tomará, si no, se ignoran)
            fecha_estimada_entrega:   ag.fecha_estimada_entrega ?? null,
            costo_mantenimiento:      ag.costo_mantenimiento ?? null
        };

        try{
            await $.ajax({
                url: AG_URL,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload)
            });
        }catch(err){
            console.error(err);
            ag.id_estado = oldVal;
            $sel.val(oldVal);
            alert('No se pudo actualizar el estado.');
        }finally{
            $sel.prop('disabled', false);
        }
    }

    window.restoreAgEstado = function(agId){
        const ag = allAgendamientos.find(x => Number(x.id_agendamiento) === Number(agId));
        if(!ag) return;
        const $row = $(`tr[data-id="${agId}"]`);
        const $sel = $row.find('.estado-select');
        $sel.val(ag.id_estado);
    };

    function renderAgTable(rows){
        const $tb = $('#agTable').empty();

        if(!rows.length){
            $tb.html(`<tr><td colspan="8" class="text-muted">No hay agendamientos.</td></tr>`);
            $('#agResultsBadge').text(`Mostrando 0 de ${allAgendamientos.length}`);
            return;
        }

        rows.forEach(a => {
            const u = userById[a.cliente_id];
            const v = vehById[a.vehiculo_id];
            const e = estadosById[a.id_estado];

            const cliente = buildClienteName(u);
            const placa   = v?.placa ?? v?.Placa ?? '';
            const modelo  = v?.modelo ?? v?.Modelo ?? '';
            const estadoNombre = e?.nombre ?? e?.Nombre ?? '(Desconocido)';
            const selectHtml   = buildEstadoSelect(a.id_agendamiento, a.id_estado);

            const fechaBase = formatFecha(a.fecha_estimada || a.fecha_agregada);
            const fechaEntregaHtml = formatFechaEntregaHtml(a);
            const costoHtml        = formatCostoHtml(a);

            $tb.append(`
                <tr data-id="${a.id_agendamiento}">
                    <td>${esc(fechaBase)}</td>
                    <td>${esc(formatHora(a.hora_llegada))}</td>
                    <td>${esc(cliente)}</td>
                    <td>${esc(placa)}${modelo ? ' - ' + esc(modelo) : ''}</td>
                    <td>${selectHtml}</td>
                    <td>${fechaEntregaHtml}</td>
                    <td>${costoHtml}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <a class="btn btn-primary"
                               href="/Mantenimientos/Editar/${a.id_agendamiento}">
                                Editar
                            </a>
                        </div>
                    </td>
                </tr>
            `);
        });

        $('#agResultsBadge').text(`Mostrando ${rows.length} de ${allAgendamientos.length}`);

        $('.estado-select').off('change').on('change', function(){
            const agId = Number($(this).data('id'));
            const newEstado = Number($(this).val());
            updateAgEstado(agId, newEstado, this);
        });
    }

    // ---------- EXPORTAR A CSV ----------
    function csvEscape(val){
        const s = (val ?? '').toString();
        if (/[",\n\r;]/.test(s)) {
            return `"${s.replace(/"/g, '""')}"`;
        }
        return s;
    }

    function buildAgCsv(rows){
        const headers = ['Fecha','Hora','Cliente','Vehículo','Estado','FechaEntrega','Costo'];
        const lines = [headers.join(',')];

        rows.forEach(a => {
            const u = userById[a.cliente_id];
            const v = vehById[a.vehiculo_id];
            const e = estadosById[a.id_estado];

            const cliente = buildClienteName(u);
            const placa   = v?.placa ?? v?.Placa ?? '';
            const modelo  = v?.modelo ?? v?.Modelo ?? '';
            const vehText = modelo ? `${placa} - ${modelo}` : placa;
            const estadoNombre = e?.nombre ?? e?.Nombre ?? '';

            const fechaBase = formatFecha(a.fecha_estimada || a.fecha_agregada);
            const fechaEntregaRaw = a.fecha_estimada_entrega ?? a.fecha_estimada_entrega_raw ?? a.fecha_estimada;
            const costoRaw = a.costo_mantenimiento ?? a.costo;

            const code = getEstadoCode(a);
            const needsUpdate = (code === 9 || code === 10);

            const fechaEntregaText = fechaEntregaRaw
                ? formatFecha(fechaEntregaRaw)
                : (needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos');

            const costoText = (costoRaw == null || costoRaw === '')
                ? (needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos')
                : String(costoRaw);

            lines.push([
                csvEscape(fechaBase),
                csvEscape(formatHora(a.hora_llegada)),
                csvEscape(cliente),
                csvEscape(vehText),
                csvEscape(estadoNombre),
                csvEscape(fechaEntregaText),
                csvEscape(costoText)
            ].join(','));
        });

        return '\uFEFF' + lines.join('\r\n');
    }

    window.exportAgToExcel = function(){
        const rows = applyAgFilters();
        if (!rows.length){
            alert('No hay datos para exportar.');
            return;
        }
        const csv = buildAgCsv(rows);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

        const now = new Date();
        const pad = n => n.toString().padStart(2,'0');
        const fname = `agendamientos_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.csv`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    };

    async function loadAllData(){
        try{
            const [agList, vehList, userList, estList] = await Promise.all([
                $.getJSON(AG_URL),
                $.getJSON(VEH_URL),
                $.getJSON(USERS_URL),
                $.getJSON(EST_URL)
            ]);

            allAgendamientos = Array.isArray(agList) ? agList.slice() : [];
            allAgendamientos.sort((a,b) => {
                const fa = (a.fecha_estimada || a.fecha_agregada || '').toString();
                const fb = (b.fecha_estimada || b.fecha_agregada || '').toString();
                if (fa < fb) return -1;
                if (fa > fb) return 1;
                const ha = (a.hora_llegada || '').toString();
                const hb = (b.hora_llegada || '').toString();
                return ha.localeCompare(hb);
            });

            vehById = {};
            (vehList || []).forEach(v => {
                const id = v.id_vehiculo ?? v.id ?? v.Id;
                if(id != null) vehById[id] = v;
            });

            userById = {};
            (userList || []).forEach(u => {
                const id = u.id ?? u.Id;
                if(id != null) userById[id] = u;
            });

            estados = Array.isArray(estList) ? estList.slice() : [];
            estadosById = {};
            estados.forEach(e => {
                estadosById[e.id_estado] = e;
            });

            loadEstadosFilter();
            renderAgTable(applyAgFilters());
        }catch(e){
            console.error(e);
            $('#agTable').html(`<tr><td colspan="8" class="text-danger">Error cargando datos.</td></tr>`);
        }
    }

    $(function(){
        loadAllData();

        $('#estadoFilter').on('change', () => renderAgTable(applyAgFilters()));
        $('#searchAg').on('input', debounce(()=>renderAgTable(applyAgFilters()), 200));
        $('#searchAg').on('keydown', e => {
            if(e.key === 'Enter'){
                e.preventDefault();
                e.currentTarget.blur();
            }
        });
        $('#clearSearchAg').on('click', () => {
            $('#searchAg').val('');
            renderAgTable(applyAgFilters());
            $('#searchAg').focus();
        });

        $('#exportAgBtn').on('click', () => window.exportAgToExcel());
    });
</script>
