@page
@model Front.Pages.Mantenimientos.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Administrar Agendamientos";
}

<h1>Administrar Agendamientos</h1>

<!-- Filtros -->
<div class="row g-3 align-items-end mt-3">
    <div class="col-12 col-md-4">
        <label for="estadoFilter" class="form-label">Filtrar por estado</label>
        <select id="estadoFilter" class="form-select">
            <option value="">(Todos)</option>
        </select>
    </div>

    <div class="col-12 col-md-8">
        <label for="searchAg" class="form-label">Buscar</label>
        <div class="input-group">
            <input id="searchAg"
                   class="form-control"
                   placeholder="Buscar por cliente, placa, estado…" />
            <button id="clearSearchAg"
                    class="btn btn-outline-secondary"
                    type="button">
                Limpiar
            </button>
        </div>
    </div>
</div>

<!-- Barra superior -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <small id="agResultsBadge" class="text-muted">
        Mostrando 0 de 0
    </small>

    <div class="d-flex gap-2">
        <button id="exportAgBtn"
                class="btn btn-orange btn-sm"
                type="button">
            <i class="fa-solid fa-file-excel"></i> Exportar
        </button>
    </div>
</div>

<!-- Tabla -->
<div class="table-responsive mt-2">
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Cliente</th>
                <th>Vehículo</th>
                <th>Estado</th>
                <th>Fecha Entrega</th>
                <th>Costo</th>
                <th style="width:180px;">Acciones</th>
            </tr>
        </thead>
        <tbody id="agTable">
            <tr>
                <td colspan="8">Cargando agendamientos…</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Paginación (MISMO PATRÓN QUE VEHÍCULOS) -->
<div class="d-flex justify-content-between align-items-center mt-2">
    <div class="d-flex align-items-center gap-2">
        <label for="pageSizeAg" class="form-label mb-0">Mostrar:</label>
        <select id="pageSizeAg"
                class="form-select form-select-sm"
                style="width:auto;">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
        </select>
    </div>

    <nav class="ag-pagination-nav" aria-label="Paginación agendamientos">
        <ul class="pagination pagination-sm mb-0 d-flex align-items-center gap-2"
            style="list-style:none; margin:0; padding:0;">
            <li class="page-item" id="prevAg" style="list-style:none;">
                <button class="page-link" type="button" aria-label="Anterior">&laquo;</button>
            </li>
            <li class="page-item disabled" style="list-style:none;">
                <span class="page-link" id="agPageInfo">1 / 1</span>
            </li>
            <li class="page-item" id="nextAg" style="list-style:none;">
                <button class="page-link" type="button" aria-label="Siguiente">&raquo;</button>
            </li>
        </ul>
    </nav>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #9FAA13 !important;
        }

    .badge-estado {
        font-size: .75rem;
        padding: .25rem .5rem;
        border-radius: .5rem;
    }

    /* Paginación estilo Vehículos (flechas centradas) */
    .ag-pagination-nav .pagination {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: .5rem !important;
    }

    .ag-pagination-nav .page-item {
        list-style: none !important;
        display: flex;
        align-items: center;
    }

    /* Flechas: mismo “cuadro” y centrado perfecto */
    .ag-pagination-nav button.page-link {
        width: 34px;
        height: 34px;
        padding: 0 !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 8px;
        line-height: 1;
        cursor: pointer;
    }

    /* El label “1 / 1” */
    .ag-pagination-nav span.page-link {
        height: 34px;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 0 .75rem !important;
        border-radius: 8px;
    }

    .ag-actions {
        display: flex;
        gap: .5rem;
        flex-wrap: nowrap;
        align-items: stretch; /* misma altura */
    }

    .ag-action-btn {
        display: inline-flex; /* centra texto vertical/horizontal */
        align-items: center;
        justify-content: center;
        min-height: 34px; /* igual a tus flechas/paginación */
        padding: .25rem .6rem; /* consistente */
        white-space: nowrap;
    }

    /* opcional: que ambos ocupen el mismo ancho */
    .ag-action-btn {
        flex: 1 1 auto;
    }

</style>

<script>
    const API_BASE  = 'https://tecmave-api.azurewebsites.net';
    const AG_URL    = `${API_BASE}/Agendamiento`;
    const VEH_URL   = `${API_BASE}/Vehiculos`;
    const USERS_URL = `${API_BASE}/api/usuarios`;
    const EST_URL   = `${API_BASE}/Estados`;
    const FACT_URL  = `${API_BASE}/facturas`;

    let allAgendamientos = [];
    let vehById   = {};
    let userById  = {};
    let estados   = [];
    let estadosById = {};

    const U = s => (s ?? '').toString().trim().toUpperCase();
    const esc = s => String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');

    // ===== Paginación (Mantenimientos) =====
    const PAGE_SIZES_AG = [5, 10, 20, 50];
    let pageSizeAg = 5;
    let currentPageAg = 1;

    function refreshAgTablePaged() {
        const rows = applyAgFilters();
        const total = rows.length;

        if (!total) {
            renderAgTable([]);
            $('#agResultsBadge').text(`Mostrando 0 de 0`);
            $('#agPageInfo').text('0 / 0');
            $('#prevAg').addClass('disabled');
            $('#nextAg').addClass('disabled');
            return;
        }

        const totalPages = Math.max(1, Math.ceil(total / pageSizeAg));
        if (currentPageAg > totalPages) currentPageAg = totalPages;
        if (currentPageAg < 1) currentPageAg = 1;

        const start = (currentPageAg - 1) * pageSizeAg;
        const end = Math.min(start + pageSizeAg, total);
        const pageRows = rows.slice(start, end);

        renderAgTable(pageRows);

        $('#agResultsBadge').text(`Mostrando ${start + 1}-${end} de ${total}`);
        $('#agPageInfo').text(`${currentPageAg} / ${totalPages}`);

        if (currentPageAg <= 1) $('#prevAg').addClass('disabled');
        else $('#prevAg').removeClass('disabled');

        if (currentPageAg >= totalPages) $('#nextAg').addClass('disabled');
        else $('#nextAg').removeClass('disabled');
    }

    function debounce(fn, d=250){
        let t;
        return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); };
    }

    function formatFecha(f){
        if(!f) return '-';
        return f.toString().substring(0,10);
    }

    function formatHora(h){
        if(!h) return '-';
        return h.toString().substring(0,5);
    }

    function buildClienteName(u){
        if(!u) return '(Sin usuario)';
        const n = (u.nombre ?? u.Nombre ?? '').trim();
        const a = (u.apellidos ?? u.Apellidos ?? '').trim();
        const full = [n,a].filter(Boolean).join(' ').trim();
        return full || (u.userName ?? u.UserName ?? 'Usuario');
    }

    function loadEstadosFilter(){
        const $sel = $('#estadoFilter').empty();
        $sel.append(`<option value="">(Todos)</option>`);
        estados
            .slice()
            .sort((a,b) => (a.nombre ?? a.Nombre ?? '').localeCompare(b.nombre ?? b.Nombre ?? ''))
            .forEach(e => {
                const nombre = e.nombre ?? e.Nombre ?? '';
                $sel.append(`<option value="${e.id_estado}">${esc(nombre)}</option>`);
            });
    }

    function applyAgFilters(){
        const estadoSel = $('#estadoFilter').val();
        const q = ($('#searchAg').val() || '').toLowerCase();

        return allAgendamientos.filter(a => {
            if(estadoSel && String(a.id_estado) !== String(estadoSel)) return false;
            if(!q) return true;

            const u = userById[a.cliente_id];
            const v = vehById[a.vehiculo_id];
            const e = estadosById[a.id_estado];

            const nombreCliente = buildClienteName(u);
            const placa  = v?.placa ?? v?.Placa ?? '';
            const modelo = v?.modelo ?? v?.Modelo ?? '';
            const estadoNombre = e?.nombre ?? e?.Nombre ?? '';

            const fechaEntregaRaw = a.fecha_estimada_entrega ?? a.fecha_estimada;
            const costoRaw = a.costo_mantenimiento ?? a.costo;

            const haystack = [
                nombreCliente,
                placa,
                modelo,
                estadoNombre,
                formatFecha(a.fecha_estimada),
                formatFecha(fechaEntregaRaw),
                (costoRaw ?? '').toString()
            ].join(' ').toLowerCase();

            return haystack.includes(q);
        });
    }

    function buildEstadoSelect(agId, currentEstadoId){
        let html = `<select class="form-select form-select-sm estado-select" data-id="${agId}">`;
        estados.forEach(e => {
            const idEst = e.id_estado;
            const nombre = e.nombre ?? e.Nombre ?? '';
            const sel = String(idEst) === String(currentEstadoId) ? 'selected' : '';
            html += `<option value="${idEst}" ${sel}>${esc(nombre)}</option>`;
        });
        html += `</select>`;
        return html;
    }

    function getEstadoCode(ag){
        const e = estadosById[ag.id_estado];
        return e?.id_estado ?? ag.id_estado;
    }

    function formatFechaEntregaHtml(ag){
        const raw = ag.fecha_estimada_entrega ?? ag.fecha_estimada_entrega_raw ?? ag.fecha_estimada;
        const code = getEstadoCode(ag);

        if(!raw){
            const needsUpdate = (code === 9 || code === 10);
            const text = needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos';
            const cls  = needsUpdate ? 'badge bg-warning text-dark' : 'badge bg-secondary';
            return `<span class="${cls}">${esc(text)}</span>`;
        }

        return esc(formatFecha(raw));
    }

    function formatCostoHtml(ag){
        const raw = ag.costo_mantenimiento ?? ag.costo;
        const code = getEstadoCode(ag);

        if(raw == null || raw === ''){
            const needsUpdate = (code === 9 || code === 10);
            const text = needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos';
            const cls  = needsUpdate ? 'badge bg-warning text-dark' : 'badge bg-secondary';
            return `<span class="${cls}">${esc(text)}</span>`;
        }

        const num = Number(raw);
        if (isNaN(num)){
            return esc(String(raw));
        }

        const formatted = num.toLocaleString('es-CR', {
            style: 'currency',
            currency: 'CRC'
        });

        return esc(formatted);
    }

    async function updateAgEstado(agId, newEstadoId, selectEl){
        const ag = allAgendamientos.find(x => Number(x.id_agendamiento) === Number(agId));
        if(!ag){
            alert('No se encontró el agendamiento.');
            return;
        }

        const oldVal = ag.id_estado;
        ag.id_estado = newEstadoId;

        const $sel = $(selectEl);
        $sel.prop('disabled', true);

        const payload = {
            id_agendamiento:          ag.id_agendamiento,
            cliente_id:               ag.cliente_id,
            vehiculo_id:              ag.vehiculo_id,
            fecha_agregada:           ag.fecha_agregada,
            fecha_estimada:           ag.fecha_estimada,
            hora_llegada:             ag.hora_llegada,
            id_estado:                newEstadoId,
            fecha_estimada_entrega:   ag.fecha_estimada_entrega ?? null,
            costo_mantenimiento:      ag.costo_mantenimiento ?? null
        };

        try{
            await $.ajax({
                url: AG_URL,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload)
            });
        }catch(err){
            console.error(err);
            ag.id_estado = oldVal;
            $sel.val(oldVal);
            alert('No se pudo actualizar el estado.');
        }finally{
            $sel.prop('disabled', false);
        }
    }

    async function generarFacturaDesdeAg(agId){
        const ag = allAgendamientos.find(x => Number(x.id_agendamiento) === Number(agId));
        if(!ag){
            alert('No se encontró el agendamiento.');
            return;
        }

        const clienteId = Number(ag.cliente_id);
        const costoRaw  = ag.costo_mantenimiento ?? ag.costo;

        if(!clienteId){
            alert('Este agendamiento no tiene cliente_id.');
            return;
        }

        const total = Number(costoRaw);
        if(!costoRaw || isNaN(total) || total <= 0){
            alert('No se puede generar la factura: el costo está vacío o es 0.\nPrimero actualizá el costo del mantenimiento.');
            return;
        }

        const fechaBase = ag.fecha_estimada || ag.fecha_agregada || new Date().toISOString();

        const body = {
            cliente_id: clienteId,
            fecha_emision: new Date(fechaBase).toISOString(),
            total: total,
            metodo_pago: "Sin definir",
            estado_pago: "Pendiente"
        };

        try{
            const created = await $.ajax({
                url: FACT_URL,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(body)
            });

            alert(`Factura generada\nID: ${created?.id_factura ?? created?.id ?? '(sin id)'}`);

        }catch(err){
            console.error(err);
            alert("No se pudo generar la factura desde este agendamiento.");
        }
    }

    window.restoreAgEstado = function(agId){
        const ag = allAgendamientos.find(x => Number(x.id_agendamiento) === Number(agId));
        if(!ag) return;
        const $row = $(`tr[data-id="${agId}"]`);
        const $sel = $row.find('.estado-select');
        $sel.val(ag.id_estado);
    };

    function renderAgTable(rows){
        const $tb = $('#agTable').empty();

        if(!rows.length){
            $tb.html(`<tr><td colspan="8" class="text-muted">No hay agendamientos.</td></tr>`);
            // OJO: acá no tocamos el badge, porque el badge lo controla refreshAgTablePaged()
            return;
        }

        rows.forEach(a => {
            const u = userById[a.cliente_id];
            const v = vehById[a.vehiculo_id];
            const e = estadosById[a.id_estado];

            const cliente = buildClienteName(u);
            const placa   = v?.placa ?? v?.Placa ?? '';
            const modelo  = v?.modelo ?? v?.Modelo ?? '';
            const estadoNombre = e?.nombre ?? e?.Nombre ?? '(Desconocido)';
            const selectHtml   = buildEstadoSelect(a.id_agendamiento, a.id_estado);

            const fechaBase = formatFecha(a.fecha_estimada || a.fecha_agregada);
            const fechaEntregaHtml = formatFechaEntregaHtml(a);
            const costoHtml        = formatCostoHtml(a);

            $tb.append(`
                <tr data-id="${a.id_agendamiento}">
                    <td>${esc(fechaBase)}</td>
                    <td>${esc(formatHora(a.hora_llegada))}</td>
                    <td>${esc(cliente)}</td>
                    <td>${esc(placa)}${modelo ? ' - ' + esc(modelo) : ''}</td>
                    <td>${selectHtml}</td>
                    <td>${fechaEntregaHtml}</td>
                    <td>${costoHtml}</td>
                    <td>
                            <div class="ag-actions">
      <a class="btn btn-primary btn-sm ag-action-btn"
         href="/Mantenimientos/Editar/${a.id_agendamiento}">
        Editar
      </a>

      <button class="btn btn-success btn-sm ag-action-btn btn-gen-factura"
              type="button"
              data-id="${a.id_agendamiento}">
        Generar factura
      </button>
    </div>

                    </td>
                </tr>
            `);
        });

        $('.estado-select').off('change').on('change', function(){
            const agId = Number($(this).data('id'));
            const newEstado = Number($(this).val());
            updateAgEstado(agId, newEstado, this);
        });
    }

    function csvEscape(val){
        const s = (val ?? '').toString();
        if (/[",\n\r;]/.test(s)) {
            return `"${s.replace(/"/g, '""')}"`;
        }
        return s;
    }

    function buildAgCsv(rows){
        const headers = ['Fecha','Hora','Cliente','Vehículo','Estado','FechaEntrega','Costo'];
        const lines = [headers.join(',')];

        rows.forEach(a => {
            const u = userById[a.cliente_id];
            const v = vehById[a.vehiculo_id];
            const e = estadosById[a.id_estado];

            const cliente = buildClienteName(u);
            const placa   = v?.placa ?? v?.Placa ?? '';
            const modelo  = v?.modelo ?? v?.Modelo ?? '';
            const vehText = modelo ? `${placa} - ${modelo}` : placa;
            const estadoNombre = e?.nombre ?? e?.Nombre ?? '';

            const fechaBase = formatFecha(a.fecha_estimada || a.fecha_agregada);
            const fechaEntregaRaw = a.fecha_estimada_entrega ?? a.fecha_estimada_entrega_raw ?? a.fecha_estimada;
            const costoRaw = a.costo_mantenimiento ?? a.costo;

            const code = getEstadoCode(a);
            const needsUpdate = (code === 9 || code === 10);

            const fechaEntregaText = fechaEntregaRaw
                ? formatFecha(fechaEntregaRaw)
                : (needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos');

            const costoText = (costoRaw == null || costoRaw === '')
                ? (needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos')
                : String(costoRaw);

            lines.push([
                csvEscape(fechaBase),
                csvEscape(formatHora(a.hora_llegada)),
                csvEscape(cliente),
                csvEscape(vehText),
                csvEscape(estadoNombre),
                csvEscape(fechaEntregaText),
                csvEscape(costoText)
            ].join(','));
        });

        return '\uFEFF' + lines.join('\r\n');
    }

        // ===== Exportar Agendamientos a Excel (.xlsx) =====
    window.exportAgToExcel = function () {
        const rows = applyAgFilters();
        if (!rows.length) {
            alert('No hay datos para exportar.');
            return;
        }

        // 1️⃣ Datos limpios y estéticos
        const data = rows.map(a => {
            const u = userById[a.cliente_id];
            const v = vehById[a.vehiculo_id];
            const e = estadosById[a.id_estado];

            const cliente = buildClienteName(u);
            const placa   = v?.placa ?? v?.Placa ?? '';
            const modelo  = v?.modelo ?? v?.Modelo ?? '';
            const vehiculo = modelo ? `${placa} - ${modelo}` : placa;

            const estadoNombre = e?.nombre ?? e?.Nombre ?? '';

            const fechaBase = formatFecha(a.fecha_estimada || a.fecha_agregada);
            const fechaEntregaRaw = a.fecha_estimada_entrega ?? a.fecha_estimada;
            const costoRaw = a.costo_mantenimiento ?? a.costo;

            const code = getEstadoCode(a);
            const needsUpdate = (code === 9 || code === 10);

            const fechaEntrega = fechaEntregaRaw
                ? formatFecha(fechaEntregaRaw)
                : (needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos');

            const costo = (costoRaw == null || costoRaw === '')
                ? (needsUpdate ? 'Se debe actualizar' : 'Aún no hay datos')
                : Number(costoRaw);

            return {
                "Fecha": fechaBase,
                "Hora": formatHora(a.hora_llegada),
                "Cliente": cliente,
                "Vehículo": vehiculo,
                "Estado": estadoNombre,
                "Fecha entrega": fechaEntrega,
                "Costo": (typeof costo === 'number')
                    ? costo.toLocaleString('es-CR', { style: 'currency', currency: 'CRC' })
                    : costo
            };
        });

        // Crear hoja
        const ws = XLSX.utils.json_to_sheet(data);

        const header = ws['!rows'] || [];
    header[0] = { hpt: 30 }; // Ajustar el alto de la fila del encabezado

    // Aplica estilo al encabezado (fila 1)
    ws['A1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };  // Columna A (Fecha)
    ws['B1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };  // Columna B (Hora)
    ws['C1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };  // Columna C (Cliente)
    ws['D1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };  // Columna D (Vehículo)
    ws['E1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };  // Columna E (Estado)
    ws['F1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };  // Columna F (Fecha entrega)
    ws['G1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };  // Columna G (Costo)

    // 4️⃣ Anchos de columna
    ws['!cols'] = [
        { wch: 12 }, // Fecha
        { wch: 8  }, // Hora
        { wch: 28 }, // Cliente
        { wch: 28 }, // Vehículo
        { wch: 18 }, // Estado
        { wch: 18 }, // Fecha entrega
        { wch: 16 }  // Costo
    ];

        // Autofiltro
        const range = XLSX.utils.decode_range(ws['!ref']);
        ws['!autofilter'] = { ref: XLSX.utils.encode_range(range) };

        // Libro + descarga
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Agendamientos');

        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const fname =
            `agendamientos_${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_` +
            `${pad(now.getHours())}${pad(now.getMinutes())}.xlsx`;

        XLSX.writeFile(wb, fname);
    };

    async function loadAllData(){
        try{
            const [agList, vehList, userList, estList] = await Promise.all([
                $.getJSON(AG_URL),
                $.getJSON(VEH_URL),
                $.getJSON(USERS_URL),
                $.getJSON(EST_URL)
            ]);

            allAgendamientos = Array.isArray(agList) ? agList.slice() : [];
            allAgendamientos.sort((a,b) => {
                const fa = (a.fecha_estimada || a.fecha_agregada || '').toString();
                const fb = (b.fecha_estimada || b.fecha_agregada || '').toString();
                if (fa < fb) return -1;
                if (fa > fb) return 1;
                const ha = (a.hora_llegada || '').toString();
                const hb = (b.hora_llegada || '').toString();
                return ha.localeCompare(hb);
            });

            vehById = {};
            (vehList || []).forEach(v => {
                const id = v.id_vehiculo ?? v.id ?? v.Id;
                if(id != null) vehById[id] = v;
            });

            userById = {};
            (userList || []).forEach(u => {
                const id = u.id ?? u.Id;
                if(id != null) userById[id] = u;
            });

            estados = Array.isArray(estList) ? estList.slice() : [];
            estadosById = {};
            estados.forEach(e => {
                estadosById[e.id_estado] = e;
            });

            loadEstadosFilter();

            // CAMBIO: al cargar todo, arrancamos paginado
            currentPageAg = 1;
            refreshAgTablePaged();

        }catch(e){
            console.error(e);
            $('#agTable').html(`<tr><td colspan="8" class="text-danger">Error cargando datos.</td></tr>`);
            $('#agResultsBadge').text(`Mostrando 0 de 0`);
            $('#agPageInfo').text('0 / 0');
            $('#prevAg').addClass('disabled');
            $('#nextAg').addClass('disabled');
        }
    }

    $(document).on('click', '.btn-gen-factura', function () {
        const agId = Number($(this).data('id'));
        generarFacturaDesdeAg(agId);
    });

    $(function(){
        loadAllData();

        // CAMBIO: filtros usan paginado
        $('#estadoFilter').on('change', () => {
            currentPageAg = 1;
            refreshAgTablePaged();
        });

        $('#searchAg').on('input', debounce(() => {
            currentPageAg = 1;
            refreshAgTablePaged();
        }, 200));

        $('#searchAg').on('keydown', e => {
            if(e.key === 'Enter'){
                e.preventDefault();
                e.currentTarget.blur();
            }
        });

        $('#clearSearchAg').on('click', () => {
            $('#searchAg').val('');
            currentPageAg = 1;
            refreshAgTablePaged();
            $('#searchAg').focus();
        });

        $('#exportAgBtn').on('click', () => window.exportAgToExcel());

        // CAMBIO: select "Mostrar"
        $('#pageSizeAg').on('change', function () {
            const val = Number($(this).val());
            pageSizeAg = PAGE_SIZES_AG.includes(val) ? val : 5;
            currentPageAg = 1;
            refreshAgTablePaged();
        });

        // CAMBIO: flechas
        $('#prevAg button').on('click', function () {
            if ($('#prevAg').hasClass('disabled')) return;
            currentPageAg--;
            refreshAgTablePaged();
        });

        $('#nextAg button').on('click', function () {
            if ($('#nextAg').hasClass('disabled')) return;
            currentPageAg++;
            refreshAgTablePaged();
        });
    });
</script>
