@page
@model Front.Pages.Mantenimientos.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Mantenimientos";
}

<h1>Mantenimientos</h1>

<div class="row g-3 align-items-end mt-3">
    <div class="col col-md-8">
        <label for="localSearch" class="form-label">Buscar</label>
        <div class="input-group">
            <input id="localSearch" class="form-control" placeholder="Buscar tipos" />
            <button id="clearSearch" class="btn btn-outline-secondary" type="button">Limpiar</button>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mt-3">
    <small id="resultsBadge" class="text-muted">Actualmente hay 0 de 0</small>
    <div class="d-flex gap-2">
        <button id="exportBtn" class="btn btn-orange btn-sm" type="button">
            <i class="fa-solid fa-file-excel"></i> Exportar
        </button>
        <button id="registrarBtn" class="btn btn-orange btn-sm" type="button" onclick="location.href='/Mantenimientos/Crear'">
            <i class="fa-solid fa-plus"></i> Registrar
        </button>
        <button id="recordatoriosBtn" class="btn btn-orange btn-sm" type="button" onclick="enviarRecordatorios()">
            <i class="fa-solid fa-envelope"></i> Enviar Recordatorios
        </button>
    </div>
</div>

<div class="table-responsive mt-2">
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Vehículo</th>
                <th>Cliente</th>
                <th>Fecha de Mantenimiento</th>
                <th>Próximo Mantenimiento</th>
                <th>Recordatorio</th>
                <th style="width:150px;">Acciones disponibles</th>
            </tr>
        </thead>
        <tbody id="mantenimientosTabla">
            <tr><td colspan="6">Cargando los mantenimientos disponibles...</td></tr>
        </tbody>
    </table>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #8f9a11 !important;
        }
</style>

<script>
    const API_BASE = 'https://localhost:7096';
    const MANTENIMIENTOS_URL = `${API_BASE}/Mantenimientos`;
    const RECORDATORIOS_URL  = `${API_BASE}/Mantenimientos/enviar-recordatorios`;

    const $tableBody = document.getElementById('mantenimientosTable');
    const $search    = document.getElementById('localSearch');
    const $clear     = document.getElementById('clearSearch');
    const $badge     = document.getElementById('resultsBadge');
    const $export    = document.getElementById('exportBtn');

    let allRows = [];
    let filteredRows = [];

    function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"'`=\/]/g, c => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
        }[c]));
    }

    function renderRows(rows) {
        if (!rows.length) {
            $tableBody.innerHTML = `<tr><td colspan="6">Sin resultados</td></tr>`;
            $badge.textContent = `Mostrando 0 de ${allRows.length}`;
            return;
        }
        const html = rows.map(r => `
            <tr>
                <td>${escapeHtml(r.vehiculo ?? '—')}</td>
                <td>${escapeHtml(r.cliente ?? '—')}</td>
                <td>${escapeHtml(r.fechaMantenimiento ?? '—')}</td>
                <td>${escapeHtml(r.proximoMantenimiento ?? '—')}</td>
                <td>${r.recordatorio ? 'SI' : 'NO'}</td>

             <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a class="btn btn-outline-primary" href="/Mantenimientos/Detalle?id=${encodeURIComponent(r.id)}">Ver</a>
                        <a class="btn btn-outline-secondary" href="/Mantenimientos/Editar?id=${encodeURIComponent(r.id)}">Editar</a>
                    </div>
                </td>
            </tr>
        `).join('');
        $tableBody.innerHTML = html;
        $badge.textContent = `Mostrando ${rows.length} de ${allRows.length}`;
    }

    function applyFilter() {
        const q = $search.value.trim().toLowerCase();
        if (!q) {
            filteredRows = [...allRows];
            renderRows(filteredRows);
            return;
        }
        filteredRows = allRows.filter(r =>
            (r.vehiculo ?? '').toLowerCase().includes(q) ||
            (r.cliente ?? '').toLowerCase().includes(q) ||
            (r.fechaMantenimiento ?? '').toLowerCase().includes(q)
        );
        renderRows(filteredRows);
    }

    function exportCsv() {
        const rows = filteredRows.length ? filteredRows : allRows;
        if (!rows.length) return;
        const header = ['Vehículo','Cliente','Fecha Mantenimiento','Próximo','Recordatorio'];
        const csvRows = [header.join(',')].concat(
            rows.map(r => [r.vehiculo, r.cliente, r.fechaMantenimiento, r.proximoMantenimiento, r.recordatorio ? 'Sí' : 'No']
                .map(v => `"${String(v ?? '').replace(/"/g, '""')}"`)
                .join(','))
        );
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        a.href = url; a.download = `mantenimientos_${ts}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function loadMantenimientos() {
        try {
            const res = await fetch(MANTENIMIENTOS_URL, { credentials: 'include' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            allRows = (Array.isArray(data) ? data : data?.data ?? []).map(m => ({
                id: m.id_mantenimiento ?? m.id ?? 0,
                vehiculo: m.vehiculo?.placa ?? `#${m.id_vehiculo ?? '—'}`,
                cliente: m.vehiculo?.cliente?.nombre ?? m.clienteNombre ?? '—',
                fechaMantenimiento: m.fecha_mantenimiento ?? m.fecha ?? '—',
                proximoMantenimiento: m.proximo_mantenimiento ?? '—',
                recordatorio: m.recordatorio_enviado ?? false
            }));

            filteredRows = [...allRows];
            renderRows(filteredRows);
        } catch (err) {
            console.error(err);
            $tableBody.innerHTML = `<tr><td colspan="6">Se dio un error cargando datos.</td></tr>`;
        }
    }

    async function enviarRecordatorios() {
        if (!confirm("¿Desea enviar los recordatorios a los clientes con mantenimientos vencidos?")) return;
        const res = await fetch(RECORDATORIOS_URL, {
            method: 'POST',
            headers: { 'accept': '*/*' }
        });
        if (res.ok) {
            const data = await res.json();
            alert(data.mensaje || "Los recordatorios fueron enviados correctamente.");
        } else {
            alert("Error enviando los recordatorios.");
        }
    }

     $search.addEventListener('input', applyFilter);
     $clear.addEventListener('click', () => { $search.value = ''; applyFilter(); });
     $export.addEventListener('click', exportCsv);

     loadMantenimientos();
</script>