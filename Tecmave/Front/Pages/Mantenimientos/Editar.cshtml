@page "{id:int}"
@model Front.Pages.Mantenimientos.EditarModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Editar mantenimiento";
}

<h1 class="mb-4">Editar mantenimiento</h1>

<div class="card p-4">
    <a asp-page="/Mantenimientos/Index"
       class="btn-back btn-back-top"
       title="Volver"
       aria-label="Volver">
        <img src="/assets/img/back.png" alt="Volver" />
    </a>
    <form id="frmAg">
        <input type="hidden" id="id_ag" />
        <input type="hidden" id="cliente_id" />
        <input type="hidden" id="vehiculo_id" />
        <input type="hidden" id="id_estado" />

        <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px;">
            <div>
                <label class="form-label">Cliente</label>
                <input id="cliente_nombre" class="form-control" readonly />
            </div>
            <div>
                <label class="form-label">Vehículo</label>
                <input id="vehiculo_desc" class="form-control" readonly />
            </div>

            <div>
                <label class="form-label">Fecha de cita</label>
                <input id="fecha_agregada" class="form-control" readonly />
            </div>
            <div>
                <label class="form-label">Hora de llegada</label>
                <input id="hora_llegada" class="form-control" readonly />
            </div>

            <div>
                <label class="form-label">Estado del vehículo / agendamiento</label>
                <select id="estado_select" class="form-select"></select>
                <small class="text-muted">
                    Selecciona el estado actual del trabajo (ingresado, en mantenimiento, finalizado, etc.).
                </small>
            </div>

            <div>
                <label class="form-label">Costo del mantenimiento (₡)</label>
                <input id="costo_mantenimiento" type="number" min="0" step="0.01" class="form-control" />
                <small class="text-muted">
                    Monto estimado o final del trabajo realizado.
                </small>
            </div>

            <div style="grid-column:1/-1">
                <label class="form-label">Fecha estimada de entrega</label>
                <input id="fecha_estimada_entrega" type="date" class="form-control" />
                <small class="text-muted">
                    Fecha en la que se estima devolver el vehículo al cliente.
                </small>
            </div>
        </div>

        <div class="mt-4 ag-actions">
            <button id="btnSave" type="submit" class="btn btn-primary">Guardar</button>
        </div>

    </form>
</div>

<style>
    <style >
    .ag-actions {
        display: flex;
        gap: .5rem;
        align-items: stretch; /* fuerza misma altura */
    }

    .ag-actions .btn {
        min-height: 44px; /* ajustá a gusto (40/44/48) */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: .5rem 1rem;
    }

    .card {
        position: relative;
    }

    /* Botón volver flotante */
    a.btn-back {
        position: absolute !important;
        top: 16px !important;
        right: 16px !important;
        left: auto !important; /* 🔴 CLAVE */
        margin: 0 !important; /* 🔴 CLAVE */

        width: 40px !important;
        height: 40px !important;
        border-radius: 10px !important;
        background: var(--primary) !important;
        border: 1px solid var(--primary) !important;
        color: #fff !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
        text-decoration: none !important;
        box-shadow: 0 1px 2px rgba(0,0,0,.15) !important;
        z-index: 20;
    }

        a.btn-back:hover {
            background: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
        }

        /* Ícono */
        a.btn-back img {
            width: 25px;
            height: 25px;
            display: block;
        }

</style>


</style>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script>
        const API   = 'http://kaledcrc-001-site1.mtempurl.com';
        const AG_ID = @Model.Id;

        let currentAg = null;

        $(function () {
            loadAg();
            $('#frmAg').on('submit', onSave);
        });

        function escapeHtml(s) {
            return String(s ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function pick(obj, keys, def = null) {
            for (const k of keys) {
                if (obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
            }
            return def;
        }

        // yyyy-MM-dd -> dd/MM/yyyy
        function formatFechaDisplay(raw) {
            if (!raw) return '';
            const s = raw.toString().substring(0, 10);
            const parts = s.split('-');
            if (parts.length !== 3) return s;
            const [y, m, d] = parts;
            return `${d}/${m}/${y}`;
        }

        // cualquier string fecha -> yyyy-MM-dd para <input type="date">
        function formatFechaForInput(raw) {
            if (!raw) return '';
            const s = raw.toString();
            if (s.length >= 10 && s[4] === '-' && s[7] === '-') {
                return s.substring(0, 10);
            }
            return s.substring(0, 10);
        }

        function formatHoraDisplay(raw) {
            if (!raw) return '';
            const s = raw.toString();
            return s.substring(0, 5);
        }

        function buildClienteNombre(u) {
            if (!u) return '(Sin usuario)';
            const n = (u.nombre ?? u.Nombre ?? '').trim();
            const a = (u.apellidos ?? u.Apellidos ?? '').trim();
            const user = (u.userName ?? u.UserName ?? '').trim();
            const full = [n, a].filter(Boolean).join(' ').trim();
            return full || user || 'Usuario';
        }

        function buildVehiculoDesc(v) {
            if (!v) return '(Sin vehículo)';
            const placa = (v.placa ?? v.Placa ?? '').toString().toUpperCase();
            const marca = (v.marca?.nombre ?? v.Marca?.Nombre ?? v.marca ?? v.Marca ?? '').toString();
            const modelo = (v.modelo ?? v.Modelo ?? '').toString();
            const partes = [placa, marca, modelo].filter(Boolean);
            return partes.join(' - ') || '(Sin vehículo)';
        }

        function loadAg() {
            $.getJSON(`${API}/Agendamiento/${AG_ID}`, function (a) {
                currentAg = a;

                const idAg      = pick(a, ['id_agendamiento','idAgendamiento']);
                const clienteId = pick(a, ['cliente_id','clienteId']);
                const vehId     = pick(a, ['vehiculo_id','vehiculoId']);
                const estadoId  = pick(a, ['id_estado','idEstado']);

                const fechaAg      = pick(a, ['fecha_agregada','fechaAgregada']);
                const fechaEntrega = pick(a, ['fecha_estimada_entrega','fechaEstimadaEntrega']);
                const horaLl       = pick(a, ['hora_llegada','horaLlegada']);
                const costo        = pick(a, ['costo_mantenimiento','costoMantenimiento','costo']);

                $('#id_ag').val(idAg ?? '');
                $('#cliente_id').val(clienteId ?? '');
                $('#vehiculo_id').val(vehId ?? '');
                $('#id_estado').val(estadoId ?? '');

                $('#fecha_agregada').val(fechaAg ? formatFechaDisplay(fechaAg) : '');
                $('#hora_llegada').val(horaLl ? formatHoraDisplay(horaLl) : '');

                $('#fecha_estimada_entrega').val(fechaEntrega ? formatFechaForInput(fechaEntrega) : '');
                $('#costo_mantenimiento').val(costo != null ? costo : '');

                const reqs = [];

                // Vehículo
                if (vehId != null) {
                    reqs.push(
                        $.getJSON(`${API}/Vehiculos/${vehId}`)
                            .then(v => $('#vehiculo_desc').val(buildVehiculoDesc(v)))
                            .fail(() => $('#vehiculo_desc').val('(Error cargando vehículo)'))
                    );
                } else {
                    $('#vehiculo_desc').val('(Sin vehículo)');
                }

                // Cliente
                if (clienteId != null) {
                    reqs.push(
                        $.getJSON(`${API}/api/usuarios/${clienteId}`)
                            .then(u => $('#cliente_nombre').val(buildClienteNombre(u)))
                            .fail(() => $('#cliente_nombre').val('(Error cargando cliente)'))
                    );
                } else {
                    $('#cliente_nombre').val('(Sin usuario)');
                }

                // Estados -> select
                reqs.push(
                    $.getJSON(`${API}/Estados`)
                        .then(list => {
                            const arr = Array.isArray(list) ? list : [];
                            const $sel = $('#estado_select').empty();

                            // Orden alfabético
                            arr.sort((a, b) => (a.nombre ?? '').localeCompare(b.nombre ?? ''));

                            arr.forEach(e => {
                                const val = e.id_estado;
                                const nombre = e.nombre ?? '';
                                const selAttr = String(val) === String(estadoId) ? ' selected' : '';
                                $sel.append(`<option value="${val}"${selAttr}>${escapeHtml(nombre)}</option>`);
                            });

                            // Mantener sincronizado el hidden por si lo usas en otro lado
                            $('#estado_select').on('change', function () {
                                $('#id_estado').val($(this).val());
                            });
                        })
                        .fail(() => {
                            $('#estado_select').html('<option value="">(Error cargando estados)</option>');
                        })
                );

                Promise.allSettled(reqs);
            }).fail(function (xhr) {
                console.error(xhr);
                alert('No se pudo cargar el agendamiento.');
            });
        }

        async function onSave(e) {
            e.preventDefault();
            if (!currentAg) {
                alert('No se ha cargado el agendamiento.');
                return;
            }

            $('#btnSave').prop('disabled', true);

            const idAg      = $('#id_ag').val();
            const clienteId = $('#cliente_id').val();
            const vehId     = $('#vehiculo_id').val();
            const estadoId  = $('#estado_select').val() || $('#id_estado').val();

            const fechaAg   = pick(currentAg, ['fecha_agregada','fechaAgregada']);
            const fechaCita = pick(currentAg, ['fecha_estimada','fechaEstimada']);
            const horaLl    = pick(currentAg, ['hora_llegada','horaLlegada']);

            const fechaEntregaInput = $('#fecha_estimada_entrega').val(); // yyyy-MM-dd
            const costoInput        = $('#costo_mantenimiento').val();
            const costoNum = costoInput === '' ? null : Number(costoInput);

            const payload = {
                id_agendamiento: Number(idAg),
                cliente_id:      Number(clienteId),
                vehiculo_id:     Number(vehId),
                fecha_agregada:  fechaAg,
                fecha_estimada:  fechaCita,
                hora_llegada:    horaLl,
                id_estado:       Number(estadoId),
                fecha_estimada_entrega: fechaEntregaInput || null,
                costo_mantenimiento: isNaN(costoNum) ? null : costoNum
            };

            try {
                await $.ajax({
                    url: `${API}/Agendamiento`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(payload)
                });

                window.location.href = '/Mantenimientos/Index';
            } catch (err) {
                console.error(err);
                alert('No se pudo guardar los cambios del agendamiento.');
            } finally {
                $('#btnSave').prop('disabled', false);
            }
        }
    </script>
}
