@page "{id:int}"
@model Front.Pages.Mantenimientos.EditarModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Editar agendamiento";
}

<h1>Editar agendamiento</h1>

<div class="card mt-3">
    <div class="card-body">
        <form id="editForm">
            <div class="row g-3">
                <div class="col-12 col-md-3">
                    <label class="form-label">ID Agendamiento</label>
                    <input id="agId" class="form-control" readonly />
                </div>

                <div class="col-12 col-md-3">
                    <label class="form-label">ID Cliente</label>
                    <input id="clienteId" class="form-control" readonly />
                </div>

                <div class="col-12 col-md-3">
                    <label class="form-label">ID Vehículo</label>
                    <input id="vehiculoId" class="form-control" readonly />
                </div>

                <div class="col-12 col-md-3">
                    <label class="form-label">Estado actual</label>
                    <input id="estadoId" class="form-control" readonly />
                </div>
            </div>

            <hr class="my-4" />

            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label">Fecha creada</label>
                    <input id="fechaAgregada" class="form-control" readonly />
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">Hora llegada</label>
                    <input id="horaLlegada" class="form-control" readonly />
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">Fecha estimada de entrega</label>
                    <input id="fechaEstimada" class="form-control" type="date" />
                </div>
            </div>

            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-orange">
                    Guardar cambios
                </button>
                <a href="/Mantenimientos" class="btn btn-secondary">
                    Volver
                </a>
            </div>
        </form>
    </div>
</div>

<div class="mt-3">
    <small class="text-muted">
        Nota: Esta pantalla modifica únicamente la <strong>fecha estimada de entrega</strong> del agendamiento.
    </small>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

    .btn-orange:hover {
        background: #8f9a11 !important;
    }
</style>

<script>
    const API_BASE = 'https://tecmave-api.azurewebsites.net';
    const AG_URL   = `${API_BASE}/Agendamiento`;

    // Id que viene en la ruta /Mantenimientos/Editar/{id}
    const AG_ID = @Model.Id;

    let currentAg = null;

    function esc(s) {
        return String(s ?? '')
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'",'&#39;');
    }

    function formatFechaForInput(f) {
        if (!f) return '';
        // "2025-12-11" o "2025-12-11T00:00:00"
        const s = f.toString();
        return s.substring(0, 10);
    }

    function formatFechaDisplay(f) {
        if (!f) return '';
        const s = f.toString().substring(0, 10); // yyyy-MM-dd
        const [y,m,d] = s.split('-');
        if (!y || !m || !d) return s;
        return `${d}/${m}/${y}`;
    }

    function formatHoraDisplay(h) {
        if (!h) return '';
        const s = h.toString();
        return s.substring(0,5); // hh:mm
    }

    async function loadAgendamiento() {
        try {
            const res = await fetch(`${AG_URL}/${AG_ID}`);
            if (!res.ok) {
                alert('No se pudo cargar el agendamiento.');
                return;
            }

            const data = await res.json();
            currentAg = data;

            // Rellenar campos
            document.getElementById('agId').value        = data.id_agendamiento ?? '';
            document.getElementById('clienteId').value   = data.cliente_id ?? '';
            document.getElementById('vehiculoId').value  = data.vehiculo_id ?? '';
            document.getElementById('estadoId').value    = data.id_estado ?? '';

            document.getElementById('fechaAgregada').value =
                formatFechaDisplay(data.fecha_agregada);

            document.getElementById('horaLlegada').value =
                formatHoraDisplay(data.hora_llegada);

            // Fecha estimada de entrega (usa campo fecha_estimada)
            const fechaEst = data.fecha_estimada || data.fecha_agregada;
            document.getElementById('fechaEstimada').value =
                formatFechaForInput(fechaEst);

        } catch (err) {
            console.error(err);
            alert('Error cargando el agendamiento.');
        }
    }

    async function saveChanges(e) {
        e.preventDefault();
        if (!currentAg) {
            alert('No se ha cargado el agendamiento.');
            return;
        }

        const fechaEstimadaInput = document.getElementById('fechaEstimada').value;

        if (!fechaEstimadaInput) {
            if (!confirm('No has seleccionado fecha estimada de entrega. ¿Deseas continuar y dejarla vacía?')) {
                return;
            }
        }

        // Armamos payload con todos los campos requeridos por el backend
        const payload = {
            id_agendamiento: currentAg.id_agendamiento,
            cliente_id:      currentAg.cliente_id,
            vehiculo_id:     currentAg.vehiculo_id,
            fecha_agregada:  currentAg.fecha_agregada,
            fecha_estimada:  fechaEstimadaInput || null,
            hora_llegada:    currentAg.hora_llegada,
            id_estado:       currentAg.id_estado
        };

        try {
            const res = await fetch(AG_URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('Agendamiento actualizado correctamente.');
                // Opcional: volver automáticamente a la lista
                window.location.href = '/Mantenimientos';
            } else {
                let msg = 'No se pudo actualizar el agendamiento.';
                try {
                    const errJson = await res.json();
                    if (errJson?.mensaje || errJson?.message) {
                        msg = errJson.mensaje || errJson.message;
                    }
                } catch { }
                alert(msg);
            }
        } catch (err) {
            console.error(err);
            alert('Error de conexión al actualizar el agendamiento.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAgendamiento();

        const form = document.getElementById('editForm');
        form.addEventListener('submit', saveChanges);
    });
</script>
