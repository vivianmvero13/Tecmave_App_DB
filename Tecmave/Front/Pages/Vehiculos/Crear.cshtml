@page
@model Front.Pages.Vehiculos.CrearModel
@{
    ViewData["Title"] = "Registrar vehículo";
}

<section class="section">
    <div class="container grid cols-2">
        <div class="card">
            <h3 id="formTitle">Registrar vehículo</h3>

            <div class="form-row">
                <div>
                    <label for="usuarioInput">Usuario</label>
                    <select id="usuarioInput" class="input">
                        <option value="">Seleccione un usuario</option>
                    </select>
                </div>
                <div>
                    <label for="marcaInput">Marca</label>
                    <select id="marcaInput" class="input">
                        <option value="">Seleccione una marca</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="modeloInput">Modelo</label>
                    <input id="modeloInput" class="input" maxlength="100" />
                </div>
                <div>
                    <label for="annoInput">Año</label>
                    <input id="annoInput" class="input" type="number" min="1950" max="2100" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="placaInput">Placa</label>
                    <input id="placaInput" class="input" maxlength="10" />
                </div>
            </div>

            <div id="formMsg" class="text-danger mt-2" style="display:none;"></div>
        </div>

        <div class="card">
            <h3>Vehículos del usuario</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Año</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="listaDatos">
                    <tr><td colspan="5">Seleccione un usuario…</td></tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button id="guardarBtn" class="btn btn-orange" type="button">Guardar</button>
            <a class="btn btn-secondary" asp-page="/Vehiculos/Index">Volver</a>
        </div>
    </div>
</section>

<style>
    .btn-orange {
        background: #ff8c00 !important;
        border: 1px solid #ff8c00 !important;
        color: #fff !important;
        padding: .5rem 1rem;
        border-radius: .25rem;
    }

        .btn-orange:hover {
            background: #e67e00 !important;
        }

    .text-danger {
        color: #dc3545;
    }

    .grid.cols-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: .75rem;
    }

    .input {
        width: 100%;
        padding: .5rem;
    }

    .card {
        border: 1px solid #e5e5e5;
        border-radius: .5rem;
        padding: 1rem;
    }

    .gap-2 {
        gap: .5rem;
    }

    .table {
        width: 100%;
    }

        .table th, .table td {
            padding: .5rem;
            border-bottom: 1px solid #eee;
        }
</style>

<script>
    const API_BASE      = "https://localhost:7096";
    const URL_VEHICULOS = `${API_BASE}/vehiculos`;
    const URL_MARCAS    = `${API_BASE}/marcas`;
    const URL_USUARIOS  = `${API_BASE}/api/usuarios`;

    const marcasMap = new Map();

    let currentVehiculoId = null;   // null = crear, número = editar
    let usersLoaded = false;
    let marcasLoaded = false;
    let pendingClienteId = null;    // para setear el usuario cuando cargue el vehículo

    function showMsg(text){
      const el = document.getElementById('formMsg');
      el.textContent = text || '';
      el.style.display = text ? 'block' : 'none';
    }

    function esc(s){
      return String(s ?? '').replace(/[&<>"'`=\/]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
      }[c]));
    }

    function getQS(name){
      const p = new URLSearchParams(window.location.search);
      return p.get(name);
    }

    // ---------- Usuarios ----------
    function nombreCompleto(u){
      const n = (u.nombre ?? u.Nombre ?? '').trim();
      const a = (u.apellidos ?? u.Apellidos ?? '').trim();
      const full = [n, a].filter(Boolean).join(' ').trim();
      return full || (u.userName ?? u.UserName ?? 'Usuario');
    }

    function cargarUsuarios(){
      return fetch(URL_USUARIOS, { credentials: 'include' })
        .then(r => r.json())
        .then(list => {
          const data = Array.isArray(list) ? list : (Array.isArray(list?.data) ? list.data : []);
          const sel = document.getElementById('usuarioInput');
          sel.innerHTML = '<option value="">Seleccione un usuario</option>';
          data.sort((a,b) => nombreCompleto(a).localeCompare(nombreCompleto(b)));
          for(const u of data){
            const id = u.id ?? u.Id;
            if(!id) continue;
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = nombreCompleto(u);
            sel.appendChild(opt);
          }
          usersLoaded = true;
          // Si ya sabemos a qué cliente pertenece el vehículo que estamos editando
          if (pendingClienteId) {
            sel.value = String(pendingClienteId);
            cargarVehiculosAsociados(); // refresca tabla a ese usuario
          }
        })
        .catch(err => { console.error('usuarios', err); showMsg('Error al cargar usuarios.'); });
    }

    // ---------- Marcas ----------
    function cargarMarcas(){
      return fetch(URL_MARCAS, { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
          const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
          marcasMap.clear();
          for(const m of list){
            const id = m.id_marca ?? m.id ?? m.Id;
            const nombre = (m.nombre ?? m.Nombre ?? '').trim();
            if(id && nombre) marcasMap.set(Number(id), nombre);
          }

          const sel = document.getElementById('marcaInput');
          sel.innerHTML = '<option value="">Seleccione una marca</option>';
          [...marcasMap.entries()]
            .sort((a,b) => a[1].localeCompare(b[1]))
            .forEach(([id, nombre]) => {
              const opt = document.createElement('option');
              opt.value = String(id);
              opt.textContent = nombre;
              sel.appendChild(opt);
            });

          marcasLoaded = true;
        })
        .catch(err => { console.error('marcas', err); showMsg('Error al cargar marcas.'); });
    }

    // ---------- Listado por usuario ----------
    function cargarVehiculosAsociados(){
      const uid = parseInt(document.getElementById('usuarioInput').value || '0', 10);
      const tb  = document.getElementById('listaDatos');
      if(!uid){ tb.innerHTML = '<tr><td colspan="5">Seleccione un usuario…</td></tr>'; return; }

      fetch(URL_VEHICULOS, { credentials: 'include' })
        .then(r => { if(!r.ok) throw r; return r.json(); })
        .then(data => {
          const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
          const propios = list.filter(v => {
            const cid = v.cliente_id ?? v.clienteId ?? v.cliente?.id ?? v.ClienteId ?? 0;
            return Number(cid) === uid;
          });

          if(!propios.length){
            tb.innerHTML = '<tr><td colspan="5">Sin vehículos para este usuario.</td></tr>';
            return;
          }

          tb.innerHTML = propios.map(v => {
            const id       = v.id_vehiculo ?? v.id ?? v.Id;
            const placa    = String(v.placa ?? '').toUpperCase();
            const annoVal  = Number(v.anno ?? v.Anno ?? 0);
            const annoTxt  = annoVal > 0 ? String(annoVal) : '—';
            const modelo   = v.modelo ?? v.Modelo ?? '';
            const idMarca  = Number(v.id_marca ?? v.idMarca ?? v.MarcaId ?? 0);
            const marcaNom = (typeof v.marca === 'string' && v.marca.trim())
                              ? v.marca
                              : (marcasMap.get(idMarca) || (idMarca ? `#${idMarca}` : '—'));
            const selfUrl  = `${location.pathname}?id=${encodeURIComponent(id)}`;

            return `
              <tr>
                <td>${esc(placa)}</td>
                <td>${esc(marcaNom)}</td>
                <td>${esc(String(modelo))}</td>
                <td>${esc(annoTxt)}</td>
                <td><a class="btn btn-outline-primary btn-sm" href="${selfUrl}">Editar</a></td>
              </tr>`;
          }).join('');
        })
        .catch(async err => {
          let msg = 'Error cargando vehículos.'; try { msg = (await err.json())?.message || msg; } catch {}
          tb.innerHTML = `<tr><td colspan="5">${esc(msg)}</td></tr>`;
        });
    }

    // ---------- Crear / Actualizar ----------
    function getFormData(){
      const uid      = parseInt(document.getElementById('usuarioInput').value || '0', 10);
      const id_marca = parseInt(document.getElementById('marcaInput').value || '0', 10);
      const modelo   = (document.getElementById('modeloInput').value || '').trim();
      const anno     = parseInt(document.getElementById('annoInput').value || '0', 10);
      const placa    = (document.getElementById('placaInput').value || '').trim().toUpperCase();

      if(!uid) return { ok:false, msg:'Seleccione un usuario.' };
      if(!id_marca) return { ok:false, msg:'Seleccione una marca.' };
      if(!modelo) return { ok:false, msg:'El modelo es requerido.' };
      const yearNow = new Date().getFullYear();
      if(!anno || anno < 1950 || anno > yearNow + 1) return { ok:false, msg:`El año debe estar entre 1950 y ${yearNow + 1}.` };
      if(!placa) return { ok:false, msg:'La placa es requerida.' };

      return { ok:true, payload:{ cliente_id: uid, id_marca, modelo, anno, placa } };
    }

        async function crearVehiculo(){
      const uid      = parseInt(document.getElementById('usuarioInput').value || '0', 10);
      const id_marca = parseInt(document.getElementById('marcaInput').value || '0', 10);
      const modelo   = (document.getElementById('modeloInput').value || '').trim();
      const anno     = parseInt(document.getElementById('annoInput').value || '0', 10);
      const placa    = (document.getElementById('placaInput').value || '').trim().toUpperCase();

      // validaciones rápidas (usa las tuyas si prefieres)
      const yearNow = new Date().getFullYear();
      if(!uid) return showMsg('Seleccione un usuario.');
      if(!id_marca) return showMsg('Seleccione una marca.');
      if(!modelo) return showMsg('El modelo es requerido.');
      if(!anno || anno < 1950 || anno > yearNow + 1) return showMsg(`El año debe estar entre 1950 y ${yearNow + 1}.`);
      if(!placa) return showMsg('La placa es requerida.');

      showMsg('');

      // El API acepta este shape; en crear mandamos id_vehiculo: 0
      const payload = {
        id_vehiculo: 0,
        cliente_id: uid,
        id_marca,
        anno,
        modelo,
        placa
      };

      const r = await fetch(URL_VEHICULOS, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });

      if(!r.ok){
        let m = 'Error al registrar.'; try { m = (await r.json())?.message || m; } catch {}
        return showMsg(m);
      }

      // limpiar y refrescar
      document.getElementById('marcaInput').value = '';
      document.getElementById('modeloInput').value = '';
      document.getElementById('annoInput').value = '';
      document.getElementById('placaInput').value = '';
      showMsg('');
      cargarVehiculosAsociados();
      alert('Vehículo registrado correctamente.');
    }

    async function actualizarVehiculo(){
      if(!currentVehiculoId) return showMsg('No hay vehículo cargado para editar.');

      const uid      = parseInt(document.getElementById('usuarioInput').value || '0', 10);
      const id_marca = parseInt(document.getElementById('marcaInput').value || '0', 10);
      const modelo   = (document.getElementById('modeloInput').value || '').trim();
      const anno     = parseInt(document.getElementById('annoInput').value || '0', 10);
      const placa    = (document.getElementById('placaInput').value || '').trim().toUpperCase();

      const yearNow = new Date().getFullYear();
      if(!uid) return showMsg('Seleccione un usuario.');
      if(!id_marca) return showMsg('Seleccione una marca.');
      if(!modelo) return showMsg('El modelo es requerido.');
      if(!anno || anno < 1950 || anno > yearNow + 1) return showMsg(`El año debe estar entre 1950 y ${yearNow + 1}.`);
      if(!placa) return showMsg('La placa es requerida.');

      showMsg('');

      // PUT al mismo endpoint, sin path param; el id viaja en el body
      const payload = {
        id_vehiculo: Number(currentVehiculoId),
        cliente_id: uid,
        id_marca,
        anno,
        modelo,
        placa
      };

      const r = await fetch(URL_VEHICULOS, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });

      if(!r.ok){
        let m = 'Error al actualizar.'; try { m = (await r.json())?.message || m; } catch {}
        return showMsg(m);
      }

      alert('Vehículo actualizado correctamente.');
      salirModoEdicion();     // vuelve a modo crear
      cargarVehiculosAsociados();
    }


    function setModoCrear(){
      currentVehiculoId = null;
      document.getElementById('formTitle').textContent = 'Registrar vehículo';
      const btn = document.getElementById('guardarBtn');
      btn.textContent = 'Guardar';
      btn.onclick = crearVehiculo;
    }

    function setModoEditar(id){
      currentVehiculoId = id;
      document.getElementById('formTitle').textContent = 'Editar vehículo';
      const btn = document.getElementById('guardarBtn');
      btn.textContent = 'Actualizar';
      btn.onclick = actualizarVehiculo;
    }

    function limpiarFormulario(){
      document.getElementById('marcaInput').value = '';
      document.getElementById('modeloInput').value = '';
      document.getElementById('annoInput').value = '';
      document.getElementById('placaInput').value = '';
      showMsg('');
    }

    function salirModoEdicion(){
      // Limpia query string ?id=...
      const url = new URL(window.location.href);
      url.searchParams.delete('id');
      window.history.replaceState({}, '', url.toString());

      setModoCrear();
      limpiarFormulario();
    }

    // ---------- Cargar vehículo (para editar) ----------
    async function cargarVehiculoPorId(id){
      // Asegura que usuarios y marcas estén cargados para setear selects
      if(!usersLoaded || !marcasLoaded){
        await Promise.all([cargarUsuarios(), cargarMarcas()]);
      }
      const r = await fetch(`${URL_VEHICULOS}/${encodeURIComponent(id)}`, { credentials:'include' });
      if(!r.ok){
        let m = 'No se pudo cargar el vehículo.'; try { m = (await r.json())?.message || m; } catch {}
        showMsg(m); return;
      }
      const v = await r.json();

      const clienteId = v.cliente_id ?? v.clienteId ?? v.ClienteId ?? v.cliente?.id ?? null;
      const marcaId   = v.id_marca ?? v.idMarca ?? v.MarcaId ?? null;

      // Setea selects y campos
      if(clienteId){
        pendingClienteId = Number(clienteId);
        document.getElementById('usuarioInput').value = String(pendingClienteId);
        cargarVehiculosAsociados();
      }
      if(marcaId) document.getElementById('marcaInput').value = String(marcaId);

      document.getElementById('modeloInput').value = v.modelo ?? v.Modelo ?? '';
      document.getElementById('annoInput').value   = v.anno ?? v.Anno ?? '';
      document.getElementById('placaInput').value  = (v.placa ?? '').toString().toUpperCase();

      setModoEditar(Number(v.id_vehiculo ?? v.id ?? v.Id ?? id));
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      setModoCrear();
      await Promise.all([cargarUsuarios(), cargarMarcas()]);
      document.getElementById('usuarioInput').addEventListener('change', cargarVehiculosAsociados);

      const qsId = getQS('id');
      if(qsId){
        // Modo edición
        try {
          await cargarVehiculoPorId(qsId);
        } catch (e) {
          console.error(e);
          showMsg('Error al cargar el vehículo.');
          setModoCrear();
        }
      }
    });
</script>
