@page
@model Front.Pages.Vehiculos.CrearModel
@{
    ViewData["Title"] = "Registrar vehículo";
    var esCliente = User.IsInRole("Cliente");
    var isAdmin = User.Identity?.IsAuthenticated == true && User.IsInRole("Admin");
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "0";

}

<section class="section">
    <div class="container grid cols-2">
        @if (isAdmin)
        {
            <a asp-page="/Vehiculos/Index"
               class="btn-back btn-back-top"
               title="Volver"
               aria-label="Volver">
                <img src="/assets/img/back.png" alt="Volver" />
            </a>
        }
        <div class="card">
            <h3 id="formTitle">Registrar vehículo</h3>

            <div class="form-row">
                <div>
                    <label for="usuarioInput">Usuario</label>
                    <select id="usuarioInput" class="input">
                        <option value="">Seleccione un usuario</option>
                    </select>
                </div>
                <div>
                    <label for="marcaInput">Marca</label>
                    <select id="marcaInput" class="input">
                        <option value="">Seleccione una marca</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="modeloInput">Modelo</label>
                    <input id="modeloInput" class="input" maxlength="100" />
                </div>
                <div>
                    <label for="annoInput">Año</label>
                    <input id="annoInput" class="input" type="number" min="1950" max="2100" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="placaInput">Placa</label>
                    <input id="placaInput"
                           class="input"
                           maxlength="6"
                           pattern="[A-Za-z0-9]{1,6}"
                           title="Solo 6 caracteres alfanuméricos (A-Z, 0-9)" />
                </div>
            </div>

            <div id="formMsg" class="text-danger mt-2" style="display:none;"></div>
        </div>

        <div class="card">
            <h3>Vehículos del usuario</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Año</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="listaDatos">
                    <tr><td colspan="5">Seleccione un usuario…</td></tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button id="guardarBtn" class="btn" type="button">Guardar</button>
        </div>
    </div>
</section>

<div id="appModal" class="swal2-container" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody" style="display:none">
    <div class="swal2-backdrop" data-close="1"></div>

    <div class="swal2-popup" role="document" tabindex="-1">
        <button class="swal2-close" type="button" aria-label="Cerrar" data-close="1">×</button>

        <div class="swal2-icon" id="modalIconWrap" aria-hidden="true">
            <span class="swal2-icon-content" id="modalIcon">!</span>
        </div>

        <h2 class="swal2-title" id="modalTitle">Título</h2>

        <div class="swal2-html-container" id="modalBody">Mensaje…</div>
    </div>
</div>

<style>
    .swal2-container {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: none;
    }

        .swal2-container.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

    .swal2-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, .45);
    }

    .swal2-popup {
        position: relative;
        z-index: 1;
        width: min(520px, 92vw);
        background: #fff;
        border-radius: 16px;
        padding: 22px 22px 18px;
        box-shadow: 0 18px 55px rgba(0,0,0,.30);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        box-sizing: border-box;
    }

    .swal2-close {
        position: absolute !important;
        top: 12px !important;
        right: 12px !important;
        left: auto !important;
        bottom: auto !important;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        border: none;
        background: #dc3545;
        color: #fff;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(220,53,69,.35);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        box-sizing: border-box;
    }

    .swal2-icon {
        width: 80px;
        height: 80px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        margin: 6px 0 2px;
        border: 4px solid transparent;
        box-sizing: border-box;
    }

    .swal2-icon-content {
        font-size: 42px;
        font-weight: 800;
        line-height: 1;
        display: block;
        transform: translateY(-1px);
    }

    #appModal .swal2-title {
        position: relative;
        padding-bottom: .5rem;
        margin-bottom: 0;
    }

        #appModal .swal2-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }

    .swal2-title-underline {
        width: 64px;
        height: 4px;
        border-radius: 999px;
        background: #dc3545;
        margin: 2px 0 2px;
    }

    .swal2-html-container {
        margin: 0;
        font-size: 1rem;
        color: #4b5563;
        text-align: center;
        max-width: 440px;
    }

    .swal2-icon.warn {
        background: #fff4e5;
        border-color: #f8bb86;
        color: #a15c00;
    }

    .swal2-icon.ok {
        background: #e7f6ec;
        border-color: #a5dc86;
        color: #2e7d32;
    }

    .swal2-icon.error {
        background: #fdecea;
        border-color: #f27474;
        color: #b3261e;
    }

    .swal2-icon.info {
        background: #e7f1ff;
        border-color: #9dc1ff;
        color: #0b57d0;
    }

    .btn-orange {
        background: #ff8c00 !important;
        border: 1px solid #ff8c00 !important;
        color: #fff !important;
        padding: .5rem 1rem;
        border-radius: .25rem
    }

        .btn-orange:hover {
            background: #e67e00 !important;
        }

    .btn-red {
        background: #dc3545 !important;
        border: 1px solid #dc3545 !important;
        color: #fff !important;
        padding: .3rem .8rem;
        border-radius: .25rem
    }

        .btn-red:hover {
            background: #b92b3a !important;
        }

    .btn-outline-primary.btn-sm {
        padding: .3rem .6rem;
        border-radius: .25rem
    }

    .text-danger {
        color: #dc3545
    }

    .grid.cols-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: .75rem
    }

    .input {
        width: 100%;
        padding: .5rem
    }

    .card {
        border: 1px solid #e5e5e5;
        border-radius: .5rem;
        padding: 1rem
    }

    .gap-2 {
        gap: .5rem
    }

    .table {
        width: 100%
    }

        .table th, .table td {
            padding: .5rem;
            border-bottom: 1px solid #eee
        }

    .btn, button, .btn-secondary, .btn-orange {
        padding: .5rem 1rem; /* Tamaño consistente */
        font-size: 1rem; /* Ajuste de tamaño */
        font-weight: 600; /* Asegurar consistencia de fuente */
        border-radius: .25rem; /* Mismo border-radius */
        border: 1px solid transparent; /* Transparente para unificar */
        transition: all 0.3s ease; /* Suavizar transiciones */
        text-align: center;
        cursor: pointer;
    }

    /* Estilos para el botón "Volver" */
    .btn-secondary {
        background: #6c757d;
        color: #fff;
    }

        .btn-secondary:hover {
            background: #5a6268;
        }

    /* Estilo de botón "Guardar" o "Actualizar" */
    .btn-orange {
        background: #ff8c00 !important;
        border: 1px solid #ff8c00 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #e67e00 !important;
        }

    /* Igualar tamaño y apariencia entre botones */
    .mt-4 .btn, .mt-4 .btn-secondary, .mt-4 .btn-orange {
        width: auto; /* Evitar que los botones se expandan a tamaño completo */
    }

    /* El contenedor general es el contexto del botón */
    .container.grid {
        position: relative !important;
    }


    /* Botón volver flotante */
    a.btn-back {
        position: absolute !important;
        top: 16px !important;
        right: 16px !important;
        left: auto !important; /* 🔴 CLAVE */
        margin: 0 !important; /* 🔴 CLAVE */

        width: 40px !important;
        height: 40px !important;
        border-radius: 10px !important;
        background: var(--primary) !important;
        border: 1px solid var(--primary) !important;
        color: #fff !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
        text-decoration: none !important;
        box-shadow: 0 1px 2px rgba(0,0,0,.15) !important;
        z-index: 20;
    }

        a.btn-back:hover {
            background: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
        }

        /* Ícono */
        a.btn-back img {
            width: 25px;
            height: 25px;
            display: block;
        }
</style>


<script>
    const API_BASE = "https://kaledcrc-001-site1.mtempurl.com";
    const URL_VEHICULOS = `${API_BASE}/vehiculos`;
    const URL_MARCAS = `${API_BASE}/Marcas`;
    const URL_USUARIOS = `${API_BASE}/api/usuarios`;

    const marcasMap = new Map();
    let currentVehiculoId = null;
    let usersLoaded = false;
    let marcasLoaded = false;
    let pendingClienteId = null;

    function showMsg(text) {
        const el = document.getElementById('formMsg');
        el.textContent = text || '';
        el.style.display = text ? 'block' : 'none';
    }

    function esc(s) {
        return String(s ?? '').replace(/[&<>"'`=\/]/g, c => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;', '=': '&#61;', '/': '&#47;'
        }[c]));
    }

    function getQS(name) {
        const p = new URLSearchParams(window.location.search);
        return p.get(name);
    }

    const Modal = (() => {
        const root = document.getElementById('appModal');
        const title = document.getElementById('modalTitle');
        const body = document.getElementById('modalBody');
        const icon = document.getElementById('modalIcon');
        const iconWrap = document.getElementById('modalIconWrap');

        let onClose = null;

        function setKind(kind) {
            iconWrap.classList.remove('warn', 'ok', 'error', 'info');
            const map = {
                ok: { cls: 'ok', text: '✓' },
                warn: { cls: 'warn', text: '!' },
                error: { cls: 'error', text: '!' },
                info: { cls: 'info', text: 'ℹ' }
            };
            const k = map[kind] || map.info;
            iconWrap.classList.add(k.cls);
            icon.textContent = k.text;
        }

        function show({ titleText = 'Información', bodyText = '', kind = 'info', onCloseCb = null }) {
            setKind(kind);
            title.textContent = titleText;
            body.textContent = bodyText;

            onClose = (typeof onCloseCb === 'function') ? onCloseCb : null;

            root.classList.add('show');
            root.style.display = 'flex';
            root.setAttribute('aria-hidden', 'false');

            document.addEventListener('keydown', escListener);
        }

        function hide() {
            root.classList.remove('show');
            root.style.display = 'none';
            root.setAttribute('aria-hidden', 'true');
            document.removeEventListener('keydown', escListener);

            if (onClose) {
                const cb = onClose;
                onClose = null;
                try { cb(); } catch { }
            }
        }

        function escListener(e) { if (e.key === 'Escape') hide(); }

        root.addEventListener('click', (e) => {
            if (e.target?.dataset?.close === '1') hide();
        });

        return { show, hide };
    })();

    function normalizePlacaInput() {
        const input = document.getElementById('placaInput');
        if (!input) return;
        let v = (input.value || '').toUpperCase();
        v = v.replace(/[^A-Z0-9]/g, '');
        if (v.length > 6) v = v.slice(0, 6);
        input.value = v;
    }

    function nombreCompleto(u) {
        const n = (u.nombre ?? u.Nombre ?? '').trim();
        const a = (u.apellidos ?? u.Apellidos ?? '').trim();
        const full = [n, a].filter(Boolean).join(' ').trim();
        return full || (u.userName ?? u.UserName ?? 'Usuario');
    }

    function cargarUsuarios() {
        return fetch(URL_USUARIOS, { credentials: 'include' })
            .then(r => r.json())
            .then(list => {
                const data = Array.isArray(list) ? list : (Array.isArray(list?.data) ? list.data : []);
                const sel = document.getElementById('usuarioInput');
                sel.innerHTML = '<option value="">Seleccione un usuario</option>';
                data.sort((a, b) => nombreCompleto(a).localeCompare(nombreCompleto(b)));
                for (const u of data) {
                    const id = u.id ?? u.Id;
                    if (!id) continue;
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = nombreCompleto(u);
                    sel.appendChild(opt);
                }
                usersLoaded = true;
                if (pendingClienteId) {
                    sel.value = String(pendingClienteId);
                    cargarVehiculosAsociados();
                }
            })
            .catch(err => { console.error('usuarios', err); showMsg('Error al cargar usuarios.'); });
    }

    function cargarMarcas() {
        return fetch(URL_MARCAS, { credentials: 'include' })
            .then(r => r.json())
            .then(data => {
                const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
                marcasMap.clear();
                for (const m of list) {
                    const id = m.id_marca ?? m.id ?? m.Id;
                    const nombre = (m.nombre ?? m.Nombre ?? '').trim();
                    if (id && nombre) marcasMap.set(Number(id), nombre);
                }

                const sel = document.getElementById('marcaInput');
                sel.innerHTML = '<option value="">Seleccione una marca</option>';
                [...marcasMap.entries()]
                    .sort((a, b) => a[1].localeCompare(b[1]))
                    .forEach(([id, nombre]) => {
                        const opt = document.createElement('option');
                        opt.value = String(id);
                        opt.textContent = nombre;
                        sel.appendChild(opt);
                    });

                marcasLoaded = true;
            })
            .catch(err => { console.error('marcas', err); showMsg('Error al cargar marcas.'); });
    }

    function cargarVehiculosAsociados() {
        const uid = parseInt(document.getElementById('usuarioInput').value || '0', 10);
        const tb = document.getElementById('listaDatos');
        if (!uid) { tb.innerHTML = '<tr><td colspan="5">Seleccione un usuario…</td></tr>'; return; }

        fetch(URL_VEHICULOS, { credentials: 'include' })
            .then(r => { if (!r.ok) throw r; return r.json(); })
            .then(data => {
                const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
                const propios = list.filter(v => {
                    const cid = v.cliente_id ?? v.clienteId ?? v.cliente?.id ?? v.ClienteId ?? 0;
                    return Number(cid) === uid;
                });

                if (!propios.length) {
                    tb.innerHTML = '<tr><td colspan="5">Sin vehículos para este usuario.</td></tr>';
                    return;
                }

                tb.innerHTML = propios.map(v => {
                    const id = v.id_vehiculo ?? v.id ?? v.Id;
                    const placa = String(v.placa ?? '').toUpperCase();
                    const annoVal = Number(v.anno ?? v.Anno ?? 0);
                    const annoTxt = annoVal > 0 ? String(annoVal) : '—';
                    const modelo = v.modelo ?? v.Modelo ?? '';
                    const idMarca = Number(v.id_marca ?? v.idMarca ?? v.MarcaId ?? 0);
                    const marcaNom = (typeof v.marca === 'string' && v.marca.trim())
                        ? v.marca
                        : (marcasMap.get(idMarca) || (idMarca ? `#${idMarca}` : '—'));
                    const selfUrl = `${location.pathname}?id=${encodeURIComponent(id)}`;

                    return `
              <tr>
                <td>${esc(placa)}</td>
                <td>${esc(marcaNom)}</td>
                <td>${esc(String(modelo))}</td>
                <td>${esc(annoTxt)}</td>
                <td>
                  <a class="btn btn-outline-primary btn-sm" href="${selfUrl}">Editar</a>
                  <button class="btn btn-red btn-sm" onclick="confirmarEliminar(${id})">Eliminar</button>
                </td>
              </tr>`;
                }).join('');
            })
            .catch(async err => {
                let msg = 'Error cargando vehículos.'; try { msg = (await err.json())?.message || msg; } catch { }
                tb.innerHTML = `<tr><td colspan="5">${esc(msg)}</td></tr>`;
            });
    }

    function getFormData() {
        const uid = parseInt(document.getElementById('usuarioInput').value || '0', 10);
        const id_marca = parseInt(document.getElementById('marcaInput').value || '0', 10);
        const modelo = (document.getElementById('modeloInput').value || '').trim();
        const anno = parseInt(document.getElementById('annoInput').value || '0', 10);

        let placa = (document.getElementById('placaInput').value || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (placa.length > 6) placa = placa.slice(0, 6);

        if (!uid) return { ok: false, msg: 'Seleccione un usuario.' };
        if (!id_marca) return { ok: false, msg: 'Seleccione una marca.' };
        if (!modelo) return { ok: false, msg: 'El modelo es requerido.' };
        const yearNow = new Date().getFullYear();
        if (!anno || anno < 1950 || anno > yearNow + 1) return { ok: false, msg: `El año debe estar entre 1950 y ${yearNow + 1}.` };

        if (!placa) return { ok: false, msg: 'La placa es requerida.' };
        if (!/^[A-Z0-9]{1,6}$/.test(placa)) return { ok: false, msg: 'La placa solo puede contener letras A-Z y números (máx 6).' };

        return { ok: true, payload: { cliente_id: uid, id_marca, modelo, anno, placa } };
    }

    async function crearVehiculo() {
        const { ok, msg, payload } = getFormData();
        if (!ok) { showMsg(msg); return; }
        showMsg('');

        const bodyReq = { id_vehiculo: 0, ...payload };

        const r = await fetch(URL_VEHICULOS, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(bodyReq)
        });

        if (!r.ok) {
            let m = 'Error al registrar.'; try { m = (await r.json())?.message || m; } catch { }
            return showMsg(m);
        }

        document.getElementById('marcaInput').value = '';
        document.getElementById('modeloInput').value = '';
        document.getElementById('annoInput').value = '';
        document.getElementById('placaInput').value = '';
        cargarVehiculosAsociados();

        Modal.show({ titleText: 'Éxito', bodyText: 'Vehículo registrado correctamente.', kind: 'ok' });
    }

    async function actualizarVehiculo() {
        if (!currentVehiculoId) return showMsg('No hay vehículo cargado para editar.');

        const { ok, msg, payload } = getFormData();
        if (!ok) { showMsg(msg); return; }
        showMsg('');

        const bodyReq = { id_vehiculo: Number(currentVehiculoId), ...payload };

        const r = await fetch(URL_VEHICULOS, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(bodyReq)
        });

        if (!r.ok) {
            let m = 'Error al actualizar.'; try { m = (await r.json())?.message || m; } catch { }
            return showMsg(m);
        }

        Modal.show({ titleText: 'Éxito', bodyText: 'Vehículo actualizado correctamente.', kind: 'ok' });
        salirModoEdicion();
        cargarVehiculosAsociados();
    }

    async function eliminarVehiculo(id) {
        const r = await fetch(`${URL_VEHICULOS}/${id}`, { method: 'DELETE', credentials: 'include' });
        if (r.ok) {
            if (currentVehiculoId && Number(currentVehiculoId) === Number(id)) {
                salirModoEdicion();
            }
            Modal.show({ titleText: 'Eliminado', bodyText: 'Vehículo eliminado correctamente.', kind: 'ok', onCloseCb: () => cargarVehiculosAsociados() });
        } else {
            let m = 'Error al eliminar.'; try { m = (await r.json())?.message || m; } catch { }
            Modal.show({ titleText: 'Error', bodyText: m, kind: 'error' });
        }
    }

    function confirmarEliminar(id) {
        Modal.show({ titleText: '¿Eliminar vehículo?', bodyText: 'Esta acción no se puede revertir.', kind: 'warn' });
        window._modalDeleteHandler = async () => { await eliminarVehiculo(id); };
        document.getElementById('modalBody').innerHTML =
            'Esta acción no se puede revertir.<br><br><button class="btn btn-red btn-sm" style="margin-top:10px" onclick="(window._modalDeleteHandler && window._modalDeleteHandler())">Sí, eliminar</button>';
    }

    function setModoCrear() {
        currentVehiculoId = null;
        document.getElementById('formTitle').textContent = 'Registrar vehículo';
        const btn = document.getElementById('guardarBtn');
        btn.textContent = 'Guardar';
        btn.onclick = crearVehiculo;
    }

    function setModoEditar(id) {
        currentVehiculoId = id;
        document.getElementById('formTitle').textContent = 'Editar vehículo';
        const btn = document.getElementById('guardarBtn');
        btn.textContent = 'Actualizar';
        btn.onclick = actualizarVehiculo;
    }

    function limpiarFormulario() {
        document.getElementById('marcaInput').value = '';
        document.getElementById('modeloInput').value = '';
        document.getElementById('annoInput').value = '';
        document.getElementById('placaInput').value = '';
        showMsg('');
    }

    function salirModoEdicion() {
        const url = new URL(window.location.href);
        url.searchParams.delete('id');
        window.history.replaceState({}, '', url.toString());
        setModoCrear();
        limpiarFormulario();
    }

    async function cargarVehiculoPorId(id) {
        if (!usersLoaded || !marcasLoaded) {
            await Promise.all([cargarUsuarios(), cargarMarcas()]);
        }
        const r = await fetch(`${URL_VEHICULOS}/${encodeURIComponent(id)}`, { credentials: 'include' });
        if (!r.ok) {
            let m = 'No se pudo cargar el vehículo.'; try { m = (await r.json())?.message || m; } catch { }
            showMsg(m); return;
        }
        const v = await r.json();

        const clienteId = v.cliente_id ?? v.clienteId ?? v.ClienteId ?? v.cliente?.id ?? null;
        const marcaId = v.id_marca ?? v.idMarca ?? v.MarcaId ?? null;

        if (clienteId) {
            pendingClienteId = Number(clienteId);
            document.getElementById('usuarioInput').value = String(pendingClienteId);
            cargarVehiculosAsociados();
        }
        if (marcaId) document.getElementById('marcaInput').value = String(marcaId);

        document.getElementById('modeloInput').value = v.modelo ?? v.Modelo ?? '';
        document.getElementById('annoInput').value = v.anno ?? v.Anno ?? '';
        document.getElementById('placaInput').value = (v.placa ?? '').toString().toUpperCase();

        setModoEditar(Number(v.id_vehiculo ?? v.id ?? v.Id ?? id));
    }
        document.body.dataset.userId = '@userId';
    document.body.dataset.isAdmin = '@isAdmin.ToString().ToLower()';

    document.addEventListener('DOMContentLoaded', async () => {
        setModoCrear();

        const placaEl = document.getElementById('placaInput');
        if (placaEl) {
            placaEl.addEventListener('input', normalizePlacaInput);
            normalizePlacaInput();
        }

        const bodyEl = document.body;
        const currentUserId = parseInt(bodyEl.dataset.userId || '0', 10);
        const isAdmin = bodyEl.dataset.isAdmin === 'true';

        if (!isAdmin && currentUserId) {
            pendingClienteId = currentUserId;
        }

        await Promise.all([cargarUsuarios(), cargarMarcas()]);

        const usuarioSelect = document.getElementById('usuarioInput');
        usuarioSelect.addEventListener('change', cargarVehiculosAsociados);

        if (!isAdmin && currentUserId) {
            usuarioSelect.value = String(currentUserId);
            usuarioSelect.disabled = true;
            cargarVehiculosAsociados();
        }

        const qsId = getQS('id');
        if (qsId) {
            try { await cargarVehiculoPorId(qsId); }
            catch (e) {
                console.error(e);
                showMsg('Error al cargar el vehículo.');
                setModoCrear();
            }
        }
    });
</script>
