@page
@model Front.Pages.Vehiculos.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Vehículos Registrados";
}

<h1>Vehículos Registrados</h1>

<div class="row g-3 align-items-end mt-3">
    <div class="col-12 col-md-8">
        <label for="localSearch" class="form-label">Buscar</label>
        <div class="input-group">
            <input id="localSearch" class="form-control" placeholder="Buscar por placa, marca, modelo, año o cliente…" />
            <button id="clearSearch" class="btn btn-outline-secondary" type="button">Limpiar</button>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mt-3">
    <small id="resultsBadge" class="text-muted">Mostrando 0 de 0</small>
    <div class="d-flex gap-2">
        <button id="exportBtn" class="btn btn-orange btn-sm" type="button">
            <i class="fa-solid fa-file-excel"></i> Exportar
        </button>
        <button id="registrarBtn" class="btn btn-orange btn-sm" type="button" onclick="location.href='/Vehiculos/Crear'">
            <i class="fa-solid fa-plus"></i> Registrar
        </button>
    </div>
</div>

<div class="table-responsive mt-2">
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Placa</th>
                <th>Año</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Cliente</th>
                <th>Email</th>
                <th style="width:150px;">Acciones</th>
            </tr>
        </thead>
        <tbody id="vehiculosTable">
            <tr><td colspan="7">Cargando vehículos…</td></tr>
        </tbody>
    </table>
</div>

<!-- Controles de paginación -->
<div class="d-flex justify-content-between align-items-center mt-2">
    <div class="d-flex align-items-center gap-2">
        <label for="pageSizeSelectVeh" class="form-label mb-0">Mostrar:</label>
        <select id="pageSizeSelectVeh" class="form-select form-select-sm" style="width:auto;">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
        </select>
    </div>
    <nav aria-label="Paginación vehículos" class="vehiculos-pagination-nav">
        <ul class="pagination pagination-sm mb-0 d-flex flex-row align-items-center gap-2"
            style="list-style:none; margin:0; padding:0;">
            <li class="page-item" id="prevPageItemVeh" style="list-style:none;">
                <button class="page-link" type="button" id="prevPageBtnVeh" aria-label="Anterior">&laquo;</button>
            </li>
            <li class="page-item disabled" style="list-style:none;">
                <span class="page-link" id="pageInfoVeh">1 / 1</span>
            </li>
            <li class="page-item" id="nextPageItemVeh" style="list-style:none;">
                <button class="page-link" type="button" id="nextPageBtnVeh" aria-label="Siguiente">&raquo;</button>
            </li>
        </ul>
    </nav>
</div>

<!-- Modal estilo SweetAlert2 (reutilizable) -->
<div id="appModal" class="swal2-container" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody" style="display:none">
    <div class="swal2-backdrop" data-close="1"></div>
    <div class="swal2-popup" role="document" tabindex="-1">
        <button class="swal2-close" type="button" aria-label="Cerrar" data-close="1">×</button>

        <div class="swal2-icon info" id="modalIconWrap" aria-hidden="true">
            <span class="swal2-icon-content" id="modalIcon">ℹ</span>
        </div>

        <h2 class="swal2-title" id="modalTitle">Título</h2>
        <div class="swal2-html-container" id="modalBody">Mensaje…</div>

        <div class="swal2-actions">
            <button id="modalConfirm" class="btn btn-orange" type="button">Aceptar</button>
            <button id="modalCancel" class="btn btn-secondary" type="button" data-close="1" style="display:none">Cancelar</button>
        </div>
    </div>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #8f9a11 !important;
        }

    .actions-group {
        display: flex;
        gap: 0.35rem;
        flex-wrap: nowrap;
    }

        .actions-group .btn {
            white-space: nowrap;
        }

    /* ============================
           Modal estilo SweetAlert2
           ============================ */
    .swal2-container {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: none;
    }

        .swal2-container.show {
            display: block;
        }

    .swal2-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, .45);
    }

    .swal2-popup {
        position: relative;
        width: min(520px, calc(100% - 24px));
        margin: 10vh auto 0;
        background: #fff;
        border-radius: 16px;
        padding: 28px 24px 20px;
        box-shadow: 0 10px 35px rgba(0, 0, 0, .25);
        display: grid;
        justify-items: center;
        text-align: center;
    }

    .swal2-close {
        position: absolute !important;
        top: 12px !important;
        right: 14px !important;
        left: auto !important;
        bottom: auto !important;
        justify-self: end;
        align-self: start;
        border: 0;
        background: transparent;
        font-size: 26px;
        line-height: 1;
        color: #888;
        cursor: pointer;
    }

    .swal2-icon {
        width: 80px;
        height: 80px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        margin: 6px 0 10px;
        border: 4px solid transparent;
    }

    .swal2-icon-content {
        font-size: 42px;
        font-weight: 800;
        line-height: 1;
    }

    .swal2-title {
        margin: 6px 0 8px;
        font-size: 1.35rem;
        font-weight: 700;
        color: #1f2937;
    }

    .swal2-html-container {
        margin: 0;
        font-size: 1rem;
        color: #4b5563;
    }

    .swal2-actions {
        margin-top: 18px;
        display: flex;
        gap: 10px;
        justify-content: center;
        width: 100%;
    }

    .swal2-icon.warn {
        background: #fff4e5;
        border-color: #f8bb86;
        color: #a15c00;
    }

    .swal2-icon.ok {
        background: #e7f6ec;
        border-color: #a5dc86;
        color: #2e7d32;
    }

    .swal2-icon.error {
        background: #fdecea;
        border-color: #f27474;
        color: #b3261e;
    }

    .swal2-icon.info {
        background: #e7f1ff;
        border-color: #9dc1ff;
        color: #0b57d0;
    }

    /* Paginación vehículos: flecha – número – flecha en línea */
    .vehiculos-pagination-nav .pagination {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0.5rem !important;
    }

    .vehiculos-pagination-nav .page-item {
        list-style: none !important;
    }

    .vehiculos-pagination-nav .page-link {
        display: flex !important;
        align-items: center;
        justify-content: center;
        padding: .35rem .65rem;
        border-radius: 8px;
        cursor: pointer;
    }
</style>

<script>
    const API_BASE = 'https://tecmave-api.azurewebsites.net';

    const VEHICULOS_URL = `${API_BASE}/vehiculos`;
    const USUARIOS_URL  = `${API_BASE}/api/usuarios`;
    const MARCAS_URL    = `${API_BASE}/Marcas`;

    const $tableBody = document.getElementById('vehiculosTable');
    const $search    = document.getElementById('localSearch');
    const $clear     = document.getElementById('clearSearch');
    const $badge     = document.getElementById('resultsBadge');
    const $export    = document.getElementById('exportBtn');

    // Paginación
    const PAGE_SIZES_VEH = [5, 10, 20, 50];
    let pageSizeVeh = 5;
    let currentPageVeh = 1;

    const $pageSizeSelectVeh = document.getElementById('pageSizeSelectVeh');
    const $pageInfoVeh       = document.getElementById('pageInfoVeh');
    const $prevPageBtnVeh    = document.getElementById('prevPageBtnVeh');
    const $nextPageBtnVeh    = document.getElementById('nextPageBtnVeh');
    const $prevPageItemVeh   = document.getElementById('prevPageItemVeh');
    const $nextPageItemVeh   = document.getElementById('nextPageItemVeh');

    let allRows = [];
    let filteredRows = [];

    const usersMap  = new Map();
    const marcasMap = new Map();

    function pick(obj, paths, def = '') {
        for (const p of paths) {
            const v = p.split('.').reduce((o, k) => (o && o[k] !== undefined ? o[k] : undefined), obj);
            if (v !== undefined && v !== null) return v;
        }
        return def;
    }

    function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"'`=\/]/g, c => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
        }[c]));
    }

    function nombreCompleto(u){
        const n = (u.nombre ?? u.Nombre ?? '').trim();
        const a = (u.apellidos ?? u.Apellidos ?? '').trim();
        const user = (u.userName ?? u.UserName ?? '').trim();
        const full = [n,a].filter(Boolean).join(' ').trim();
        return full || user || 'Usuario';
    }

    /* =================== Modal helpers (SweetAlert2-like) =================== */
    const Modal = (() => {
        const root   = document.getElementById('appModal');
        const title  = document.getElementById('modalTitle');
        const body   = document.getElementById('modalBody');
        const icon   = document.getElementById('modalIcon');
        const iconWrap = document.getElementById('modalIconWrap');
        const btnConfirm = document.getElementById('modalConfirm');
        const btnCancel  = document.getElementById('modalCancel');

        let onClose = null;
        let onConfirm = null;

        function setKind(kind){
            iconWrap.classList.remove('warn','ok','error','info');
            const map = {
                ok:   { cls:'ok', text:'✓' },
                warn: { cls:'warn', text:'!' },
                error:{ cls:'error', text:'!' },
                info: { cls:'info', text:'ℹ' }
            };
            const k = map[kind] || map.info;
            iconWrap.classList.add(k.cls);
            icon.textContent = k.text;
        }

        function show({
            titleText = 'Información',
            bodyText = '',
            kind = 'info',
            confirmText = 'Aceptar',
            cancelText = null,     // si viene null no se muestra
            onConfirmCb = null,
            onCloseCb = null
        }){
            setKind(kind);
            title.textContent = titleText;
            body.textContent  = bodyText;

            btnConfirm.textContent = confirmText;

            if (cancelText) {
                btnCancel.style.display = 'inline-block';
                btnCancel.textContent = cancelText;
            } else {
                btnCancel.style.display = 'none';
            }

            onConfirm = (typeof onConfirmCb === 'function') ? onConfirmCb : null;
            onClose   = (typeof onCloseCb === 'function') ? onCloseCb : null;

            // reset listeners
            btnConfirm.onclick = async () => {
                try {
                    if (onConfirm) await onConfirm();
                } finally {
                    hide();
                }
            };

            root.classList.add('show');
            root.style.display = 'block';
            root.setAttribute('aria-hidden','false');

            setTimeout(() => btnConfirm.focus(), 0);
            document.addEventListener('keydown', escListener);
        }

        function hide(){
            root.classList.remove('show');
            root.style.display = 'none';
            root.setAttribute('aria-hidden','true');
            document.removeEventListener('keydown', escListener);

            const cb = onClose;
            onClose = null;
            onConfirm = null;
            if (cb) { try { cb(); } catch {} }
        }

        function escListener(e){ if (e.key === 'Escape') hide(); }

        root.addEventListener('click', (e) => {
            if (e.target?.dataset?.close === '1') hide();
        });

        function confirm({ titleText, bodyText, kind='warn', confirmText='Eliminar', cancelText='Cancelar', onConfirmCb }){
            show({
                titleText,
                bodyText,
                kind,
                confirmText,
                cancelText,
                onConfirmCb
            });
        }

        return { show, hide, confirm };
    })();

    // ===== Cargas base =====
    async function loadUsuarios() {
        const r = await fetch(USUARIOS_URL, { credentials: 'include' });
        if (!r.ok) throw new Error(`Usuarios HTTP ${r.status}`);
        const payload = await r.json();
        const list = Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : []);
        usersMap.clear();
        for (const u of list) {
            const id = Number(u.id ?? u.Id);
            if (!id) continue;
            usersMap.set(id, {
                nombre: nombreCompleto(u),
                email: (u.email ?? u.Email ?? '').trim()
            });
        }
    }

    async function loadMarcas() {
        const r = await fetch(MARCAS_URL, { credentials: 'include' });
        if (!r.ok) throw new Error(`Marcas HTTP ${r.status}`);
        const payload = await r.json();
        const list = Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : []);
        marcasMap.clear();
        for (const m of list) {
            const id = Number(m.id_marca ?? m.id ?? m.Id);
            const nombre = (m.nombre ?? m.Nombre ?? '').trim();
            if (id && nombre) marcasMap.set(id, nombre);
        }
    }

    // ===== Transformación de fila del API a modelo UI =====
    function mapApiRow(r) {
        const idRaw = pick(r, ['id','id_vehiculo','idVehiculo','Id','IdVehiculo']);
        const id    = idRaw !== undefined && idRaw !== null ? Number(idRaw) : null;

        const placa    = String(pick(r, ['placa','Placa'], '')).toUpperCase();
        const annoRaw  = Number(pick(r, ['anno','anio','Año','year'], 0));
        const anno     = annoRaw > 0 ? annoRaw : '—';

        const idMarca  = Number(pick(r, ['id_marca','idMarca'], 0));
        const marca    = (pick(r, ['marca','Marca'], '') || marcasMap.get(idMarca) || (idMarca ? `#${idMarca}` : '—'));

        const modelo   = pick(r, ['modelo','Modelo','modelo.nombre','Modelo.Nombre'], '');
        const clienteId= Number(pick(r, ['cliente_id','clienteId','cliente.id','cliente.Id','ClienteId'], 0));

        const cliente  = pick(r, ['cliente','Cliente'], '') || (usersMap.get(clienteId)?.nombre || '');
        const email    = pick(r, ['email','Email','cliente.email','Cliente.Email'], '') || (usersMap.get(clienteId)?.email || '');

        return { id, placa, anno, marca, modelo, cliente, email };
    }

    // ===== Render paginado =====
    function renderRows(pageRows, total, from, to, page, totalPages) {
        if (!total) {
            $tableBody.innerHTML = `<tr><td colspan="7">Sin resultados</td></tr>`;
            $badge.textContent = `Mostrando 0 de 0`;
            $pageInfoVeh.textContent = '0 / 0';
            $prevPageItemVeh.classList.add('disabled');
            $nextPageItemVeh.classList.add('disabled');
            return;
        }

        if (!pageRows.length) {
            $tableBody.innerHTML = `<tr><td colspan="7">Sin resultados en esta página</td></tr>`;
        } else {
            const html = pageRows.map(r => `
                <tr>
                    <td>${escapeHtml(r.placa)}</td>
                    <td>${escapeHtml(String(r.anno))}</td>
                    <td>${escapeHtml(r.marca)}</td>
                    <td>${escapeHtml(r.modelo)}</td>
                    <td>${escapeHtml(r.cliente)}</td>
                    <td>${escapeHtml(r.email)}</td>
                    <td>
                        <div class="actions-group">
                            <a class="btn btn-outline-primary"
                               href="/Vehiculos/Crear?id=${encodeURIComponent(r.id)}">
                                Ver
                            </a>
                            <button type="button"
                                    class="btn btn-outline-danger"
                                    onclick="confirmarEliminar(${r.id})">
                                Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            $tableBody.innerHTML = html;
        }

        $badge.textContent = `Mostrando ${from}-${to} de ${total}`;
        $pageInfoVeh.textContent = `${page} / ${totalPages}`;

        if (page <= 1) $prevPageItemVeh.classList.add('disabled');
        else $prevPageItemVeh.classList.remove('disabled');

        if (page >= totalPages) $nextPageItemVeh.classList.add('disabled');
        else $nextPageItemVeh.classList.remove('disabled');
    }

    function applyFilterVeh() {
        const q = $search.value.trim().toLowerCase();
        if (!q) {
            filteredRows = [...allRows];
        } else {
            filteredRows = allRows.filter(r =>
                r.placa.toLowerCase().includes(q) ||
                String(r.anno).toLowerCase().includes(q) ||
                r.marca.toLowerCase().includes(q) ||
                r.modelo.toLowerCase().includes(q) ||
                r.cliente.toLowerCase().includes(q) ||
                r.email.toLowerCase().includes(q)
            );
        }
    }

    function refreshVehiculosTable() {
        applyFilterVeh();
        const total = filteredRows.length;

        if (!total) {
            renderRows([], 0, 0, 0, 0, 0);
            return;
        }

        const totalPages = Math.max(1, Math.ceil(total / pageSizeVeh));
        if (currentPageVeh > totalPages) currentPageVeh = totalPages;
        if (currentPageVeh < 1) currentPageVeh = 1;

        const startIndex = (currentPageVeh - 1) * pageSizeVeh;
        const endIndex = Math.min(startIndex + pageSizeVeh, total);
        const pageRows = filteredRows.slice(startIndex, endIndex);

        renderRows(pageRows, total, startIndex + 1, endIndex, currentPageVeh, totalPages);
    }

    // ===== Exportar CSV =====
    function exportCsv() {
        const rows = filteredRows.length ? filteredRows : allRows;
        if (!rows.length) return;

        const header = ['Placa','Año','Marca','Modelo','Cliente','Email'];
        const csvRows = [ header.join(',') ]
            .concat(rows.map(r => [r.placa, r.anno, r.marca, r.modelo, r.cliente, r.email]
                .map(val => `"${String(val ?? '').replace(/"/g, '""')}"`).join(',')));

        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        a.href = url; a.download = `vehiculos_${ts}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ===== Eliminar vehículo =====
    async function deleteVehiculo(id) {
        try {
            const res = await fetch(`${VEHICULOS_URL}/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!res.ok) {
                let msg = 'Error eliminando el vehículo.';
                try {
                    const payload = await res.json();
                    if (payload?.message) msg = payload.message;
                } catch { }
                Modal.show({
                    titleText: 'Error',
                    bodyText: msg,
                    kind: 'error',
                    confirmText: 'Aceptar'
                });
                return;
            }

            await loadVehiculos();

            Modal.show({
                titleText: 'Eliminado',
                bodyText: 'Vehículo eliminado correctamente.',
                kind: 'ok',
                confirmText: 'Aceptar'
            });
        } catch (err) {
            console.error(err);
            Modal.show({
                titleText: 'Error',
                bodyText: 'Error de conexión al eliminar el vehículo.',
                kind: 'error',
                confirmText: 'Aceptar'
            });
        }
    }

    // ===== Confirmar eliminación =====
    function confirmarEliminar(id) {
        Modal.confirm({
            titleText: '¿Eliminar vehículo?',
            bodyText: 'Esta acción no se puede revertir.',
            kind: 'warn',
            confirmText: 'Sí, eliminar',
            cancelText: 'Cancelar',
            onConfirmCb: async () => {
                await deleteVehiculo(id);
            }
        });
    }
    window.confirmarEliminar = confirmarEliminar;

    // ===== Carga principal =====
    async function loadVehiculos() {
        try {
            await Promise.all([loadUsuarios(), loadMarcas()]);

            const res = await fetch(VEHICULOS_URL, { credentials: 'include' });
            if (!res.ok) throw new Error(`Vehículos HTTP ${res.status}`);
            const data = await res.json();
            const list = Array.isArray(data) ? data
                       : Array.isArray(data?.data) ? data.data
                       : [];

            allRows = list
                .map(mapApiRow)
                .filter(r => r.id !== null && r.id !== undefined);

            currentPageVeh = 1;
            filteredRows = [...allRows];
            refreshVehiculosTable();
        } catch (err) {
            console.error(err);
            $tableBody.innerHTML = `<tr><td colspan="7">Error cargando datos.</td></tr>`;
            $badge.textContent = `Mostrando 0 de 0`;
            $pageInfoVeh.textContent = `0 / 0`;
            $prevPageItemVeh.classList.add('disabled');
            $nextPageItemVeh.classList.add('disabled');
        }
    }

    $search.addEventListener('input', () => {
        currentPageVeh = 1;
        refreshVehiculosTable();
    });

    $clear.addEventListener('click', () => {
        $search.value = '';
        currentPageVeh = 1;
        refreshVehiculosTable();
    });

    $export.addEventListener('click', exportCsv);

    // Eventos de paginación
    $pageSizeSelectVeh.addEventListener('change', () => {
        const val = Number($pageSizeSelectVeh.value);
        pageSizeVeh = PAGE_SIZES_VEH.includes(val) ? val : 5;
        currentPageVeh = 1;
        refreshVehiculosTable();
    });

    $prevPageBtnVeh.addEventListener('click', () => {
        if (currentPageVeh > 1) {
            currentPageVeh--;
            refreshVehiculosTable();
        }
    });

    $nextPageBtnVeh.addEventListener('click', () => {
        const total = filteredRows.length || allRows.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSizeVeh));
        if (currentPageVeh < totalPages) {
            currentPageVeh++;
            refreshVehiculosTable();
        }
    });

    // Carga inicial
    loadVehiculos();
</script>
