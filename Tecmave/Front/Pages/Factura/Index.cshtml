@page
@model Front.Pages.Factura.IndexModel
@{
    ViewData["Title"] = "Facturas";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<section class="section">
    <div class="container grid cols-1">
        <div class="card">
            <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                <h3 style="margin:0">Listado de Facturas</h3>

                <!-- 1) Acciones uno al lado del otro (sin wrap) -->
                <div class="fx-actions" style="display:flex;flex-wrap:nowrap;gap:.5rem;align-items:center;justify-content:flex-end;">
                    <button id="btnAbrirModalCrear" class="btn">Generar factura</button>
                </div>
            </div>

            <!-- FILTROS -->
            <div class="row g-3 align-items-end mt-3">
                <!-- Filtro por estado -->
                <div class="col-md-3">
                    <label for="filtroEstado" class="form-label">Filtrar por estado</label>
                    <select id="filtroEstado" class="form-select">
                        <option value="">(Todos)</option>
                        <option value="Pagada">Pagada</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Anulada">Anulada</option>
                    </select>
                </div>

                <!-- Buscar y Rango de Fechas -->
                <div class="col-md-5">
                    <div class="row g-3 align-items-end">
                        <div class="col-6">
                            <label for="filtroGlobal" class="form-label">Buscar</label>
                            <input id="filtroGlobal" class="form-control" placeholder="Buscar en todas las columnas‚Ä¶" />
                        </div>

                        <div class="col-6">
                            <label for="filtroRango" class="form-label">Rango de fechas</label>
                            <div class="cal-wrap">
                                <span class="cal-ico" aria-hidden="true">üìÖ</span>
                                <input id="filtroRango" class="form-control cal-input" placeholder="Seleccionar rango..." />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n LIMPIAR -->
                <div class="col-md-2" style="display:flex;align-items:flex-end;">
                    <button id="btnClearAll" class="btn btn-outline-secondary" type="button" style="width:100%;">Limpiar</button>
                </div>
            </div>


            <!-- Estado de carga -->
            <div id="estadoCarga" class="muted" style="margin: .75rem 0;">Cargando‚Ä¶</div>

            <!-- TABLA -->
            <div class="table-header">
                <div>
                    <!-- Controles de vista -->
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="d-flex align-items-center gap-2">
                            <label for="pageSizeSelectFact" class="form-label mb-0">Mostrar:</label>
                            <select id="pageSizeSelectFact" class="form-select form-select-sm" style="width:auto;">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-actions">
                    <button id="btnExportVista" class="icon-action" type="button" title="Exportar vista actual">
                        <img src="/assets/img/export.png" alt="Exportar" />
                    </button>

                    <button id="btnNotificarPendientes" class="icon-action" type="button" title="Notificar pendientes">
                        <img src="/assets/img/notification.png" alt="Notificar" />
                    </button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID </th>
                            <th>Cliente</th>
                            <th>Tel√©fono</th>
                            <th>Fecha emisi√≥n</th>
                            <th>M√©todo pago</th>
                            <th>Estado</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaFacturas"></tbody>
                </table>
            </div>

            <div class="subtle">
                <span id="badge"></span>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Factura Manual -->
    <div id="modalCrearFactura" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Generar factura manual</h4>
                <button class="close" data-close="modalCrearFactura">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="display:flex;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <label>Cliente</label>
                        <select id="crear_cliente" class="input"></select>
                    </div>
                    <div>
                        <label>M√©todo de pago</label>
                        <select id="crear_metodo" class="input">
                            <option>Efectivo</option>
                            <option>Tarjeta</option>
                            <option>Transferencia</option>
                            <option>Sin definir</option>
                        </select>
                    </div>
                    <div>
                        <label>Fecha</label>
                        <input id="crear_fecha" type="date" class="input" />
                    </div>
                    <div>
                        <label>Total</label>
                        <input id="crear_total" type="number" step="0.01" min="0" class="input" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCrearFactura" class="btn btn-primary">Crear</button>
                <button class="btn" data-close="modalCrearFactura">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Factura Autom√°tica desde Servicio -->
    <div id="modalAutoFactura" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Generar factura desde servicio</h4>
                <button class="close" data-close="modalAutoFactura">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="display:flex;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <label>Cliente</label>
                        <select id="auto_cliente" class="input"></select>
                    </div>
                    <div>
                        <label>Servicio</label>
                        <select id="auto_servicio" class="input"></select>
                    </div>
                    <div>
                        <label>M√©todo de pago</label>
                        <select id="auto_metodo" class="input">
                            <option>Efectivo</option>
                            <option>Tarjeta</option>
                            <option>Transferencia</option>
                            <option>Sin definir</option>
                        </select>
                    </div>
                </div>
                <p class="subtle">El total se tomar√° del precio del servicio seleccionado.</p>
            </div>
            <div class="modal-footer">
                <button id="btnCrearAuto" class="btn btn-primary">Generar</button>
                <button class="btn" data-close="modalAutoFactura">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal peque√±o para cambiar estado -->
    <div id="modalEstado" class="modal" aria-hidden="true">
        <div class="modal__backdrop"></div>
        <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modalEstadoTitulo">
            <div class="modal__header">
                <h4 id="modalEstadoTitulo" style="margin:0">Cambiar estado</h4>
                <button type="button" class="modal__close" id="btnCloseModal" aria-label="Cerrar">√ó</button>
            </div>
            <div class="modal__body">
                <div class="form-row" style="display:flex;flex-direction:column;gap:.35rem;">
                    <label for="ddlEstado">Estado</label>
                    <select id="ddlEstado" class="input">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Pagada">Pagada</option>
                        <option value="Anulada">Anulada</option>
                    </select>
                </div>
            </div>
            <div class="modal__footer">
                <button id="btnGuardarEstado" class="primary">Guardar</button>
                <button id="btnCancelarEstado" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>
</section>

<style>
    body, .table, .table td, .table th, .card, .muted {
        color: #333;
    }

    .table-wrapper {
        overflow: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

        .table th {
            background: #f5f5f5;
        }

        .table th, .table td {
            padding: 8px 10px;
            border: 1px solid #e6e6e6;
        }

    .badge {
        padding: .15rem .5rem;
        border-radius: 10px;
        font-size: .85rem;
        border: 1px solid #ddd
    }

        .badge.badge--pendiente {
            background: #fff6e6;
            border-color: #ffd699
        }

        .badge.badge--pagada {
            background: #eaffea;
            border-color: #a8f0b0
        }

        .badge.badge--anulada {
            background: #ffecec;
            border-color: #ffb8b8
        }

    .btn {
        padding: .35rem .65rem;
        border: 1px solid #ccc;
        background: #fafafa;
        cursor: pointer;
        border-radius: 6px;
        font-size: .9rem;
    }

    .btn-primary {
        background: #3b82f6;
        border-color: #2f6fda;
        color: #fff;
    }

    .btn-secondary {
        background: #f2f2f2;
        border-color: #d9d9d9;
    }

    .btn.danger {
        color: #fff;
        background: #d9534f;
        border-color: #c9302c
    }

    .btn:disabled {
        opacity: .6;
        cursor: not-allowed
    }

    .secondary {
        padding: .4rem .7rem;
        background: #f2f2f2;
        border: 1px solid #d9d9d9;
        cursor: pointer
    }

    .primary {
        padding: .4rem .7rem;
        background: #3b82f6;
        color: #fff;
        border: 1px solid #2f6fda;
        cursor: pointer
    }

    .card {
        background: #fff;
        border: 1px solid #e9e9e9;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0,0,0,.03)
    }

    .container {
        max-width: 1100px;
        margin: 0 auto;
    }

    .muted {
        color: #666;
        font-size: .9rem
    }

    .subtle {
        margin-top: .75rem;
        font-size: .85rem;
        color: #666;
    }

    .input {
        width: 100%;
        padding: .45rem .55rem;
        border: 1px solid #d9d9d9;
        border-radius: 8px;
    }

    .hidden {
        display: none !important;
    }

    .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }

    .modal-content {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e9e9e9;
        box-shadow: 0 10px 30px rgba(0,0,0,.2);
        width: 420px;
        max-width: 95vw;
    }

    .modal-header, .modal-footer {
        padding: 12px 14px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between
    }

    .modal-footer {
        border-top: 1px solid #eee;
        border-bottom: none
    }

    .modal-body {
        padding: 12px 14px
    }

    .close {
        background: transparent;
        border: none;
        font-size: 20px;
        line-height: 1;
        cursor: pointer
    }

    .modal__backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.35);
    }

    .modal__dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        width: 360px;
        max-width: 90vw;
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e9e9e9;
        box-shadow: 0 10px 30px rgba(0,0,0,.2)
    }

    .modal__header, .modal__footer {
        padding: 12px 14px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between
    }

    .modal__footer {
        border-top: 1px solid #eee;
        border-bottom: none
    }

    .modal__body {
        padding: 12px 14px
    }

    .modal__close {
        background: transparent;
        border: none;
        font-size: 20px;
        line-height: 1;
        cursor: pointer
    }

    /* Filtros alineados uno al lado del otro */
    .row.g-3 {
        display: flex;
        flex-wrap: wrap;
        gap: 12px; /* Espaciado entre filtros */
    }

    .col-md-3, .col-md-5, .col-md-2 {
        margin-bottom: 1rem;
    }

    /* 4) Mini calendario como "hint" dentro del input */
    .cal-wrap {
        position: relative;
    }

    .cal-ico {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        opacity: 0.7;
        pointer-events: none;
    }

    .cal-input {
        padding-left: 34px;
    }

    /* 5) Limpiar todos los filtros con un solo bot√≥n */
    #btnClearAll {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px; /* Separaci√≥n entre la cabecera y la tabla */
    }

    .table-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end; /* Asegura que los botones est√©n a la derecha */
        width: 200px; /* Limita el ancho de la caja de botones para no ocupar todo el espacio */
    }

    button.icon-action {
        background: transparent !important;
        border: 0 !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
        border-radius: 0 !important;
        outline: none !important;
    }

        button.icon-action:hover,
        button.icon-action:focus,
        button.icon-action:active {
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
        }

        /* Tama√±o del √≠cono */
        button.icon-action img {
            width: 25px;
            height: 25px;
            display: block;
        }



    /* 4) Mini calendario como ‚Äúhint‚Äù dentro del input */
    .cal-wrap {
        position: relative;
        width: 100%;
    }

    .cal-ico {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        opacity: .7;
        pointer-events: none;
    }

    .cal-input {
        padding-left: 34px;
    }

    .icon-action {
        all: unset;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

        .icon-action img {
            width: 30px;
            height: 30px;
            display: block;
        }
    /* ===== FIX FLATPICKR HEADER ===== */
    .flatpickr-calendar {
        z-index: 9999;
    }

    .flatpickr-months {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 8px;
    }

    .flatpickr-month {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        height: 34px;
    }

    .flatpickr-prev-month,
    .flatpickr-next-month {
        position: static;
        height: 28px;
        padding: 4px;
    }

    .flatpickr-current-month {
        display: flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
    }

    /* Mes */
    .flatpickr-monthDropdown-months {
        font-size: 13px;
        padding: 2px 6px;
        height: 26px;
    }

    /* A√±o */
    .flatpickr-current-month input.cur-year {
        font-size: 13px;
        height: 26px;
        padding: 2px 6px;
    }

    /* Evita que el calendario se tape */
    .flatpickr-innerContainer {
        padding-top: 4px;
    }
    /* ===== FLATPICKR COMPACT FIX (MES / A√ëO) ===== */

    .flatpickr-calendar {
        font-size: 13px;
    }

    .flatpickr-months {
        display: flex;
        align-items: center;
        height: 36px;
        padding: 4px 6px;
    }

    .flatpickr-month {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        height: 28px;
    }

    /* Flechas */
    .flatpickr-prev-month,
    .flatpickr-next-month {
        position: static;
        padding: 0 6px;
        height: 24px;
        line-height: 24px;
    }

    /* Contenedor mes + a√±o */
    .flatpickr-current-month {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 0;
        height: 24px;
    }

    /* SELECT del mes */
    .flatpickr-monthDropdown-months {
        font-size: 12px;
        height: 22px;
        padding: 0 4px;
        border-radius: 4px;
    }

    /* INPUT del a√±o */
    .flatpickr-current-month input.cur-year {
        font-size: 12px;
        height: 22px;
        padding: 0 4px;
        border-radius: 4px;
    }

    /* Evita que el calendario se corte */
    .flatpickr-innerContainer {
        padding-top: 6px;
    }

    /* Quita m√°rgenes raros */
    .flatpickr-weekdays,
    .flatpickr-days {
        margin-top: 2px;
    }

    /* ===== FLATPICKR: MES Y A√ëO MISMO TAMA√ëO ===== */
    .flatpickr-monthDropdown-months,
    .flatpickr-current-month input.cur-year {
        font-size: 12px !important;
        height: 22px !important;
        line-height: 22px !important;
        padding: 0 4px !important;
        border-radius: 4px;
    }

</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

    <script>
        const API_FACTURAS  = "https://tecmave-api.azurewebsites.net/facturas";
        const API_USUARIOS  = "https://tecmave-api.azurewebsites.net/api/usuarios";
        const API_SERVICIOS = "https://tecmave-api.azurewebsites.net/servicios";

        let FACTURAS = [];
        let USUARIOS = [];
        let SERVICIOS = [];
        let facturaSeleccionada = null;

        let pageSizeFact = 10;
        let currentPageFact = 1;


        let rangeStart = null;
        let rangeEnd = null;
        let fpRange = null;

        function debounce(fn, d = 200) {
            let t;
            return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); };
        }

        function badgeEstado(est) {
            const e = (est || '').toLowerCase();
            if (e === 'pagada') return '<span class="badge badge--pagada">Pagada</span>';
            if (e === 'anulada') return '<span class="badge badge--anulada">Anulada</span>';
            return '<span class="badge badge--pendiente">Pendiente</span>';
        }

        function nombreClientePorId(id) {
            if (id == null) return '';
            const u = USUARIOS.find(x => Number(x.id) === Number(id) || Number(x.Id) === Number(id));
            if (!u) return String(id ?? '');

            const nombre = (u.nombre || u.Nombre || '').toString().trim();
            const ap = (u.apellidos || u.Apellidos || u.apellido || u.Apellido || '').toString().trim();
            return (nombre + ' ' + ap).trim() || String(u.email || u.Email || id || '');
        }

        function correoClientePorId(id) {
            const u = USUARIOS.find(x => Number(x.id) === Number(id) || Number(x.Id) === Number(id));
            return (u?.email || u?.Email || u?.user_name || u?.UserName || '') ?? '';
        }

        function telefonoClientePorId(id) {
            const u = USUARIOS.find(x => Number(x.id) === Number(id) || Number(x.Id) === Number(id));
            return (u?.phone_number || u?.PhoneNumber || '') ?? '';
        }

        function formatCRC(n) {
            const v = Number(n || 0);
            return v.toLocaleString('es-CR', { style: 'currency', currency: 'CRC', maximumFractionDigits: 0 });
        }

        function safeFecha(v) {
            if (!v) return '';
            const d = new Date(v);
            return isNaN(d) ? v : d.toLocaleString();
        }

        function parseDateOnly(v) {
            if (!v) return null;
            const d = new Date(v);
            if (isNaN(d)) return null;
            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        }

        function getSearchText() {
            return ($("#filtroGlobal").val() || "").toString().toLowerCase().trim();
        }

        function cargarTodo() {
            $("#estadoCarga").text("Cargando‚Ä¶");

            const pFact = $.ajax({ url: API_FACTURAS, method: "GET" });
            const pUsers = $.ajax({ url: API_USUARIOS, method: "GET" });

            $.when(pFact, pUsers)
                .done((r1, r2) => {
                    const factData = r1[0];
                    const userData = r2[0];

                    FACTURAS = Array.isArray(factData) ? factData : (factData ? [factData] : []);
                    USUARIOS = Array.isArray(userData) ? userData : (userData ? [userData] : []);

                    llenarCombosClientes();
                    renderTabla();
                    $("#estadoCarga").text(FACTURAS.length ? "Facturas cargadas correctamente" : "No hay facturas.");
                    cargarServicios();
                })
                .fail(function (xhr, textStatus, errorThrown) {
                    console.error("Error al cargar (cuando):", xhr?.status, textStatus, errorThrown, xhr?.responseText);

                    pFact.done(function (factData) {
                        FACTURAS = Array.isArray(factData) ? factData : (factData ? [factData] : []);
                        USUARIOS = [];
                        llenarCombosClientes();
                        renderTabla();
                        $("#estadoCarga").text(FACTURAS.length ? "Facturas cargadas correctamente (sin usuarios)" : "No hay facturas.");
                        cargarServicios();
                    }).fail(function (x2, t2, e2) {
                        console.error("FACTURAS tambi√©n fall√≥:", x2?.status, t2, e2, x2?.responseText);
                        $("#estadoCarga").text("No se pudieron cargar los datos.");
                    });
                });
        }

        function cargarServicios() {
            $.ajax({ url: API_SERVICIOS, method: "GET" })
                .done(function (data) {
                    SERVICIOS = Array.isArray(data) ? data : (data ? [data] : []);
                    const $sel = $("#auto_servicio");
                    $sel.empty();

                    if (!SERVICIOS.length) {
                        $sel.append('<option value="">(No hay servicios)</option>');
                        return;
                    }

                    SERVICIOS.forEach(s => {
                        const id = s.id_servicio ?? s.id ?? s.Id;
                        const nombre = (s.nombre || s.Nombre || s.descripcion || s.Descripcion || `Servicio ${id}`).toString();
                        $sel.append(`<option value="${id}">${nombre}</option>`);
                    });
                })
                .fail(function (xhr) {
                    console.error("Error al cargar servicios:", xhr?.status, xhr?.responseText);
                    const $sel = $("#auto_servicio");
                    $sel.empty().append('<option value="">(Error al cargar servicios)</option>');
                });
        }

        function llenarCombosClientes() {
            const $crear = $("#crear_cliente");
            const $auto = $("#auto_cliente");

            $crear.empty();
            $auto.empty();

            USUARIOS.forEach(u => {
                const id = u.id ?? u.Id;
                const nombre = nombreClientePorId(id);
                const opt = `<option value="${id}">${nombre}</option>`;
                $crear.append(opt);
                $auto.append(opt);
            });
        }

        function pasaFiltros(f) {
            const q = getSearchText();
            const estadoFiltro = ($("#filtroEstado").val() || "").toString();

            const id = f.id_factura ?? f.id ?? f.Id;
            const clienteId = f.cliente_id ?? f.ClienteId ?? f.clienteId;

            const cliente = nombreClientePorId(clienteId);
            const correo = correoClientePorId(clienteId);
            const tel = telefonoClientePorId(clienteId);

            const fechaVal = f.fecha_emision ?? f.fechaEmision ?? f.FechaEmision;
            const fechaTxt = safeFecha(fechaVal);
            const fecha = parseDateOnly(fechaVal);

            const metodo = (f.metodo_pago ?? f.metodoPago ?? f.MetodoPago ?? '').toString();
            const estado = (f.estado_pago ?? f.estado ?? f.Estado ?? 'Pendiente').toString();
            const total = formatCRC(f.total ?? f.Total ?? 0);

            if (estadoFiltro && estado !== estadoFiltro) return false;

            if (rangeStart || rangeEnd) {
                if (!fecha) return false;
                if (rangeStart && fecha < rangeStart) return false;
                if (rangeEnd && fecha > rangeEnd) return false;
            }

            if (q) {
                const haystack = [id, cliente, correo, tel, fechaTxt, metodo, estado, total].join(' ').toLowerCase();
                if (!haystack.includes(q)) return false;
            }

            return true;
        }

        function renderTabla() {
            const $tb = $("#tablaFacturas");
            $tb.empty();

            const filtradas = FACTURAS.filter(pasaFiltros);
            const total = filtradas.length;

            if (!total) {
                $tb.append(`<tr><td colspan="8">Sin resultados</td></tr>`);
                $("#badge").text(`0 factura(s) mostradas`);
                return;
            }

            const totalPages = Math.max(1, Math.ceil(total / pageSizeFact));
            if (currentPageFact > totalPages) currentPageFact = totalPages;

            const start = (currentPageFact - 1) * pageSizeFact;
            const end = Math.min(start + pageSizeFact, total);

            const lista = filtradas.slice(start, end);

            lista.forEach(f => {
                const id = f.id_factura ?? f.id ?? f.Id;
                const clienteId = f.cliente_id ?? f.ClienteId ?? f.clienteId;
                const cliente = nombreClientePorId(clienteId);
                const tel = telefonoClientePorId(clienteId);
                const fecha = safeFecha(f.fecha_emision ?? f.fechaEmision ?? f.FechaEmision);
                const metodo = f.metodo_pago ?? f.metodoPago ?? f.MetodoPago ?? '';
                const estado = f.estado_pago ?? f.estado ?? f.Estado ?? 'Pendiente';
                const totalMonto = f.total ?? f.Total ?? 0;

                const fila = `
                    <tr>
                        <td>${id ?? ''}</td>
                        <td>${cliente ?? 'Eliminado'}</td>
                        <td>${tel ?? 'Eliminado'}</td>
                        <td>${fecha}</td>
                        <td>${metodo}</td>
                        <td>${badgeEstado(estado)}</td>
                        <td>${formatCRC(totalMonto)}</td>
                        <td>
                            <button class="btn danger btn-estado" data-id="${id}" data-estado="${estado}">Estado</button>
                            <button class="btn btn-secondary btn-enviar" data-id="${id}">Enviar</button>
                        </td>
                    </tr>`;
                $tb.append(fila);
            });

            $("#badge").text(`Mostrando ${start + 1}-${end} de ${total}`);
        }

        function abrirModal(id) {
            const $m = $("#" + id);
            $m.removeClass("hidden").css("display", "flex");
        }

        function cerrarModalId(id) {
            const $m = $("#" + id);
            $m.addClass("hidden").hide();
        }

        function abrirModalEstado(idFactura, estadoActual) {
            facturaSeleccionada = { id: idFactura };
            $("#ddlEstado").val(estadoActual || "Pendiente");
            $("#modalEstado").css("display", "block").attr("aria-hidden", "false");
        }

        function cerrarModalEstado() {
            facturaSeleccionada = null;
            $("#modalEstado").css("display", "none").attr("aria-hidden", "true");
        }

        function guardarEstado() {
            if (!facturaSeleccionada?.id) return;
            const nuevo = $("#ddlEstado").val();
            const url = `${API_FACTURAS}/${facturaSeleccionada.id}/estado`;

            $.ajax({
                url: url,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ estado: nuevo }),
                success: function () {
                    FACTURAS = FACTURAS.map(x => {
                        const xid = x.id_factura ?? x.id ?? x.Id;
                        if (Number(xid) === Number(facturaSeleccionada.id)) return { ...x, estado_pago: nuevo };
                        return x;
                    });
                    renderTabla();
                    cerrarModalEstado();
                },
                error: function (xhr) {
                    console.error("Error al actualizar estado", xhr?.status, xhr?.responseText);
                    alert("No se pudo actualizar el estado.");
                }
            });
        }

        function enviarFacturaEmail(idFactura) {
            const url = `${API_FACTURAS}/${idFactura}/enviar-email`;

            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                success: function () { alert(`Factura enviada al correo del cliente.`); },
                error: function (xhr) {
                    console.error("Error al enviar factura por correo", xhr?.status, xhr?.responseText);
                    alert("No se pudo enviar la factura por correo.");
                }
            });
        }

        function crearFacturaManual() {
            const clienteId = Number($("#crear_cliente").val());
            const metodo = $("#crear_metodo").val();
            const fecha = $("#crear_fecha").val();
            const total = Number($("#crear_total").val());

            if (!clienteId || total <= 0) { alert("Debe seleccionar un cliente y un total mayor a 0."); return; }

            const body = {
                cliente_id: clienteId,
                fecha_emision: fecha ? new Date(fecha).toISOString() : null,
                total: total,
                metodo_pago: metodo,
                estado_pago: "Pendiente"
            };

            $.ajax({
                url: API_FACTURAS,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(body),
                success: function (created) {
                    FACTURAS.push(created);
                    renderTabla();
                    cerrarModalId("modalCrearFactura");
                    $("#crear_total").val("");
                    $("#crear_fecha").val("");
                    alert("Factura creada correctamente.");
                },
                error: function (xhr) {
                    console.error("Error al crear factura", xhr?.status, xhr?.responseText);
                    alert("No se pudo crear la factura. Verifique los datos.");
                }
            });
        }

        function crearFacturaAuto() {
            const clienteId = Number($("#auto_cliente").val());
            const servicioId = Number($("#auto_servicio").val());
            const metodo = $("#auto_metodo").val();

            if (!clienteId || !servicioId) { alert("Debe seleccionar un cliente y un servicio."); return; }

            const body = { cliente_id: clienteId, servicio_id: servicioId, metodo_pago: metodo };

            $.ajax({
                url: `${API_FACTURAS}/generar-automatico`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(body),
                success: function (created) {
                    FACTURAS.push(created);
                    renderTabla();
                    cerrarModalId("modalAutoFactura");
                    alert("Factura generada desde servicio correctamente.");
                },
                error: function (xhr) {
                    console.error("Error al generar factura autom√°tica", xhr?.status, xhr?.responseText);
                    alert("No se pudo generar la factura desde servicio.");
                }
            });
        }

        function exportarPdf(facturas) {
            try {
                const doc = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });
                doc.setFontSize(14);
                doc.text('Listado de Facturas', 40, 40);

                const body = facturas.map(f => {
                    const id = f.id_factura ?? f.id ?? f.Id;
                    const clienteId = f.cliente_id ?? f.ClienteId ?? f.clienteId;
                    const cliente = nombreClientePorId(clienteId);
                    const fecha = safeFecha(f.fecha_emision ?? f.fechaEmision ?? f.FechaEmision);
                    const total = formatCRC(f.total ?? f.Total ?? 0);
                    const estado = (f.estado_pago ?? f.estado ?? f.Estado ?? '').toString();
                    const metodo = (f.metodo_pago ?? f.metodoPago ?? f.MetodoPago ?? '').toString();
                    return [id, fecha, cliente, total, metodo, estado];
                });

                doc.autoTable({
                    head: [['Id', 'Fecha', 'Cliente', 'Total', 'M√©todo', 'Estado']],
                    body,
                    startY: 70,
                    styles: { fontSize: 9 }
                });

                const name = `facturas_vista_${new Date().toISOString().replace(/[:.]/g, '-')}.pdf`;
                doc.save(name);
            } catch (e) {
                console.error(e);
                alert("No se pudo generar el PDF.");
            }
        }

        function exportarVistaActualPdf() {
            const listaFiltrada = FACTURAS.filter(pasaFiltros);
            if (!listaFiltrada.length) { alert("No hay facturas para exportar con los filtros actuales."); return; }
            exportarPdf(listaFiltrada);
        }

        async function notificarPendientesVistaActual() {
            const visibles = FACTURAS.filter(pasaFiltros);
            const pendientes = visibles.filter(f => {
                const est = (f.estado_pago ?? f.estado ?? f.Estado ?? '').toString().toLowerCase();
                return est === "pendiente";
            });

            if (!pendientes.length) { alert("No hay facturas pendientes en la vista actual."); return; }

            const $btn = $("#btnNotificarPendientes");
            $btn.prop("disabled", true).text("Notificando...");

            let ok = 0, err = 0;

            for (const f of pendientes) {
                const id = f.id_factura ?? f.id ?? f.Id;
                try {
                    await $.ajax({
                        url: `${API_FACTURAS}/${id}/enviar-email`,
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({})
                    });
                    ok++;
                } catch (e) {
                    err++;
                    console.error("Fallo notificando factura:", id, e);
                }
            }

            $btn.prop("disabled", false).text("Notificar pendientes");
            alert(`Notificaciones enviadas: ${ok}\nErrores: ${err}\nTotal pendientes: ${pendientes.length}`);
        }

        function initRangePicker() {
            const el = document.getElementById('filtroRango');
            if (!el) return;

            fpRange = flatpickr(el, {
                mode: "range",
                dateFormat: "Y-m-d",
                allowInput: false,
                showMonths: 1,
                onClose: function (selectedDates) {
                    if (!selectedDates || !selectedDates.length) {
                        rangeStart = null;
                        rangeEnd = null;
                        renderTabla();
                        return;
                    }

                    const d1 = selectedDates[0]
                        ? new Date(selectedDates[0].getFullYear(), selectedDates[0].getMonth(), selectedDates[0].getDate())
                        : null;

                    const d2raw = selectedDates[1] || selectedDates[0];
                    const d2 = d2raw
                        ? new Date(d2raw.getFullYear(), d2raw.getMonth(), d2raw.getDate())
                        : null;

                    if (d1 && d2 && d2 < d1) { rangeStart = d2; rangeEnd = d1; }
                    else { rangeStart = d1; rangeEnd = d2; }
                    currentPageFact = 1;

                    renderTabla();
                }
            });
        }

        function clearAllFilters() {
            $("#filtroEstado").val("");
            $("#filtroGlobal").val("");
            currentPageFact = 1;

            rangeStart = null;
            rangeEnd = null;

            if (fpRange) fpRange.clear();
            $("#filtroRango").val("");

            renderTabla();
            $("#filtroGlobal").focus();
        }

        // ===== EVENTOS =====
        $(document).on("click", ".btn-estado", function () {
            const id = $(this).data("id");
            const est = $(this).data("estado");
            abrirModalEstado(id, est);
        });

        $(document).on("click", ".btn-enviar", function () {
            const id = $(this).data("id");
            enviarFacturaEmail(id);
        });

        $("#btnGuardarEstado").on("click", guardarEstado);
        $("#btnCancelarEstado, #btnCloseModal, .modal__backdrop").on("click", cerrarModalEstado);

        $("#btnAbrirModalCrear").on("click", function () { abrirModal("modalCrearFactura"); });
        $("#btnAbrirModalAuto").on("click", function () { abrirModal("modalAutoFactura"); });

        $("[data-close]").on("click", function () {
            const id = $(this).data("close");
            cerrarModalId(id);
        });

        $("#btnCrearFactura").on("click", crearFacturaManual);
        $("#btnCrearAuto").on("click", crearFacturaAuto);

        $("#btnExportVista").on("click", exportarVistaActualPdf);
        $("#btnNotificarPendientes").on("click", notificarPendientesVistaActual);

        const refreshDebounced = debounce(() => renderTabla(), 180);

        $("#filtroEstado").on("change", function () {
            currentPageFact = 1;
            renderTabla();
        });

        $("#filtroGlobal").on("input", function () {
            currentPageFact = 1;
            refreshDebounced();
        });
        $("#filtroGlobal").on("keydown", function (e) { if (e.key === "Enter") { e.preventDefault(); e.currentTarget.blur(); } });

        $("#btnClearAll").on("click", clearAllFilters);

                $("#pageSizeSelectFact").on("change", function () {
            pageSizeFact = Number(this.value) || 10;
            currentPageFact = 1;
            renderTabla();
        });


        $(document).ready(function () {
            initRangePicker();
            cargarTodo();
        });
    </script>
}
