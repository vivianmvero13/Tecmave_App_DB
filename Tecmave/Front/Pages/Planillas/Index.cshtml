@page
@model Front.Pages.Planillas.IndexModel
@{
    ViewData["Title"] = "Planillas";
}

<section class="section">
    <div class="container grid cols-2">

        <!-- FORM NUEVA PLANILLA / EDITAR -->
        <div class="card">
            <h3 id="tituloForm">Nueva Planilla</h3>

            <div class="form-row">
                <div>
                    <label>Colaborador</label>
                    <select class="input" id="colaborador_id"></select>
                </div>

                <div>
                    <label>Periodo Inicio</label>
                    <input class="input" id="periodo_inicio" type="date" />
                </div>

                <div>
                    <label>Periodo Fin</label>
                    <input class="input" id="periodo_fin" type="date" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Horas Trabajadas</label>
                    <input class="input" id="horas_trabajadas" type="number" step="0.01" />
                    <button type="button" onclick="setHorasSemana()">Todas las horas de la semana</button>
                </div>
                <div>
                    <label>Valor Hora</label>
                    <input class="input" id="valor_hora" type="number" step="0.01" readonly />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Deducciones</label>
                    <input class="input" id="deducciones" type="number" step="0.01" />
                </div>
                <div>
                    <label>Estado</label>
                    <select class="input" id="estado">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Observaciones</label>
                    <input class="input" id="observaciones" type="text" />
                </div>
            </div>

            <button id="btnAgregarPlanilla" type="button">Agregar</button>
        </div>


        <!-- TABLA PLANILLAS -->
        <div class="card">
            <h3>Lista de Planillas</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Colaborador</th>
                        <th>Periodo</th>
                        <th>Neto Pagar</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</section>


<script>

    const API_PLANILLA     = "https://tecmave-api.azurewebsites.net/api/Planillas";
    const API_COLABORADOR  = "https://tecmave-api.azurewebsites.net/Colaboradores";
    const API_USUARIOS     = "https://tecmave-api.azurewebsites.net/api/usuarios";

    let cacheColaboradores = {};
    let cacheUsuarios = {};
    let editId = null;

    // 1. Cargar usuarios
    function cargarUsuarios() {
        return $.get(API_USUARIOS, function (usuarios) {
            usuarios.forEach(u => cacheUsuarios[u.id] = u);
        });
    }

    // 2. Cargar colaboradores
    function cargarColaboradores() {
        return $.get(API_COLABORADOR, function (colab) {
            $("#colaborador_id").empty().append(`<option value="">Seleccione un colaborador</option>`);

            colab.forEach(c => {
                cacheColaboradores[c.id_colaborador] = c;
                const usuario = cacheUsuarios[c.id_usuario];

                $("#colaborador_id").append(`
                    <option value="${c.id_colaborador}">
                        ${usuario ? usuario.nombre + " " + usuario.apellidos : "Usuario desconocido"}
                    </option>
                `);
            });
        });
    }

    // Autocompletar valor hora
    $("#colaborador_id").on("change", function () {
        const id = $(this).val();
        if (!id) return;

        const colab = cacheColaboradores[id];
        if (!colab) return;

        $("#valor_hora").val(colab.salario);
    });

    function setHorasSemana() {
        $("#horas_trabajadas").val(40);
    }

    // 3. Cargar planillas
    function cargarPlanillas() {
        $.get(API_PLANILLA, function (data) {

            window.planillas = data;
            $("table tbody").empty();

            data.forEach(p => {
                const colab = cacheColaboradores[p.colaborador_id];
                const usuario = colab ? cacheUsuarios[colab.id_usuario] : null;

                $("table tbody").append(`
                    <tr>
                        <td>${p.id}</td>
                        <td>${usuario ? usuario.nombre + " " + usuario.apellidos : "Desconocido"}</td>
                        <td>${p.periodo_inicio} – ${p.periodo_fin}</td>
                        <td>${p.neto_pagar}</td>
                        <td>${p.estado}</td>

                        <td>
                            <button onclick="editarPlanilla(${p.id})">Editar</button>
                            <button class="danger" onclick="eliminarPlanilla(${p.id})">Eliminar</button>
                        </td>
                    </tr>
                `);
            });
        });
    }

    function eliminarPlanilla(id) {
        if (!confirm("¿Seguro que quieres eliminar esta planilla?")) return;

        $.ajax({
            url: `${API_PLANILLA}?id=${id}`,
            method: "DELETE",
            success: function () {
                alert("Planilla eliminada");
                cargarPlanillas();
            }
        });
    }

    // 4. Agregar / Editar planilla
    function agregarPlanilla() {

        const obj = {
            colaborador_id: parseInt($("#colaborador_id").val()),
            periodo_inicio: $("#periodo_inicio").val(),
            periodo_fin: $("#periodo_fin").val(),
            horas_trabajadas: parseFloat($("#horas_trabajadas").val()),
            valor_hora: parseFloat($("#valor_hora").val()),
            deducciones: parseFloat($("#deducciones").val()),
            fecha_generada: new Date(),
            estado: $("#estado").val(),
            observaciones: $("#observaciones").val()
        };

        obj.total_salario = obj.horas_trabajadas * obj.valor_hora;
        obj.neto_pagar = obj.total_salario - obj.deducciones;

        const method = editId ? "PUT" : "POST";
        const url = editId ? `${API_PLANILLA}?id=${editId}` : API_PLANILLA;

        $.ajax({
            url,
            method,
            contentType: "application/json",
            data: JSON.stringify(obj),
            success: function () {
                alert(editId ? "Planilla actualizada" : "Planilla creada");

                editId = null;
                $("#btnAgregarPlanilla").text("Agregar");
                $("#tituloForm").text("Nueva Planilla");
                limpiarForm();
                cargarPlanillas();
            }
        });
    }

    function editarPlanilla(id) {
        const p = window.planillas.find(x => x.id === id);
        editId = id;

        $("#colaborador_id").val(p.colaborador_id);
        $("#periodo_inicio").val(p.periodo_inicio);
        $("#periodo_fin").val(p.periodo_fin);
        $("#horas_trabajadas").val(p.horas_trabajadas);
        $("#valor_hora").val(p.valor_hora);
        $("#deducciones").val(p.deducciones);
        $("#estado").val(p.estado);
        $("#observaciones").val(p.observaciones);

        $("#btnAgregarPlanilla").text("Actualizar");
        $("#tituloForm").text("Editar Planilla");
    }

    function limpiarForm(){
        $("#colaborador_id").val("");
        $("#periodo_inicio").val("");
        $("#periodo_fin").val("");
        $("#horas_trabajadas").val("");
        $("#valor_hora").val("");
        $("#deducciones").val("");
        $("#estado").val("Pendiente");
        $("#observaciones").val("");
    }

    // 5 Inicializar
    $(document).ready(function () {

        cargarUsuarios()
            .then(() => cargarColaboradores())
            .then(() => cargarPlanillas());

        $("#btnAgregarPlanilla").on("click", agregarPlanilla);
    });

</script>
