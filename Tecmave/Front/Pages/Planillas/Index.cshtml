@page
@model Front.Pages.Planillas.IndexModel
@{
    ViewData["Title"] = "Planillas";
}

<section class="section">
    <div class="container">

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3>Lista de Planillas</h3>
                <a href="/Planillas/Crear" class="btn primary">
                    Nueva Planilla
                </a>
            </div>

            <div class="form-row mb-2">
                <div>
                    <label>Buscar colaborador</label>
                    <input id="filtroNombre"
                           class="input"
                           placeholder="Nombre o apellido" />
                </div>
            </div>

            <div class="table-responsive mt-2">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Colaborador</th>
                            <th>Periodo</th>
                            <th>Neto Pagar</th>
                            <th>Estado</th>
                            <th style="width:200px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>

    </div>
</section>

<script>
    const API_PLANILLA = "http://localhost:7096/api/Planillas";
    const API_USUARIOS = "http://localhost:7096/api/usuarios";
    const API_COLABORADOR = "http://localhost:7096/Colaboradores";

    let cacheUsuarios = {};
    let cacheColaboradores = {};
    let todasLasPlanillas = [];

    $(document).ready(function () {
        $("#filtroNombre").on("input", aplicarFiltroNombre);
        cargarUsuarios()
            .then(() => cargarColaboradores())
            .then(() => cargarPlanillas());
    });

    function cargarUsuarios() {
        return $.get(API_USUARIOS, function (usuarios) {
            usuarios.forEach(u => {
                const key = u.id ?? u.id_usuario;
                cacheUsuarios[key] = u;
            });
        });
    }

    function cargarColaboradores() {
        return $.get(API_COLABORADOR, function (colabs) {
            colabs.forEach(c => {
                cacheColaboradores[c.id_colaborador] = c;
            });
        });
    }

    function cargarPlanillas() {
        $.get(API_PLANILLA, function (data) {
            todasLasPlanillas = data;
            $("table tbody").empty();

            data.forEach(p => {
                const col = cacheColaboradores[p.colaborador_id];
                let nombre = "Desconocido";

                if (col) {
                    const user = cacheUsuarios[col.id_usuario];
                    if (user) {
                        const ap = user.apellidos ?? user.apellido ?? "";
                        nombre = `${user.nombre} ${ap}`.trim();
                    }
                }

                $("table tbody").append(`
                    <tr>
                        <td>${p.id}</td>
                        <td>${nombre}</td>
                        <td>${p.periodo_inicio} – ${p.periodo_fin}</td>
                        <td>${p.neto_pagar}</td>
                        <td>${p.estado}</td>
                        <td>
                            <a href="/Planillas/Editar/${p.id}" class="btn btn-sm btn-secondary">
                                Editar
                            </a>
                            <button class="btn danger" onclick="eliminarPlanilla(${p.id})">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `);
            });
        });
    }

        function renderTabla(planillas) {
        $("table tbody").empty();

        if (!planillas.length) {
            $("table tbody").append(`
                <tr>
                    <td colspan="6">No hay resultados</td>
                </tr>
            `);
            return;
        }

        planillas.forEach(p => {
            const colaborador = cacheColaboradores[p.colaborador_id];
            let nombreUsuario = "Desconocido";

            if (colaborador) {
                const userKey = colaborador.id_usuario;
                const usuario = cacheUsuarios[userKey];
                if (usuario) {
                    const apellidos = usuario.apellidos ?? usuario.apellido ?? "";
                    nombreUsuario = `${usuario.nombre} ${apellidos}`.trim();
                }
            }

            $("table tbody").append(`
                <tr>
                    <td>${p.id}</td>
                    <td>${nombreUsuario}</td>
                    <td>${p.periodo_inicio} – ${p.periodo_fin}</td>
                    <td>${p.neto_pagar}</td>
                    <td>${p.estado}</td>
                    <td>
                        <a href="/Planillas/Editar/${p.id}" class="btn btn-sm btn-secondary">
                            Editar
                        </a>
                        <button class="btn danger" onclick="eliminarPlanilla(${p.id})">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `);
        });
    }

        function aplicarFiltroNombre() {
        const texto = $("#filtroNombre").val().toLowerCase();

        if (!texto) {
            renderTabla(todasLasPlanillas);
            return;
        }

        const filtradas = todasLasPlanillas.filter(p => {
            const col = cacheColaboradores[p.colaborador_id];
            if (!col) return false;

            const u = cacheUsuarios[col.id_usuario];
            if (!u) return false;

            const nombre = `${u.nombre} ${u.apellidos ?? u.apellido ?? ""}`.toLowerCase();
            return nombre.includes(texto);
        });

        renderTabla(filtradas);
    }

    function eliminarPlanilla(id) {
        if (!confirm("¿Eliminar planilla?")) return;

        $.ajax({
            url: `${API_PLANILLA}/${id}`,
            method: "DELETE",
            success: () => cargarPlanillas(),
            error: () => alert("No se pudo eliminar")
        });
    }
</script>
