@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

@using Microsoft.AspNetCore.Identity
@using Tecmave.Front.Models
@inject SignInManager<Usuario> SignInManager
@inject UserManager<Usuario> UserManager

@{
    if (!SignInManager.IsSignedIn(User))
    {
        Response.Redirect("/Account/Login");
    }

   }


<section class="section client-only">
    <h2>Escribe tu Reseña</h2>
    <div class="card">
        <label>Nombre</label>
        <input class="input" id="client-review-name" placeholder="Tu nombre" readonly />

        <label>Servicio</label>
        <select class="input" id="client-review-service">
            <option value="">Seleccione un servicio</option>
        </select>

        <label>Calificación</label>
        <select class="input" id="client-review-rating">
            <option value="5.0">★★★★★</option>
            <option value="4.0">★★★★☆</option>
            <option value="3.0">★★★☆☆</option>
            <option value="2.0">★★☆☆☆</option>
            <option value="1.0">★☆☆☆☆</option>
        </select>

        <label>Comentario</label>
        <textarea class="input" id="client-review-comment" rows="4" placeholder="Comparte tu experiencia..."></textarea>

        <button onclick="addClientReview()" style="margin-top:.8rem">Enviar Reseña</button>
    </div>
</section>



<section class="section client-only">
    <h2>Reseñas Públicas</h2>
    <div class="grid cols-2" id="client-reviews-list">
        <!-- Reviews will be loaded here by JavaScript -->
    </div>
</section>




<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="http://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
</div>

<script>

    

     const API_RESENA = "http://localhost:7096/Resenas";
     const API_RESENA_PUBLICAS = "http://localhost:7096/Resenas/Publicas";
     const API_REVISION_COMPLETADAS = "http://localhost:7096/Revision/Completadas";

     const username = "@User.Identity.Name";
     const userId = "@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value";

     $(document).ready(function () {
         $("#client-review-name").val(username);
         cargarRevisionesCompletadas();
         cargarResenasPublicas();
     });

     // ============================================================
     // 1. CARGAR REVISIONES COMPLETADAS DEL USUARIO
     // ============================================================
     function cargarRevisionesCompletadas() {

         $.ajax({
             url: `${API_REVISION_COMPLETADAS}/${userId}`,
             method: "GET",
             success: function (data) {

                 const select = $("#client-review-service");
                 select.empty();

                 if (data.length === 0) {
                     select.append(`<option value="">No tienes revisiones completadas</option>`);
                     $("#client-review-comment").prop("disabled", true);
                     $("#client-review-rating").prop("disabled", true);
                     $("button").prop("disabled", true);
                     return;
                 }

                 $("#client-review-comment").prop("disabled", false);
                 $("#client-review-rating").prop("disabled", false);
                 $("button").prop("disabled", false);

                 select.append(`<option value="">Seleccione un servicio</option>`);

                 data.forEach(r => {
                     select.append(`
                         <option value="${r.revision_id}">
                             ${r.servicio_nombre}
                         </option>
                     `);
                 });

             },
             error: function () {
                 console.error("Error al cargar revisiones completadas");
             }
         });
     }

     // ============================================================
     // 2. VALIDAR SI LA REVISION ES COMPLETADA Y ES DEL USUARIO
     // ============================================================
     function validarRevisionCompletada(revisionId, callback) {

         $.ajax({
             url: `${API_REVISION_COMPLETADAS}/${userId}`,
             method: "GET",
             success: function (data) {
                 const valida = data.some(r => r.revision_id == revisionId);
                 callback(valida);
             },
             error: function () {
                 callback(false);
             }
         });
     }

     // ============================================================
     // 3. VALIDAR SI YA EXISTE UNA RESEÑA PARA ESTA REVISION
     // ============================================================
     function validarResenaDuplicada(revisionId, callback) {

         $.ajax({
             url: API_RESENA,
             method: "GET",
             success: function (data) {
                 const duplicada = data.some(r => r.revision_id == revisionId);
                 callback(!duplicada);
             },
             error: function () {
                 callback(false);
             }
         });
     }

     // ============================================================
     // 4. ENVIAR RESEÑA
     // ============================================================
     function addClientReview() {

         const revisionId = $("#client-review-service").val();
         const calificacion = parseFloat($("#client-review-rating").val());
         const comentario = $("#client-review-comment").val();

         if (!revisionId || !comentario.trim()) {
             alert("Por favor selecciona un servicio y escribe un comentario.");
             return;
         }

         validarRevisionCompletada(revisionId, function (revisionValida) {

             if (!revisionValida) {
                 alert("No puede reseñar esta revisión. No está completada o no le pertenece.");
                 return;
             }

             validarResenaDuplicada(revisionId, function (sinDuplicado) {

                 if (!sinDuplicado) {
                     alert("Esta revisión ya tiene una reseña.");
                     return;
                 }

                 const nuevaResena = {
                     cliente_id: parseInt(userId),
                     revision_id: parseInt(revisionId),
                     comentario: comentario,
                     calificacion: calificacion
                 };

                 $.ajax({
                     url: API_RESENA,
                     method: "POST",
                     contentType: "application/json",
                     data: JSON.stringify(nuevaResena),
                     success: function () {
                         alert("¡Gracias por tu reseña!");
                         $("#client-review-service").val("");
                         $("#client-review-rating").val("5");
                         $("#client-review-comment").val("");
                         cargarResenasPublicas();
                     },
                     error: function (xhr) {
                         alert(xhr.responseText || "Error al enviar reseña");
                     }
                 });

             });
         });
     }

     // ============================================================
     // 5. CARGAR RESEÑAS PÚBLICAS ENRIQUECIDAS
     // ============================================================
     function cargarResenasPublicas() {

         $.ajax({
             url: API_RESENA_PUBLICAS,
             method: "GET",
             success: function (data) {

                 const reviewsList = $('#client-reviews-list');
                 reviewsList.empty();

                 if (data.length === 0) {
                     reviewsList.html(`
                         <p style="grid-column: 1 / -1; text-align: center; color: var(--muted);">
                             Aún no hay reseñas. ¡Sé el primero en dejar una!
                         </p>
                     `);
                     return;
                 }

                 data.forEach(review => {

                     reviewsList.append(`
                         <div class="card">
                             <strong>${review.usuario}</strong>
                             <p>${'★'.repeat(Math.round(review.calificacion))}${'☆'.repeat(5 - Math.round(review.calificacion))}</p>
                             <p style="margin-top:.5rem">${review.comentario}</p>
                             <p style="color:var(--primary);font-weight:bold">${review.servicio}</p>
                         </div>
                     `);
                 });
             }
         });
     }

</script>







