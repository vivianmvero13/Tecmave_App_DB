@page "/Panel"
@model IndexModel
@{
    ViewData["Title"] = "Panel";
}

@using Microsoft.AspNetCore.Identity
@using Tecmave.Front.Models
@inject SignInManager<Usuario> SignInManager
@inject UserManager<Usuario> UserManager

@{
    if (!User.Identity.IsAuthenticated)
    {
        Response.Redirect("/Account/Login");
    }
    else if (!User.IsInRole("Cliente"))
    {
        // Si NO es cliente (por ejemplo Admin), redirigir al panel/admin
        Response.Redirect("/Estadistica/Index");
    }
}




<section class="section">
    <h2>Tu taller hoy</h2>

    <div class="container grid cols-3 client-kpi-row">
        <div class="card kpi-card">
            <div class="kpi-label">Próxima cita</div>
            <div class="kpi-main">
                <div id="kpi-proxima-dia" class="kpi-main-large">Sin citas</div>
                <div id="kpi-proxima-hora" class="kpi-main-sub">--:--</div>
            </div>
            <div id="kpi-proxima-estado" class="kpi-pill pill-neutral">Sin citas programadas</div>
        </div>

        <div class="card kpi-card">
            <div class="kpi-label">Mis vehículos</div>
            <div class="kpi-main">
                <div id="kpi-vehiculos-total" class="kpi-main-large">0</div>
                <div class="kpi-main-sub">registrados</div>
            </div>
            <div class="kpi-pill pill-neutral">
                <span id="kpi-vehiculos-taller">0</span> citas futuras
            </div>
        </div>

        <div class="card kpi-card">
            <div class="kpi-label">Balance del mes</div>
            <div class="kpi-main">
                <div id="kpi-balance-monto" class="kpi-main-large">₡0</div>
                <div id="kpi-balance-periodo" class="kpi-main-sub">Mes actual</div>
            </div>
            <div id="kpi-balance-estado" class="kpi-pill pill-neutral">Sin pagos registrados</div>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="card hero-card">
            <h2 class="mb-2">TECMAVE</h2>
            <p class="mb-3">
                Soluciones para la Logística y Mantenimiento de tu flota.
            </p>
            <div class="hero-actions">
                <button type="button" class="btn" id="btnIrServicios">Nuestros servicios</button>
                <button type="button" class="btn secondary" id="btnIrContacto">Contacto</button>
            </div>
        </div>

        <div class="grid cols-3 client-services-row" style="margin-top:1.5rem;">
            <div class="card service-card">
                <h3>Servicios Profesionales</h3>
                <p>Mantenimiento preventivo y correctivo de la más alta calidad.</p>
            </div>
            <div class="card service-card">
                <h3>Asistencia 24/7</h3>
                <p>Asistencia en carretera disponible las 24 horas del día.</p>
            </div>
            <div class="card service-card">
                <h3>Expertos Certificados</h3>
                <p>Técnicos con certificación internacional.</p>
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <h2>Promociones destacadas</h2>
        <p class="subtle">Aprovechá las últimas promociones activas para tus vehículos.</p>

        <div id="promos-destacadas" class="grid cols-3 promo-grid">
            <!-- Se cargan por JavaScript -->
        </div>
    </div>
</section>

<section class="section client-only">
    <h2>Escribe tu Reseña</h2>
    <div class="card">
        <label>Nombre</label>
        <input class="input" id="client-review-name" placeholder="Tu nombre" readonly />

        <label>Servicio</label>
        <select class="input" id="client-review-service">
            <option value="">Seleccione un servicio</option>
        </select>

        <label>Calificación</label>
        <select class="input" id="client-review-rating">
            <option value="5.0">★★★★★</option>
            <option value="4.0">★★★★☆</option>
            <option value="3.0">★★★☆☆</option>
            <option value="2.0">★★☆☆☆</option>
            <option value="1.0">★☆☆☆☆</option>
        </select>

        <label>Comentario</label>
        <textarea class="input" id="client-review-comment" rows="4" placeholder="Comparte tu experiencia..."></textarea>

        <button id="btnEnviarResena" onclick="addClientReview()" style="margin-top:.8rem">Enviar Reseña</button>
    </div>
</section>



<section class="section client-only">
    <h2>Reseñas Públicas</h2>
    <div class="grid cols-2" id="client-reviews-list">
        <!-- Reviews will be loaded here by JavaScript -->
    </div>
</section>

<script>
    // ============================
    // Panel de cliente (resumen)
    // ============================
    const API_BASE_PANEL        = "https://kaledcrc-001-site1.mtempurl.com";
    const URL_AGENDAMIENTOS_P   = API_BASE_PANEL + "/Agendamiento";
    const URL_VEHICULOS_P       = API_BASE_PANEL + "/vehiculos";
    const URL_PROMOCIONES_P     = API_BASE_PANEL + "/promociones";
    const URL_FACTURAS_P        = API_BASE_PANEL + "/facturas";

    function formatCRCP(n) {
        const v = Number(n || 0);
        return v.toLocaleString("es-CR", {
            style: "currency",
            currency: "CRC",
            maximumFractionDigits: 0
        });
    }

    function parseDateOnlyPanel(v) {
        if (!v) return null;
        const d = new Date(v);
        if (isNaN(d)) return null;
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function cargarResumenClientePanel() {
        cargarProximaCitaPanel();
        cargarVehiculosPanel();
        cargarBalanceMesPanel();
        cargarPromosDestacadasPanel();
    }

    function cargarProximaCitaPanel() {
        const hoyISO = new Date().toISOString().split("T")[0];

        $.get(URL_AGENDAMIENTOS_P, function (lista) {
            const ags = Array.isArray(lista) ? lista : [];
            const delUsuario = ags.filter(a => String(a.cliente_id) === String(userId));

            if (!delUsuario.length) {
                $("#kpi-proxima-dia").text("Sin citas");
                $("#kpi-proxima-hora").text("--:--");
                $("#kpi-proxima-estado")
                    .text("Sin citas programadas")
                    .removeClass("pill-success")
                    .addClass("pill-neutral");
                return;
            }

            const futuros = delUsuario.filter(a => a.fecha_estimada >= hoyISO);
            if (!futuros.length) {
                $("#kpi-proxima-dia").text("Sin citas");
                $("#kpi-proxima-hora").text("--:--");
                $("#kpi-proxima-estado")
                    .text("Sin citas futuras")
                    .removeClass("pill-success")
                    .addClass("pill-neutral");
                return;
            }

            futuros.sort((a, b) => {
                const da = new Date(a.fecha_estimada + "T" + (a.hora_llegada || "00:00"));
                const db = new Date(b.fecha_estimada + "T" + (b.hora_llegada || "00:00"));
                return da - db;
            });

            const prox = futuros[0];

            const fecha = parseDateOnlyPanel(prox.fecha_estimada);
            if (fecha) {
                const opts = { weekday: "short", day: "2-digit", month: "2-digit" };
                $("#kpi-proxima-dia").text(fecha.toLocaleDateString("es-CR", opts));
            } else {
                $("#kpi-proxima-dia").text(prox.fecha_estimada || "Próxima cita");
            }

            if (prox.hora_llegada) {
                $("#kpi-proxima-hora").text(prox.hora_llegada.substring(0,5));
            } else {
                $("#kpi-proxima-hora").text("--:--");
            }

            $("#kpi-proxima-estado")
                .text("Programada")
                .removeClass("pill-neutral")
                .addClass("pill-success");
        });
    }

    function cargarVehiculosPanel() {
        $.ajax({
            url: URL_VEHICULOS_P,
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function (data) {
                const lista = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
                const propios = lista.filter(v => {
                    const cid = v.cliente_id ?? v.clienteId ?? v.cliente?.id ?? v.ClienteId ?? 0;
                    return String(cid) === String(userId);
                });

                $("#kpi-vehiculos-total").text(propios.length);

                // contar citas futuras asociadas al cliente
                $.get(URL_AGENDAMIENTOS_P, function (listaAg) {
                    const ags = Array.isArray(listaAg) ? listaAg : [];
                    const delUsuario = ags.filter(a => String(a.cliente_id) === String(userId));
                    const hoyISO = new Date().toISOString().split("T")[0];
                    const futuros = delUsuario.filter(a => a.fecha_estimada >= hoyISO);
                    $("#kpi-vehiculos-taller").text(futuros.length);
                });
            },
            error: function () {
                $("#kpi-vehiculos-total").text("0");
                $("#kpi-vehiculos-taller").text("0");
            }
        });
    }

       function cargarBalanceMesPanel() {
        const hoy = new Date();
        const mesActual = hoy.getMonth();
        const annoActual = hoy.getFullYear();

        $("#kpi-balance-periodo").text(
            hoy.toLocaleDateString("es-CR", { month: "long", year: "numeric" })
        );

        $.ajax({
            url: URL_FACTURAS_P,
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function (data) {
                const lista = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);

                const propias = lista.filter(f => {
                    const clienteId = f.cliente_id ?? f.ClienteId ?? f.clienteId;
                    if (String(clienteId) !== String(userId)) return false;

                    const estado = (f.estado_pago ?? f.estado ?? f.Estado ?? "")
                        .toString()
                        .toLowerCase()
                        .trim();

                    // SOLO facturas pendientes
                    if (estado !== "pendiente")
                        return false;

                    const fechaVal = f.fecha_emision ?? f.fechaEmision ?? f.FechaEmision;
                    const d = parseDateOnlyPanel(fechaVal);
                    if (!d) return false;
                    return d.getMonth() === mesActual && d.getFullYear() === annoActual;
                });

                const total = propias.reduce(
                    (acc, f) => acc + Number(f.total ?? f.Total ?? f.monto_total ?? 0),
                    0
                );

                $("#kpi-balance-monto").text(formatCRCP(total));
                $("#kpi-balance-estado")
                    .text(total > 0 ? "Pendiente de pago" : "Sin facturas pendientes")
                    .removeClass("pill-success")
                    .addClass("pill-neutral");
            },
            error: function () {
                $("#kpi-balance-monto").text("₡0");
                $("#kpi-balance-estado")
                    .text("No se pudo cargar")
                    .removeClass("pill-success")
                    .addClass("pill-neutral");
            }
        });
    }


    function cargarPromosDestacadasPanel() {
        $.ajax({
            url: URL_PROMOCIONES_P,
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function (data) {
                const cont = $("#promos-destacadas");
                cont.empty();

                const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
                const activas = list.filter(p => {
                    const estado = Number(p.id_estado ?? p.idEstado ?? p.IdEstado ?? 0);
                    return estado === 1;
                });

                const promos = activas
                    .sort((a, b) => {
                        const da = parseDateOnlyPanel(a.fecha_inicio ?? a.fechaInicio ?? a.FechaInicio);
                        const db = parseDateOnlyPanel(b.fecha_inicio ?? b.fechaInicio ?? b.FechaInicio);
                        if (!da || !db) return 0;
                        return db - da; // más recientes primero
                    })
                    .slice(0, 3);

                if (!promos.length) {
                    cont.append('<p class="subtle">No hay promociones activas en este momento.</p>');
                    return;
                }

                promos.forEach(promo => {
                    const titulo = promo.titulo ?? promo.nombre ?? "Promoción";
                    const descripcion = promo.descripcion ?? "";
                    cont.append(`
                        <div class="card promo-card">
                            <h3>${titulo}</h3>
                            <p>${descripcion}</p>
                            <button type="button" class="btn secondary btn-ver-promo-panel">Ver promoción</button>
                        </div>
                    `);
                });
            },
            error: function () {
                $("#promos-destacadas").html('<p class="subtle">No se pudieron cargar las promociones.</p>');
            }
        });
    }





     const API_RESENA = "https://kaledcrc-001-site1.mtempurl.com/Resenas";
     const API_RESENA_PUBLICAS = "https://kaledcrc-001-site1.mtempurl.com/Resenas/Publicas";
     const API_REVISION_COMPLETADAS = "https://kaledcrc-001-site1.mtempurl.com/Revision/Completadas";

     const username = "@User.Identity.Name";
     const userId = "@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value";

     $(document).ready(function () {
         $("#client-review-name").val(username);

         // Panel cliente
         cargarResumenClientePanel();

         // Hooks de navegación
         $("#btnIrServicios").on("click", function () {
             window.location.href = "/Servicios/Index";
         });
         $("#btnIrContacto").on("click", function () {
             window.location.href = "/Contacto";
         });
         $(document).on("click", ".btn-ver-promo-panel", function () {
             window.location.href = "/Promociones/NuestrasPromociones";
         });

         // Reseñas
         cargarRevisionesCompletadas();
         cargarResenasPublicas();
     });

     // ============================================================
     // 1. CARGAR REVISIONES COMPLETADAS DEL USUARIO
     // ============================================================
     function cargarRevisionesCompletadas() {

         $.ajax({
             url: `${API_REVISION_COMPLETADAS}/${userId}`,
             method: "GET",
             success: function (data) {

                 const select = $("#client-review-service");
                 select.empty();

                 if (data.length === 0) {
                     select.append(`<option value="">No tienes revisiones completadas</option>`);
                     $("#client-review-comment").prop("disabled", true);
                     $("#client-review-rating").prop("disabled", true);
                     $("#btnEnviarResena").prop("disabled", true);
                     return;
                 }

                 $("#client-review-comment").prop("disabled", false);
                 $("#client-review-rating").prop("disabled", false);
                 $("#btnEnviarResena").prop("disabled", false);

                 select.append(`<option value="">Seleccione un servicio</option>`);

                 data.forEach(r => {
                     select.append(`
                         <option value="${r.revision_id}">
                             ${r.servicio_nombre}
                         </option>
                     `);
                 });

             },
             error: function () {
                 console.error("Error al cargar revisiones completadas");
             }
         });
     }

     // ============================================================
     // 2. VALIDAR SI LA REVISION ES COMPLETADA Y ES DEL USUARIO
     // ============================================================
     function validarRevisionCompletada(revisionId, callback) {

         $.ajax({
             url: `${API_REVISION_COMPLETADAS}/${userId}`,
             method: "GET",
             success: function (data) {
                 const valida = data.some(r => r.revision_id == revisionId);
                 callback(valida);
             },
             error: function () {
                 callback(false);
             }
         });
     }

     // ============================================================
     // 3. VALIDAR SI YA EXISTE UNA RESEÑA PARA ESTA REVISION
     // ============================================================
         function validarResenaDuplicada(revisionId, callback) {
        $.ajax({
            url: `${API_RESENA}/ExistePorRevision/${revisionId}`,
            method: "GET",
            success: function (existe) {
                callback(!existe); // true = puede continuar
            },
            error: function () {
                callback(false);
            }
        });
    }


     // ============================================================
     // 4. ENVIAR RESEÑA
     // ============================================================
         function addClientReview() {

        const clienteId = Number("@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value");
        const revisionId = Number($("#client-review-service").val());
        const comentario = $("#client-review-comment").val().trim();
        const calificacion = Number($("#client-review-rating").val());

        
        if (!Number.isInteger(clienteId) || clienteId <= 0) {
            alert("Usuario inválido.");
            return;
        }

        if (!Number.isInteger(revisionId) || revisionId <= 0) {
            alert("Seleccione un servicio válido.");
            return;
        }

        if (!comentario) {
            alert("Debe escribir un comentario.");
            return;
        }

        const data = {
            cliente_id: clienteId,
            revision_id: revisionId,
            comentario: comentario,
            calificacion: calificacion
        };

        console.log("Enviando reseña:", data);

        $.ajax({
            url: "https://kaledcrc-001-site1.mtempurl.com/Resenas",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: () => {
                alert("Reseña enviada correctamente.");
                $("#client-review-comment").val("");
            },
            error: (xhr) => {
                console.error(xhr.responseText);
                alert(xhr.responseText || "Error al enviar la reseña.");
            }
        });
    }


     // ============================================================
     // 5. CARGAR RESEÑAS PÚBLICAS ENRIQUECIDAS
     // ============================================================
     function cargarResenasPublicas() {

         $.ajax({
             url: API_RESENA_PUBLICAS,
             method: "GET",
             success: function (data) {

                 const reviewsList = $('#client-reviews-list');
                 reviewsList.empty();

                 if (data.length === 0) {
                     reviewsList.html(`
                         <p style="grid-column: 1 / -1; text-align: center; color: var(--muted);">
                             Aún no hay reseñas. ¡Sé el primero en dejar una!
                         </p>
                     `);
                     return;
                 }

                 data.forEach(review => {

                     reviewsList.append(`
                         <div class="card">
                             <strong>${review.usuario}</strong>
                             <p>${'★'.repeat(Math.round(review.calificacion))}${'☆'.repeat(5 - Math.round(review.calificacion))}</p>
                             <p style="margin-top:.5rem">${review.comentario}</p>
                             <p style="color:var(--primary);font-weight:bold">${review.servicio}</p>
                         </div>
                     `);
                 });
             }
         });
     }

</script>