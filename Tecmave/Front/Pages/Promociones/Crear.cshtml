@page
@model Front.Pages.Promociones.CrearModel
@{
    ViewData["Title"] = "Registrar promoción";
}

<section class="section">
    <div class="container grid cols-2">
        <div class="card">
            <h3 id="formTitle">Registrar promoción</h3>

            <div class="form-row">
                <div>
                    <label for="tituloInput">Título</label>
                    <input id="tituloInput" class="input" maxlength="120" />
                </div>
                <div>
                    <label for="estadoInput">Estado</label>
                    <select id="estadoInput" class="input">
                        <option value="1">Activa</option>
                        <option value="3">Inactiva</option>
                        <option value="2">Pendiente</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="inicioInput">Fecha inicio</label>
                    <input id="inicioInput" class="input" type="date" />
                </div>
                <div>
                    <label for="finInput">Fecha fin</label>
                    <input id="finInput" class="input" type="date" />
                </div>
            </div>

            <div class="form-row">
                <div style="grid-column: 1 / span 2;">
                    <label for="descripcionInput">Descripción</label>
                    <textarea id="descripcionInput" class="input" rows="4" maxlength="1000"></textarea>
                </div>
            </div>

            <div class="form-row">
                <div style="grid-column: 1 / span 2;">
                    <label for="imagenFileInput">Imagen de la promoción (archivo)</label>
                    <input id="imagenFileInput" class="input" type="file" accept="image/*" />
                    <small>Seleccioná una imagen JPG/PNG/GIF/WEBP.</small>
                </div>
            </div>

            <div class="form-row">
                <div style="grid-column: 1 / span 2;">
                    <label for="imagenUrlInput">URL de la imagen</label>
                    <input id="imagenUrlInput" class="input" maxlength="500" readonly />
                    <small>Se llena automáticamente al subir la imagen.</small>
                </div>
            </div>

            <div id="formMsg" class="text-danger mt-2" style="display:none;"></div>
        </div>

        <div class="card">
            <h3>Promociones</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Vigencia</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="listaDatos">
                    <tr><td colspan="4">Sin datos…</td></tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button id="guardarBtn" class="btn btn-orange" type="button">Guardar</button>
            <a class="btn btn-secondary" asp-page="/Promociones/Index">Volver</a>
        </div>
    </div>
</section>

<!-- MODAL (MISMA ESTÉTICA QUE EL ANTERIOR) -->
<div id="appModal" class="swal2-container" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody" style="display:none">
    <div class="swal2-backdrop" data-close="1"></div>

    <div class="swal2-popup" role="document" tabindex="-1">
        <button class="swal2-close" type="button" aria-label="Cerrar" data-close="1">×</button>

        <div class="swal2-icon warn" id="modalIconWrap" aria-hidden="true">
            <span class="swal2-icon-content" id="modalIcon">!</span>
        </div>

        <h2 class="swal2-title" id="modalTitle">Título</h2>

        <div class="swal2-html-container" id="modalBody">Mensaje…</div>

        <div class="swal2-actions">
            <button id="modalPrimary" class="btn btn-red" type="button" data-close="1">Aceptar</button>
        </div>
    </div>
</div>

<style>
    .btn-orange {
        background: #ff8c00 !important;
        border: 1px solid #ff8c00 !important;
        color: #fff !important;
        padding: .5rem 1rem;
        border-radius: .25rem
    }

        .btn-orange:hover {
            background: #e67e00 !important
        }

    .btn-red {
        background: #dc3545 !important;
        border: 1px solid #dc3545 !important;
        color: #fff !important;
        padding: .45rem 1.15rem;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
    }

        .btn-red:hover {
            background: #b92b3a !important
        }

    .btn-outline-primary.btn-sm {
        padding: .3rem .6rem;
        border-radius: .25rem
    }

    .text-danger {
        color: #dc3545
    }

    .grid.cols-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: .75rem
    }

    .input {
        width: 100%;
        padding: .5rem
    }

    .card {
        border: 1px solid #e5e5e5;
        border-radius: .5rem;
        padding: 1rem
    }

    .gap-2 {
        gap: .5rem
    }

    .table {
        width: 100%
    }

        .table th, .table td {
            padding: .5rem;
            border-bottom: 1px solid #eee
        }

    /* ================= MODAL SWEETALERT STYLE ================= */
    .swal2-container {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }

        .swal2-container.show {
            display: flex !important;
        }

    .swal2-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, .45);
    }

    .swal2-popup {
        position: relative;
        z-index: 1;
        width: min(520px, 92vw);
        background: #fff;
        border-radius: 16px;
        padding: 26px 22px 20px;
        box-shadow: 0 18px 55px rgba(0,0,0,.30);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        box-sizing: border-box;
        text-align: center;
    }

    #appModal .swal2-close {
        position: absolute !important;
        top: 12px !important;
        right: 12px !important;
        left: auto !important;
        bottom: auto !important;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        border: none;
        background: #dc3545;
        color: #fff;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(220,53,69,.35);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        box-sizing: border-box;
    }


    .swal2-icon {
        width: 80px;
        height: 80px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        margin: 6px 0 2px;
        border: 4px solid transparent;
        box-sizing: border-box;
    }

    .swal2-icon-content {
        font-size: 42px;
        font-weight: 800;
        line-height: 1;
    }

    #appModal .swal2-title {
        position: relative;
        padding-bottom: .5rem;
        margin-bottom: 0;
    }

        #appModal .swal2-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }

    .swal2-title-underline {
        width: 64px;
        height: 4px;
        border-radius: 999px;
        background: #dc3545;
        margin-top: 2px;
        margin-bottom: 2px;
    }

    .swal2-html-container {
        margin: 0;
        font-size: 1rem;
        color: #4b5563;
        text-align: center;
        max-width: 440px;
    }

    .swal2-actions {
        margin-top: 12px;
        display: flex;
        justify-content: center;
        width: 100%;
    }

    .swal2-icon.warn {
        background: #fff4e5;
        border-color: #f8bb86;
        color: #a15c00;
    }

    .swal2-icon.ok {
        background: #e7f6ec;
        border-color: #a5dc86;
        color: #2e7d32;
    }

    .swal2-icon.error {
        background: #fdecea;
        border-color: #f27474;
        color: #b3261e;
    }

    .swal2-icon.info {
        background: #e7f1ff;
        border-color: #9dc1ff;
        color: #0b57d0;
    }
</style>

<script>
    const API_BASE = "https://tecmave-api.azurewebsites.net";
    const URL_PROMOCIONES = `${API_BASE}/promociones`;
    const URL_UPLOAD_PROMO = `${API_BASE}/uploads/promo`;

    let currentPromoId = null; // null = crear, número = editar

    function showMsg(text){
      const el = document.getElementById('formMsg');
      el.textContent = text || '';
      el.style.display = text ? 'block' : 'none';
    }

    function esc(s){
      return String(s ?? '').replace(/[&<>"'`=\/]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
      }[c]));
    }

    function fmtDateToInput(v){
      if (!v) return '';
      try {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return String(v);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      } catch { return ''; }
    }

    function parseInputDate(id){
      const val = (document.getElementById(id).value || '').trim();
      return val;
    }

    function estadoLabel(cod){
      const n = Number(cod);
      if (n === 1) return "Activa";
      if (n === 3) return "Inactiva";
      return `Estado ${cod ?? "—"}`;
    }

    const Modal = (() => {
      const root = document.getElementById('appModal');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');
      const icon = document.getElementById('modalIcon');
      const iconWrap = document.getElementById('modalIconWrap');
      const btnPrimary = document.getElementById('modalPrimary');
      let onClose = null;

      function setKind(kind){
        iconWrap.classList.remove('warn','ok','error','info');
        const map = {
          ok:   { cls:'ok',   text:'✓' },
          warn: { cls:'warn', text:'!' },
          error:{ cls:'error',text:'!' },
          info: { cls:'info', text:'ℹ' }
        };
        const k = map[kind] || map.info;
        iconWrap.classList.add(k.cls);
        icon.textContent = k.text;
      }

      function show({ titleText='Información', bodyText='', onCloseCb=null, kind='info' }){
        setKind(kind);
        title.textContent = titleText;
        body.textContent = bodyText;

        onClose = typeof onCloseCb === 'function' ? onCloseCb : null;

        root.classList.add('show');
        root.style.display = 'flex';
        root.setAttribute('aria-hidden','false');

        setTimeout(() => btnPrimary?.focus(), 0);
        document.addEventListener('keydown', escListener);
      }

      function hide(){
        root.classList.remove('show');
        root.style.display = 'none';
        root.setAttribute('aria-hidden','true');
        document.removeEventListener('keydown', escListener);

        if (onClose) { const cb = onClose; onClose = null; try { cb(); } catch {} }
      }

      function escListener(e){ if (e.key === 'Escape') hide(); }

      root.addEventListener('click', (e) => { if (e.target?.dataset?.close === '1') hide(); });

      return { show, hide };
    })();

    function cargarListado(){
      const tb = document.getElementById('listaDatos');
      fetch(URL_PROMOCIONES, { credentials: 'include' })
        .then(r => { if(!r.ok) throw r; return r.json(); })
        .then(data => {
          const list = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
          if (!list.length) { tb.innerHTML = '<tr><td colspan="4">Sin datos…</td></tr>'; return; }

          tb.innerHTML = list.map(p => {
            const id    = p.id_promocion ?? p.id ?? p.Id;
            const tit   = p.titulo ?? p.Titulo ?? '';
            const desc  = p.descripcion ?? p.Descripcion ?? '';
            const fi    = p.fecha_inicio ?? p.FechaInicio ?? p.fechaInicio ?? '';
            const ff    = p.fecha_fin ?? p.FechaFin ?? p.fechaFin ?? '';
            const est   = p.id_estado ?? p.idEstado ?? p.IdEstado ?? '—';
            const selfUrl = `${location.pathname}?id=${encodeURIComponent(id)}`;
            const rango = `${esc(fmtDateToInput(fi))} → ${esc(fmtDateToInput(ff))}`;
            const estTxt = estadoLabel(est);

            return `
              <tr>
                <td title="${esc(desc)}">${esc(tit)}</td>
                <td>${rango}</td>
                <td>${esc(estTxt)}</td>
                <td>
                  <a class="btn btn-outline-primary btn-sm" href="${selfUrl}">Editar</a>
                  <button class="btn btn-red btn-sm" onclick="confirmarEliminar(${id})">Eliminar</button>
                </td>
              </tr>`;
          }).join('');
        })
        .catch(async err => {
          let msg='Error cargando promociones.'; try { msg = (await err.json())?.message || msg; } catch{}
          tb.innerHTML = `<tr><td colspan="4">${esc(msg)}</td></tr>`;
        });
    }

    function getFormData(){
      const titulo = (document.getElementById('tituloInput').value || '').trim();
      const descripcion = (document.getElementById('descripcionInput').value || '').trim();
      const fecha_inicio = parseInputDate('inicioInput');
      const fecha_fin    = parseInputDate('finInput');
      const id_estado    = parseInt(document.getElementById('estadoInput').value || '0', 10);
      const imagen_url   = (document.getElementById('imagenUrlInput').value || '').trim();

      if(!titulo) return { ok:false, msg:'El título es requerido.' };
      if(!fecha_inicio) return { ok:false, msg:'La fecha de inicio es requerida.' };
      if(!fecha_fin) return { ok:false, msg:'La fecha de fin es requerida.' };
      if (fecha_inicio > fecha_fin) return { ok:false, msg:'La fecha de inicio no puede ser mayor a la fecha fin.' };

      return {
        ok:true,
        payload: { titulo, descripcion, fecha_inicio, fecha_fin, id_estado, imagen_url }
      };
    }

    async function crearPromocion(){
      const { ok, msg, payload } = getFormData();
      if(!ok){ showMsg(msg); return; }
      showMsg('');

      const body = { id_promocion: 0, ...payload };

      const r = await fetch(URL_PROMOCIONES, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body)
      });

      if(!r.ok){
        let m='Error al registrar.'; try { m=(await r.json())?.message || m; } catch {}
        return showMsg(m);
      }

      limpiarFormulario();
      cargarListado();
      Modal.show({ titleText:'Éxito', bodyText:'Promoción registrada correctamente.', kind:'ok' });
    }

    async function actualizarPromocion(){
      if(!currentPromoId) return showMsg('No hay promoción cargada para editar.');

      const { ok, msg, payload } = getFormData();
      if(!ok){ showMsg(msg); return; }
      showMsg('');

      const body = { id_promocion: Number(currentPromoId), ...payload };

      const r = await fetch(URL_PROMOCIONES, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body)
      });

      if(!r.ok){
        let m='Error al actualizar.'; try { m=(await r.json())?.message || m; } catch {}
        return showMsg(m);
      }

      Modal.show({ titleText:'Éxito', bodyText:'Promoción actualizada correctamente.', kind:'ok' });
      salirModoEdicion();
      cargarListado();
    }

    async function eliminarPromocion(id){
      const r = await fetch(`${URL_PROMOCIONES}/${id}`, { method:'DELETE', credentials:'include' });
      if(r.ok){
        if(currentPromoId && Number(currentPromoId) === Number(id)) salirModoEdicion();
        Modal.show({ titleText:'Eliminado', bodyText:'Promoción eliminada correctamente.', kind:'ok', onCloseCb: () => cargarListado() });
      }else{
        let m='Error al eliminar.'; try { m=(await r.json())?.message || m; } catch {}
        Modal.show({ titleText:'Error', bodyText:m, kind:'error' });
      }
    }

    function confirmarEliminar(id){
      const btn = document.getElementById('modalPrimary');
      const prevText = btn.textContent;
      const prevClose = btn.getAttribute('data-close');

      btn.textContent = 'Sí, ELIMINAR';
      btn.removeAttribute('data-close');

      const handler = async () => {
        btn.removeEventListener('click', handler);
        try { await eliminarPromocion(id); } finally {
          btn.textContent = prevText;
          if(prevClose) btn.setAttribute('data-close', prevClose);
          Modal.hide();
        }
      };

      btn.addEventListener('click', handler, { once:true });

      Modal.show({
        titleText: 'Confirmar eliminación',
        bodyText: '¿Desea eliminar esta promoción?',
        kind: 'warn',
        onCloseCb: () => {
          btn.removeEventListener('click', handler);
          btn.textContent = prevText;
          if(prevClose) btn.setAttribute('data-close', prevClose);
        }
      });
    }

    function setModoCrear(){
      currentPromoId = null;
      document.getElementById('formTitle').textContent = 'Registrar promoción';
      const btn = document.getElementById('guardarBtn');
      btn.textContent = 'Guardar';
      btn.onclick = crearPromocion;
    }

    function setModoEditar(id){
      currentPromoId = id;
      document.getElementById('formTitle').textContent = 'Editar promoción';
      const btn = document.getElementById('guardarBtn');
      btn.textContent = 'Actualizar';
      btn.onclick = actualizarPromocion;
    }

    function limpiarFormulario(){
      document.getElementById('tituloInput').value = '';
      document.getElementById('descripcionInput').value = '';
      document.getElementById('inicioInput').value = '';
      document.getElementById('finInput').value = '';
      document.getElementById('estadoInput').value = '1';
      const imgUrl = document.getElementById('imagenUrlInput');
      const imgFile = document.getElementById('imagenFileInput');
      if (imgUrl) imgUrl.value = '';
      if (imgFile) imgFile.value = '';
      showMsg('');
    }

    function salirModoEdicion(){
      const url = new URL(window.location.href);
      url.searchParams.delete('id');
      window.history.replaceState({}, '', url.toString());
      setModoCrear();
      limpiarFormulario();
    }

    async function cargarPromocionPorId(id){
      const r = await fetch(`${URL_PROMOCIONES}/${encodeURIComponent(id)}`, { credentials:'include' });
      if(!r.ok){
        let m='No se pudo cargar la promoción.'; try { m=(await r.json())?.message || m; } catch {}
        showMsg(m); return;
      }
      const p = await r.json();

      document.getElementById('tituloInput').value = p.titulo ?? p.Titulo ?? '';
      document.getElementById('descripcionInput').value = p.descripcion ?? p.Descripcion ?? '';
      document.getElementById('inicioInput').value = fmtDateToInput(p.fecha_inicio ?? p.FechaInicio ?? p.fechaInicio ?? '');
      document.getElementById('finInput').value    = fmtDateToInput(p.fecha_fin ?? p.FechaFin ?? p.fechaFin ?? '');
      document.getElementById('estadoInput').value = p.id_estado ?? p.idEstado ?? p.IdEstado ?? '1';
      document.getElementById('imagenUrlInput').value = p.imagen_url ?? p.imagenUrl ?? '';

      setModoEditar(Number(p.id_promocion ?? p.id ?? p.Id ?? id));
    }

    function getQS(name){
      const p = new URLSearchParams(window.location.search);
      return p.get(name);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      setModoCrear();
      cargarListado();

      const qsId = getQS('id');
      if (qsId) {
        try { await cargarPromocionPorId(qsId); }
        catch (e) { console.error(e); showMsg('Error al cargar la promoción.'); setModoCrear(); }
      }

      const fileInput = document.getElementById('imagenFileInput');
      if (fileInput) {
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append('archivo', file);

          showMsg('Subiendo imagen...');

          try {
            const resp = await fetch(URL_UPLOAD_PROMO, {
              method: 'POST',
              body: formData,
              credentials: 'include'
            });

            if (!resp.ok) {
              let m = 'Error al subir la imagen.';
              try { m = (await resp.json())?.mensaje || m; } catch {}
              showMsg(m);
              return;
            }

            const data = await resp.json();
            document.getElementById('imagenUrlInput').value = data.url || '';
            showMsg('Imagen subida correctamente.');
          } catch (err) {
            console.error(err);
            showMsg('Error inesperado al subir la imagen.');
          }
        });
      }
    });
</script>
