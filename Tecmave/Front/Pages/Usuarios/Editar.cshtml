@page "{id:int}"
@model Front.Pages.Usuarios.EditarModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Editar usuario";
}

<h1 class="mb-4">Editar usuario</h1>

<div class="card p-4">
    <form id="frmUser">
        <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr)); gap:16px;">
            <div>
                <label class="form-label">Usuario</label>
                <input id="UserName" class="form-control" />
            </div>
            <div>
                <label class="form-label">Email</label>
                <input id="Email" type="email" class="form-control" />
            </div>
            <div>
                <label class="form-label">Teléfono</label>
                <input id="PhoneNumber" class="form-control" />
            </div>

            <div style="grid-column:1/-1">
                <label class="form-label">Roles asignados</label>
                <div id="RolesReadOnly"></div>
                <small class="text-muted">Los roles se administran desde la pantalla de <a href="/Roles/Index">Roles</a> o el listado de usuarios.</small>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button id="btnSave" type="submit" class="btn btn-primary">Guardar</button>
            <a class="btn btn-secondary" asp-page="/Usuarios/Index">Volver</a>
        </div>
    </form>
</div>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script>
        const API = '@Model.ApiBase';
        const USER_ID = @Model.Id;

        $(function () {
          loadUser();
          $('#frmUser').on('submit', onSave);
        });

        function badge(text){
          const t = (text ?? '').toString();
          if(!t) return '';
          return `<span class="badge" style="background:#eef1f5;color:#333;border:1px solid #d9dee5;margin-right:6px;">${escapeHtml(t)}</span>`;
        }

        function escapeHtml(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

        function loadUser() {
          $.getJSON(`${API}/api/usuarios/${USER_ID}`, function (u) {
            $('#UserName').val(u.userName ?? '');
            $('#Email').val(u.email ?? '');
            $('#PhoneNumber').val(u.phoneNumber ?? '');
          });

          $.getJSON(`${API}/api/usuarios/${USER_ID}/roles`, function (roles) {
            const html = (roles && roles.length)
              ? roles.map(r => badge(r)).join(' ')
              : '<span class="text-muted">(sin rol)</span>';
            $('#RolesReadOnly').html(html);
          }).fail(()=> $('#RolesReadOnly').html('<span class="text-muted">(error)</span>'));
        }

        async function onSave(e) {
          e.preventDefault();
          $('#btnSave').prop('disabled', true);

          const payload = {
            userName: $('#UserName').val(),
            email: $('#Email').val(),
            phoneNumber: $('#PhoneNumber').val()
          };

          try {
            await $.ajax({
              url: `${API}/api/usuarios/${USER_ID}`,
              method: 'PUT',
              contentType: 'application/json',
              data: JSON.stringify(payload)
            });

            window.location.href = '/Usuarios/Index';
          } catch (err) {
            console.error(err);
            alert('No se pudo guardar el usuario.');
          } finally {
            $('#btnSave').prop('disabled', false);
          }
        }
    </script>
}