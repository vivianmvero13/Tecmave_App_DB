@page "{id:int}"
@model Front.Pages.Usuarios.EditarModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Editar usuario";
}

<h1 class="mb-4">Editar usuario</h1>

<div class="card p-4">
    <form id="frmUser">
        <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr)); gap:16px;">
            <div>
                <label class="form-label">Nombre</label>
                <input id="nombre" class="form-control" />
            </div>
            <div>
                <label class="form-label">Apellidos</label>
                <input id="apellidos" class="form-control" />
            </div>
            <div>
                <label class="form-label">Email</label>
                <input id="Email" type="email" class="form-control" />
            </div>
            <div>
                <label class="form-label">Teléfono</label>
                <input id="PhoneNumber" class="form-control" />
            </div>

            <div style="grid-column:1/-1">
                <label class="form-label">Roles asignados</label>
                <div id="RolesReadOnly"></div>
                <small class="text-muted">
                    Los roles se administran desde la pantalla de
                    <a href="/Roles/Index">Roles</a> o el listado de usuarios.
                </small>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2">
            <a class="btn btn-secondary" asp-page="/Usuarios/Index">Volver</a>
            <button id="btnSave" type="submit" class="btn btn-primary">Guardar</button>

        </div>
    </form>
</div>

<!-- Modal estilo SweetAlert2 (reutilizable) -->
<div id="appModal" class="swal2-container" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody" style="display:none">
    <div class="swal2-backdrop" data-close="1"></div>
    <div class="swal2-popup" role="document" tabindex="-1">
        <button class="swal2-close" type="button" aria-label="Cerrar" data-close="1">×</button>

        <div class="swal2-icon info" id="modalIconWrap" aria-hidden="true">
            <span class="swal2-icon-content" id="modalIcon">ℹ</span>
        </div>

        <h2 class="swal2-title" id="modalTitle">Título</h2>
        <div class="swal2-html-container" id="modalBody">Mensaje…</div>

        <div class="swal2-actions">
            <button id="modalCancel" class="btn btn-secondary" type="button" data-close="1" style="display:none">Cancelar</button>
            <button id="modalConfirm" class="btn btn-orange" type="button" data-close="1">Aceptar</button>

        </div>
    </div>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #8f9a11 !important;
        }

    .swal2-container {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: none;
    }

        .swal2-container.show {
            display: block;
        }

    .swal2-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, .45);
    }

    .swal2-popup {
        position: relative;
        width: min(520px, calc(100% - 24px));
        margin: 10vh auto 0;
        background: #fff;
        border-radius: 16px;
        padding: 28px 24px 20px;
        box-shadow: 0 10px 35px rgba(0, 0, 0, .25);
        display: grid;
        justify-items: center;
        text-align: center;
    }

    .swal2-close {
        position: absolute !important;
        top: 12px !important;
        right: 14px !important;
        left: auto !important;
        bottom: auto !important;
        justify-self: end;
        align-self: start;
        border: 0;
        background: transparent;
        font-size: 26px;
        line-height: 1;
        color: #888;
        cursor: pointer;
    }

    .swal2-icon {
        width: 80px;
        height: 80px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        margin: 6px 0 10px;
        border: 4px solid transparent;
    }

    .swal2-icon-content {
        font-size: 42px;
        font-weight: 800;
        line-height: 1;
    }

    .swal2-title {
        margin: 6px 0 8px;
        font-size: 1.35rem;
        font-weight: 700;
        color: #1f2937;
    }

    .swal2-html-container {
        margin: 0;
        font-size: 1rem;
        color: #4b5563;
    }

    .swal2-actions {
        margin-top: 18px;
        display: flex;
        gap: 10px;
        justify-content: center;
        width: 100%;
    }

    .swal2-icon.warn {
        background: #fff4e5;
        border-color: #f8bb86;
        color: #a15c00;
    }

    .swal2-icon.ok {
        background: #e7f6ec;
        border-color: #a5dc86;
        color: #2e7d32;
    }

    .swal2-icon.error {
        background: #fdecea;
        border-color: #f27474;
        color: #b3261e;
    }

    .swal2-icon.info {
        background: #e7f1ff;
        border-color: #9dc1ff;
        color: #0b57d0;
    }

    .btn {
        height: 40px; 
        padding: 0 16px;
        font-size: 0.95rem;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }
        .btn > * {
            line-height: 1;
        }

</style>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script>
        const API = '@(Model?.ApiBase ?? "https://tecmave-api.azurewebsites.net")';
        const USER_ID = @Model.Id;

        // ✅ cookies cross-domain (si tu API usa Identity cookie)
        $.ajaxSetup({ xhrFields: { withCredentials: true } });

        function escapeHtml(s){
          return String(s ?? '')
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'",'&#39;');
        }

        function badge(text){
          const t = (text ?? '').toString();
          if(!t) return '';
          return `<span class="badge" style="background:#eef1f5;color:#333;border:1px solid #d9dee5;margin-right:6px;">${escapeHtml(t)}</span>`;
        }

        /* =================== Modal helpers (SweetAlert2-like) =================== */
        const Modal = (() => {
            const root     = document.getElementById('appModal');
            const title    = document.getElementById('modalTitle');
            const body     = document.getElementById('modalBody');
            const icon     = document.getElementById('modalIcon');
            const iconWrap = document.getElementById('modalIconWrap');
            const btnConfirm = document.getElementById('modalConfirm');
            const btnCancel  = document.getElementById('modalCancel');

            let onClose = null;
            let onConfirm = null;

            function setKind(kind){
                iconWrap.classList.remove('warn','ok','error','info');
                const map = {
                    ok:   { cls:'ok', text:'✓' },
                    warn: { cls:'warn', text:'!' },
                    error:{ cls:'error', text:'!' },
                    info: { cls:'info', text:'ℹ' }
                };
                const k = map[kind] || map.info;
                iconWrap.classList.add(k.cls);
                icon.textContent = k.text;
            }

            function show({
                titleText = 'Información',
                bodyText = '',
                bodyHtml = null,
                kind = 'info',
                confirmText = 'Aceptar',
                cancelText = null,
                onConfirmCb = null,
                onCloseCb = null
            }){
                setKind(kind);
                title.textContent = titleText;

                // ✅ si mandan HTML (roles badges), lo usamos; si no, texto plano
                if (bodyHtml != null) body.innerHTML = bodyHtml;
                else body.textContent = bodyText;

                btnConfirm.textContent = confirmText;

                if (cancelText) {
                    btnCancel.style.display = 'inline-block';
                    btnCancel.textContent = cancelText;
                } else {
                    btnCancel.style.display = 'none';
                }

                onConfirm = (typeof onConfirmCb === 'function') ? onConfirmCb : null;
                onClose   = (typeof onCloseCb === 'function') ? onCloseCb : null;

                btnConfirm.onclick = async () => {
                    try { if (onConfirm) await onConfirm(); }
                    finally { hide(); }
                };

                root.classList.add('show');
                root.style.display = 'block';
                root.setAttribute('aria-hidden','false');

                setTimeout(() => btnConfirm.focus(), 0);
                document.addEventListener('keydown', escListener);
            }

            function hide(){
                root.classList.remove('show');
                root.style.display = 'none';
                root.setAttribute('aria-hidden','true');
                document.removeEventListener('keydown', escListener);

                const cb = onClose;
                onClose = null;
                onConfirm = null;
                if (cb) { try { cb(); } catch {} }
            }

            function escListener(e){ if (e.key === 'Escape') hide(); }

            root.addEventListener('click', (e) => {
                if (e.target?.dataset?.close === '1') hide();
            });

            function confirm({ titleText, bodyText, kind='warn', confirmText='Aceptar', onConfirmCb }){
                show({ titleText, bodyText, kind, confirmText, cancelText, onConfirmCb });
            }

            return { show, hide, confirm };
        })();

        $(function () {
            loadUser();
            $('#frmUser').on('submit', onSave);
        });

        function loadUser() {
          $.getJSON(`${API}/api/usuarios/${USER_ID}`, function (u) {
            $('#nombre').val(u.nombre ?? u.Nombre ?? '');
            $('#apellidos').val(u.apellidos ?? u.Apellidos ?? '');
            $('#Email').val(u.email ?? u.Email ?? '');
            $('#PhoneNumber').val(u.phoneNumber ?? u.PhoneNumber ?? u.phone_number ?? '');
          }).fail(() => {
            Modal.show({
              titleText: 'Error',
              bodyText: 'No se pudo cargar el usuario.',
              kind: 'error',
              confirmText: 'Aceptar'
            });
          });

          $.getJSON(`${API}/api/usuarios/${USER_ID}/roles`, function (roles) {
            const html = (roles && roles.length)
              ? roles.map(r => badge(r)).join(' ')
              : '<span class="text-muted">(sin rol)</span>';
            $('#RolesReadOnly').html(html);
          }).fail(()=> $('#RolesReadOnly').html('<span class="text-muted">(error)</span>'));
        }

        function extractIdentityErrors(err) {
            // puede venir como [{code, description}] o como objeto
            const resp = err?.responseJSON;
            if (!resp) return null;

            if (Array.isArray(resp)) {
                const msgs = resp.map(e => e.description || e.Description || e.message || e.Message).filter(Boolean);
                return msgs.length ? msgs.join(' ') : null;
            }

            if (Array.isArray(resp.errors)) {
                const msgs = resp.errors.map(e => e.description || e.Description).filter(Boolean);
                return msgs.length ? msgs.join(' ') : null;
            }

            return resp.message || resp.Message || null;
        }

        async function onSave(e) {
          e.preventDefault();
          $('#btnSave').prop('disabled', true);

          // ✅ IMPORTANTE: manda propiedades como las espera tu UpdateUserDto
          const payload = {
            nombre: $('#nombre').val(),
            apellidos: $('#apellidos').val(),
            Email: $('#Email').val(),
            PhoneNumber: $('#PhoneNumber').val()
          };

          try {
            await $.ajax({
              url: `${API}/api/usuarios/${USER_ID}`,
              method: 'PUT',
              contentType: 'application/json',
              data: JSON.stringify(payload)
            });

            Modal.show({
              titleText: 'Éxito',
              bodyText: 'El perfil se actualizó correctamente.',
              kind: 'ok',
              confirmText: 'Aceptar'
            });
          } catch (err) {
            console.error(err);

            let msg = extractIdentityErrors(err) || 'No se pudo guardar el usuario.';

            Modal.show({
              titleText: 'Error',
              bodyText: msg,
              kind: 'error',
              confirmText: 'Aceptar'
            });
          } finally {
            $('#btnSave').prop('disabled', false);
          }
        }
    </script>
}
