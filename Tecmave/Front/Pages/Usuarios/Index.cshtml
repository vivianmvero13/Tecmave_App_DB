@page
@model Front.Pages.Usuarios.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Usuarios Registrados";
}

<h1>Usuarios Registrados</h1>

<div class="row g-3 align-items-end mt-3">
    <div class="col-12 col-md-4">
        <label for="roleFilter" class="form-label">Filtrar por rol</label>
        <select id="roleFilter" class="form-select">
            <option value="">(Todos)</option>
        </select>
    </div>

    <div class="col-12 col-md-8">
        <label for="localSearch" class="form-label">Buscar</label>
        <div class="input-group">
            <input id="localSearch" class="form-control" placeholder="Buscar por username, email, teléfono o rol…" />
            <button id="clearSearch" class="btn btn-outline-secondary" type="button">Limpiar</button>
        </div>
    </div>
</div>

<!-- Barra única: badge izquierda + acciones derecha -->
<div class="table-header mt-3">
    <small id="resultsBadge" class="text-muted">Mostrando 0 de 0</small>

    <div class="table-actions">
        <!-- Administrar Roles (texto) -->
        <a id="manageRolesBtn" class="btn btn-royal btn-sm" href="/Roles">Administrar Roles</a>

        <!-- Export (texto) -->
        <button id="exportBtn" class="btn btn-orange btn-sm" type="button" title="Exportar usuarios activos">
            <i class="fa-solid fa-file-excel"></i> Exportar
        </button>

        <!-- Icono Roles (opcional, si lo querés igual que Vehículos) -->
        <button class="icon-action" type="button" title="Administrar roles" onclick="location.href='/Roles'">
            <img src="/assets/img/role.png" alt="Administrar roles" />
        </button>
</div>

<div class="table-responsive mt-2">
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Apellidos</th>
                <th>Username</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Estado</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="userTable">
            <tr><td colspan="8">Cargando usuarios…</td></tr>
        </tbody>
    </table>
</div>

<!-- Controles de paginación -->
<div class="d-flex justify-content-between align-items-center mt-2">
    <div class="d-flex align-items-center gap-2">
        <label for="pageSizeSelect" class="form-label mb-0">Mostrar:</label>
        <select id="pageSizeSelect" class="form-select form-select-sm" style="width:auto;">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
        </select>
    </div>
    <nav aria-label="Paginación usuarios" class="usuarios-pagination-nav">
        <ul class="pagination pagination-sm mb-0 d-flex flex-row align-items-center gap-2"
            style="list-style:none; margin:0; padding:0;">
            <li class="page-item" id="prevPageItem" style="list-style:none;">
                <button class="page-link" type="button" id="prevPageBtn" aria-label="Anterior">&laquo;</button>
            </li>
            <li class="page-item disabled" style="list-style:none;">
                <span class="page-link" id="pageInfo">1 / 1</span>
            </li>
            <li class="page-item" id="nextPageItem" style="list-style:none;">
                <button class="page-link" type="button" id="nextPageBtn" aria-label="Siguiente">&raquo;</button>
            </li>
        </ul>
    </nav>
</div>

<!-- Modal estilo SweetAlert2 (reutilizable) -->
<div id="appModal" class="swal2-container" aria-hidden="true" role="dialog" aria-modal="true"
     aria-labelledby="modalTitle" aria-describedby="modalBody" style="display:none">
    <div class="swal2-backdrop" data-close="1"></div>
    <div class="swal2-popup" role="document" tabindex="-1">
        <button class="swal2-close" type="button" aria-label="Cerrar" data-close="1">×</button>

        <div class="swal2-icon info" id="modalIconWrap" aria-hidden="true">
            <span class="swal2-icon-content" id="modalIcon">ℹ</span>
        </div>

        <h2 class="swal2-title" id="modalTitle">Título</h2>
        <div class="swal2-html-container" id="modalBody">Mensaje…</div>

        <div class="swal2-actions">
            <button id="modalConfirm" class="btn btn-orange" type="button" data-close="1">Aceptar</button>
            <button id="modalCancel" class="btn btn-secondary" type="button" data-close="1" style="display:none">Cancelar</button>
        </div>
    </div>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #8f9a11 !important;
        }

    .btn-royal {
        background: #C36721 !important;
        border: 1px solid #C36721 !important;
        color: #fff !important;
    }

    /* ============================
           Modal estilo SweetAlert2
           ============================ */
    .swal2-container {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: none;
    }

        .swal2-container.show {
            display: block;
        }

    .swal2-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,.45);
    }

    .swal2-popup {
        position: relative;
        width: min(520px, calc(100% - 24px));
        margin: 10vh auto 0;
        background: #fff;
        border-radius: 16px;
        padding: 28px 24px 20px;
        box-shadow: 0 10px 35px rgba(0,0,0,.25);
        display: grid;
        justify-items: center;
        text-align: center;
    }

    .swal2-close {
        position: absolute !important;
        top: 12px !important;
        right: 14px !important;
        border: 0;
        background: transparent;
        font-size: 26px;
        line-height: 1;
        color: #888;
        cursor: pointer;
    }

    .swal2-icon {
        width: 80px;
        height: 80px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        margin: 6px 0 10px;
        border: 4px solid transparent;
    }

    .swal2-icon-content {
        font-size: 42px;
        font-weight: 800;
        line-height: 1;
    }

    .swal2-title {
        margin: 6px 0 8px;
        font-size: 1.35rem;
        font-weight: 700;
        color: #1f2937;
    }

    .swal2-html-container {
        margin: 0;
        font-size: 1rem;
        color: #4b5563;
    }

    .swal2-actions {
        margin-top: 18px;
        display: flex;
        gap: 10px;
        justify-content: center;
        width: 100%;
    }

    .swal2-icon.warn {
        background: #fff4e5;
        border-color: #f8bb86;
        color: #a15c00;
    }

    .swal2-icon.ok {
        background: #e7f6ec;
        border-color: #a5dc86;
        color: #2e7d32;
    }

    .swal2-icon.error {
        background: #fdecea;
        border-color: #f27474;
        color: #b3261e;
    }

    .swal2-icon.info {
        background: #e7f1ff;
        border-color: #9dc1ff;
        color: #0b57d0;
    }

    /* Paginación usuarios */
    .usuarios-pagination-nav .pagination {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: .5rem !important;
    }

    .usuarios-pagination-nav .page-item {
        list-style: none !important;
    }

    .usuarios-pagination-nav .page-link {
        display: flex !important;
        align-items: center;
        justify-content: center;
        padding: .35rem .65rem;
        border-radius: 8px;
        cursor: pointer;
    }

    /* Header tabla: badge izquierda + acciones derecha (igual que Vehículos) */
    .table-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 12px;
        width: 100%;
        gap: 12px;
    }

    .table-actions {
        display: flex !important;
        align-items: center !important;
        justify-content: flex-end !important;
        gap: 10px !important;
        flex-wrap: nowrap;
    }

    /* Icon buttons */
    button.icon-action {
        background: transparent !important;
        border: 0 !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
        border-radius: 0 !important;
        outline: none !important;
        cursor: pointer;
    }

        button.icon-action:hover,
        button.icon-action:focus,
        button.icon-action:active {
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
        }

        button.icon-action img {
            width: 25px;
            height: 25px;
            display: block;
        }
</style>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script>
        // ✅ importante para cookies cross-domain con jQuery
        $.ajaxSetup({ xhrFields: { withCredentials: true } });

        const API_BASE  = '@(Model?.ApiBase ?? "https://tecmave-api.azurewebsites.net")';
        const USERS_URL = `${API_BASE}/api/usuarios`;
        const ROLES_URL = `${API_BASE}/api/roles`;

        let allUsers = [];
        let allRoleNamesNorm = [];
        const U = s => (s ?? '').toString().trim().toUpperCase();

        // Paginación
        const PAGE_SIZES = [5, 10, 20, 50];
        let pageSize = 5;
        let currentPage = 1;

        let $pageSizeSelect, $pageInfo, $prevPageBtn, $nextPageBtn, $prevPageItem, $nextPageItem;

        function debounce(fn, d = 250) {
            let t;
            return (...a) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...a), d);
            };
        }

        function escapeHtml(s) {
            return String(s ?? '').replace(/[&<>"'`=\/]/g, c => ({
                '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
            }[c]));
        }

        /* =================== Modal helpers (SweetAlert2-like) =================== */
        const Modal = (() => {
            const root     = document.getElementById('appModal');
            const title    = document.getElementById('modalTitle');
            const body     = document.getElementById('modalBody');
            const icon     = document.getElementById('modalIcon');
            const iconWrap = document.getElementById('modalIconWrap');
            const btnConfirm = document.getElementById('modalConfirm');
            const btnCancel  = document.getElementById('modalCancel');

            let onClose = null;
            let onConfirm = null;

            function setKind(kind){
                iconWrap.classList.remove('warn','ok','error','info');
                const map = {
                    ok:   { cls:'ok', text:'✓' },
                    warn: { cls:'warn', text:'!' },
                    error:{ cls:'error', text:'!' },
                    info: { cls:'info', text:'ℹ' }
                };
                const k = map[kind] || map.info;
                iconWrap.classList.add(k.cls);
                icon.textContent = k.text;
            }

            function show({
                titleText = 'Información',
                bodyText = '',
                kind = 'info',
                confirmText = 'Aceptar',
                cancelText = null,
                onConfirmCb = null,
                onCloseCb = null
            }){
                setKind(kind);
                title.textContent = titleText;
                body.textContent  = bodyText;

                btnConfirm.textContent = confirmText;

                if (cancelText) {
                    btnCancel.style.display = 'inline-block';
                    btnCancel.textContent = cancelText;
                } else {
                    btnCancel.style.display = 'none';
                }

                onConfirm = (typeof onConfirmCb === 'function') ? onConfirmCb : null;
                onClose   = (typeof onCloseCb === 'function') ? onCloseCb : null;

                btnConfirm.onclick = async () => {
                    try { if (onConfirm) await onConfirm(); }
                    finally { hide(); }
                };

                root.classList.add('show');
                root.style.display = 'block';
                root.setAttribute('aria-hidden','false');

                setTimeout(() => btnConfirm.focus(), 0);
                document.addEventListener('keydown', escListener);
            }

            function hide(){
                root.classList.remove('show');
                root.style.display = 'none';
                root.setAttribute('aria-hidden','true');
                document.removeEventListener('keydown', escListener);

                const cb = onClose;
                onClose = null;
                onConfirm = null;
                if (cb) { try { cb(); } catch {} }
            }

            function escListener(e){ if (e.key === 'Escape') hide(); }

            root.addEventListener('click', (e) => {
                if (e.target?.dataset?.close === '1') hide();
            });

            function confirm({ titleText, bodyText, kind='warn', confirmText='Aceptar', cancelText='Cancelar', onConfirmCb }){
                show({ titleText, bodyText, kind, confirmText, cancelText, onConfirmCb });
            }

            return { show, hide, confirm };
        })();

        async function loadRolesList() {
            try {
                const roles = await $.getJSON(ROLES_URL);
                allRoleNamesNorm = roles
                    .map(r => r.normalizedName ?? r.NormalizedName ?? (r.name ? U(r.name) : null))
                    .filter(Boolean);
            } catch {
                allRoleNamesNorm = [];
            }
        }

        function populateRoleFilter() {
            const union = new Set([
                ...allRoleNamesNorm,
                ...allUsers.flatMap(u => (u.roles || []).map(U))
            ]);

            const $sel = $('#roleFilter').empty();
            $sel.append(`<option value="">(Todos)</option>`);
            Array.from(union).filter(Boolean).sort().forEach(r =>
                $sel.append(`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`)
            );
        }

        function getSearchText() { return ($('#localSearch').val() || '').toLowerCase(); }

        function formatEstado(e) {
            const v = Number(e);
            switch (v) {
                case 1: return 'Activo';
                case 2: return 'Inactivo';
                default: return e == null ? 'Sin estado' : `(${e})`;
            }
        }

        // ✅ SOLO ACTIVOS (Estado=1)
        function applyFilters() {
            const selected = $('#roleFilter').val();
            const q = getSearchText();

            return allUsers
                .filter(u => Number(u.estado) === 1)
                .filter(u => {
                    const roles = Array.isArray(u.roles) ? u.roles.map(U) : [];
                    const roleOk = !selected ? true : roles.includes(U(selected));
                    const estadoText = formatEstado(u.estado);

                    const haystack = [
                        u.userNameNorm || U(u.userName),
                        u.email || '',
                        u.phoneNumber || '',
                        ...roles,
                        estadoText
                    ].join(' ').toLowerCase();

                    return roleOk && (!q || haystack.includes(q));
                });
        }

        function renderTable(pageUsers, total, from, to, page, totalPages) {
            const $tb = $('#userTable').empty();

            if (!total) {
                $tb.html(`<tr><td colspan="8" class="text-muted">No hay usuarios activos.</td></tr>`);
                $('#resultsBadge').text(`Mostrando 0 de 0`);
                $pageInfo.text('0 / 0');
                $prevPageItem.addClass('disabled');
                $nextPageItem.addClass('disabled');
                return;
            }

            if (!pageUsers.length) {
                $tb.html(`<tr><td colspan="8" class="text-muted">Sin resultados en esta página.</td></tr>`);
            } else {
                pageUsers.forEach(u => {
                    const rolesText = (u.roles && u.roles.length) ? u.roles.map(U).join(', ') : '(SIN ROL)';
                    const estadoText = formatEstado(u.estado);

                    $tb.append(`<tr>
                        <td>${escapeHtml(u.nombre || 'Sin definir')}</td>
                        <td>${escapeHtml(u.apellidos || 'Sin definir')}</td>
                        <td>${escapeHtml(u.userNameNorm || U(u.userName))}</td>
                        <td>${escapeHtml(u.email ?? '')}</td>
                        <td>${escapeHtml(u.phoneNumber ?? '')}</td>
                        <td>${escapeHtml(estadoText)}</td>
                        <td>${escapeHtml(rolesText)}</td>
                        <td>
                            <a class="btn btn-primary btn-sm" href="/Usuarios/Editar/${encodeURIComponent(u.id)}">Editar</a>
                            <button class="btn btn-danger btn-sm ms-1" type="button" onclick="desactivarUsuario(${u.id})">Desactivar</button>
                        </td>
                    </tr>`);
                });
            }

            $('#resultsBadge').text(`Mostrando ${from}-${to} de ${total}`);
            $pageInfo.text(`${page} / ${totalPages}`);

            if (page <= 1) $prevPageItem.addClass('disabled'); else $prevPageItem.removeClass('disabled');
            if (page >= totalPages) $nextPageItem.addClass('disabled'); else $nextPageItem.removeClass('disabled');
        }

        function refreshTable() {
            const filtered = applyFilters();
            const total = filtered.length;

            if (!total) { renderTable([], 0, 0, 0, 0, 0); return; }

            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, total);
            const pageUsers = filtered.slice(startIndex, endIndex);

            renderTable(pageUsers, total, startIndex + 1, endIndex, currentPage, totalPages);
        }

        async function loadUsers() {
            try {
                // 1) Intento optimizado: /api/usuarios/with-role (si existe)
                try {
                    const res = await fetch(`${USERS_URL}/with-role`, { credentials: 'include' });
                    if (res.ok) {
                        const rows = await res.json();
                        allUsers = rows.map(u => {
                            const userName = u.userName ?? u.UserName ?? u.user_name ?? '';
                            const phone = u.phoneNumber ?? u.PhoneNumber ?? u.phone_number ?? '';
                            const estado = u.estado ?? u.Estado ?? 1;
                            return {
                                id: u.id ?? u.Id,
                                nombre: u.nombre ?? u.Nombre ?? '',
                                apellidos: u.apellidos ?? u.Apellidos ?? '',
                                userName,
                                userNameNorm: U(userName),
                                email: u.email ?? u.Email ?? '',
                                phoneNumber: phone,
                                estado,
                                roles: u.role ? [U(u.role)] : (Array.isArray(u.roles) ? u.roles.map(U) : [])
                            };
                        });

                        populateRoleFilter();
                        currentPage = 1;
                        refreshTable();
                        return;
                    }
                } catch { }

                // 2) Fallback: /api/usuarios
                const users = await $.getJSON(USERS_URL);

                const roleFetches = users.map(async (u) => {
                    const userName = u.userName ?? u.UserName ?? u.user_name ?? '';
                    const baseUser = {
                        id: u.id ?? u.Id,
                        nombre: u.nombre ?? u.Nombre ?? '',
                        apellidos: u.apellidos ?? u.Apellidos ?? '',
                        userName,
                        userNameNorm: U(userName),
                        email: u.email ?? u.Email ?? '',
                        phoneNumber: u.phoneNumber ?? u.PhoneNumber ?? u.phone_number ?? '',
                        estado: u.estado ?? u.Estado ?? 1
                    };

                    try {
                        const arr = await $.getJSON(`${USERS_URL}/${baseUser.id}/roles`);
                        const roles = Array.isArray(arr) ? arr.map(U) : [];
                        return { ...baseUser, roles };
                    } catch {
                        try {
                            const obj = await $.getJSON(`${USERS_URL}/${baseUser.id}/role`);
                            const roleName = obj?.role ?? obj?.Role;
                            const roles = roleName ? [U(roleName)] : [];
                            return { ...baseUser, roles };
                        } catch {
                            return { ...baseUser, roles: [] };
                        }
                    }
                });

                allUsers = await Promise.all(roleFetches);
                populateRoleFilter();
                currentPage = 1;
                refreshTable();
            } catch (e) {
                console.error(e);
                $('#userTable').html(`<tr><td colspan="8" class="text-danger">Error cargando usuarios</td></tr>`);
                $('#resultsBadge').text(`Mostrando 0 de 0`);
                $pageInfo.text('0 / 0');
                $prevPageItem.addClass('disabled');
                $nextPageItem.addClass('disabled');
            }
        }

        // ---------- EXPORTAR EXCEL ----------
        window.exportToExcel = function () {
            const rows = applyFilters();
            if (!rows.length) {
                Modal.show({ titleText:'Sin datos', bodyText:'No hay datos para exportar.', kind:'info', confirmText:'Aceptar' });
                return;
            }

            const data = rows.map(u => ({
                "Username": u.userNameNorm || U(u.userName),
                "Email": u.email || '',
                "Teléfono": u.phoneNumber || '',
                "Estado": formatEstado(u.estado),
                "Rol": (u.roles && u.roles.length) ? u.roles.join(' | ') : '(SIN ROL)'
            }));

            const ws = XLSX.utils.json_to_sheet(data);

            const header = ws['!rows'] || [];
            header[0] = { hpt: 30 };

            ws['A1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };
            ws['B1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };
            ws['C1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };
            ws['D1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };
            ws['E1'].s = { fill: { fgColor: { rgb: "FF0000" } }, font: { color: { rgb: "FFFFFF" }, bold: true } };

            ws['!cols'] = [
                { wch: 20 },
                { wch: 30 },
                { wch: 18 },
                { wch: 15 },
                { wch: 25 }
            ];

            const range = XLSX.utils.decode_range(ws['!ref']);
            ws['!autofilter'] = { ref: XLSX.utils.encode_range(range) };

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Usuarios');

            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            const fname = `Usuarios_${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.xlsx`;

            XLSX.writeFile(wb, fname);
        };

        // ---------- DESACTIVAR USUARIO ----------
        async function desactivarUsuario(userId) {
            Modal.confirm({
                titleText: '¿Desactivar usuario?',
                bodyText: 'Este usuario pasará a estado INACTIVO (Estado=2). No se eliminará físicamente.',
                kind: 'warn',
                confirmText: 'Sí, desactivar',
                cancelText: 'Cancelar',
                onConfirmCb: async () => {
                    try {
                        const res = await fetch(`${USERS_URL}/${userId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });

                        if (res.ok) {
                            await loadUsers();
                            Modal.show({ titleText:'Desactivado', bodyText:'Usuario desactivado correctamente.', kind:'ok', confirmText:'Aceptar' });
                            return;
                        }

                        let msg = 'No se pudo desactivar.';
                        try {
                            const err = await res.json();
                            msg = err.message || err.Message || msg;
                        } catch {}

                        Modal.show({ titleText:'Error', bodyText:`Error al desactivar usuario: ${msg}`, kind:'error', confirmText:'Aceptar' });
                    } catch (e) {
                        console.error(e);
                        Modal.show({ titleText:'Error', bodyText:'Error de conexión al desactivar el usuario.', kind:'error', confirmText:'Aceptar' });
                    }
                }
            });
        }
        window.desactivarUsuario = desactivarUsuario;

        $(function () {
            $pageSizeSelect = $('#pageSizeSelect');
            $pageInfo = $('#pageInfo');
            $prevPageBtn = $('#prevPageBtn');
            $nextPageBtn = $('#nextPageBtn');
            $prevPageItem = $('#prevPageItem');
            $nextPageItem = $('#nextPageItem');

            loadRolesList().then(loadUsers);

            $('#roleFilter').on('change', () => { currentPage = 1; refreshTable(); });

            $('#localSearch').on('input', debounce(() => {
                currentPage = 1;
                refreshTable();
            }, 200));

            $('#localSearch').on('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); e.currentTarget.blur(); }
            });

            $('#clearSearch').on('click', () => {
                $('#localSearch').val('');
                currentPage = 1;
                refreshTable();
                $('#localSearch').focus();
            });

            $('#exportBtn').on('click', () => window.exportToExcel());

            $pageSizeSelect.on('change', () => {
                const val = Number($pageSizeSelect.val());
                pageSize = PAGE_SIZES.includes(val) ? val : 5;
                currentPage = 1;
                refreshTable();
            });

            $prevPageBtn.on('click', () => {
                if (currentPage > 1) { currentPage--; refreshTable(); }
            });

            $nextPageBtn.on('click', () => {
                const total = applyFilters().length;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                if (currentPage < totalPages) { currentPage++; refreshTable(); }
            });
        });
    </script>
}
