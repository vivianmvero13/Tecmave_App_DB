@page
@model Front.Pages.Usuarios.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Usuarios Registrados";
}

<h1>Usuarios Registrados</h1>

<div class="row g-3 align-items-end mt-3">
    <div class="col-12 col-md-4">
        <label for="roleFilter" class="form-label">Filtrar por rol</label>
        <select id="roleFilter" class="form-select">
            <option value="">(Todos)</option>
        </select>
    </div>
    <div class="col-12 col-md-8">
        <label for="localSearch" class="form-label">Buscar</label>
        <div class="input-group">
            <input id="localSearch" class="form-control" placeholder="Buscar por username, email, teléfono o rol…" />
            <button id="clearSearch" class="btn btn-outline-secondary" type="button">Limpiar</button>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mt-3">
    <small id="resultsBadge" class="text-muted">Mostrando 0 de 0</small>
    <div class="d-flex gap-2">
        <a id="manageRolesBtn" class="btn btn-royal btn-sm" href="/Roles">Administrar Roles</a>
        <button id="exportBtn" class="btn btn-orange btn-sm" type="button">
            <i class="fa-solid fa-file-excel"></i> Exportar
        </button>
    </div>
</div>

<div class="table-responsive mt-2">
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Apellidos</th>
                <th>Username</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Estado</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="userTable">
            <tr><td colspan="8">Cargando usuarios…</td></tr>
        </tbody>
    </table>
</div>

<!-- Controles de paginación -->
<div class="d-flex justify-content-between align-items-center mt-2">
    <div class="d-flex align-items-center gap-2">
        <label for="pageSizeSelect" class="form-label mb-0">Mostrar:</label>
        <select id="pageSizeSelect" class="form-select form-select-sm" style="width:auto;">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
        </select>
    </div>
    <nav aria-label="Paginación usuarios" class="usuarios-pagination-nav">
        <ul class="pagination pagination-sm mb-0 d-flex flex-row align-items-center gap-2"
            style="list-style:none; margin:0; padding:0;">
            <li class="page-item" id="prevPageItem" style="list-style:none;">
                <button class="page-link" type="button" id="prevPageBtn" aria-label="Anterior">&laquo;</button>
            </li>
            <li class="page-item disabled" style="list-style:none;">
                <span class="page-link" id="pageInfo">1 / 1</span>
            </li>
            <li class="page-item" id="nextPageItem" style="list-style:none;">
                <button class="page-link" type="button" id="nextPageBtn" aria-label="Siguiente">&raquo;</button>
            </li>
        </ul>
    </nav>
</div>

<style>
    .btn-orange {
        background: #9FAA13 !important;
        border: 1px solid #9FAA13 !important;
        color: #fff !important;
    }

        .btn-orange:hover {
            background: #9FAA13 !important;
        }

    .btn-royal {
        background: #C36721 !important;
        border: 1px solid #C36721 !important;
        color: #fff !important;
    }

    /* Paginación usuarios: flecha – número – flecha en línea */
    .usuarios-pagination-nav .pagination {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0.5rem !important;
    }

    .usuarios-pagination-nav .page-item {
        list-style: none !important;
    }

    .usuarios-pagination-nav .page-link {
        display: flex !important;
        align-items: center;
        justify-content: center;
        padding: .35rem .65rem;
        border-radius: 8px;
        cursor: pointer;
    }
</style>

<script>
    const API_BASE = '@(Model?.ApiBase ?? "https://tecmave-api.azurewebsites.net")';
    const USERS_URL = `${API_BASE}/api/usuarios`;
    const ROLES_URL = `${API_BASE}/api/roles`;

    let allUsers = [];
    let allRoleNamesNorm = [];
    const U = s => (s ?? '').toString().trim().toUpperCase();

    // Paginación
    const PAGE_SIZES = [5, 10, 20, 50];
    let pageSize = 5;
    let currentPage = 1;

    let $pageSizeSelect, $pageInfo, $prevPageBtn, $nextPageBtn, $prevPageItem, $nextPageItem;

    function debounce(fn, d = 250) {
        let t;
        return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), d);
        };
    }

    function escapeHtml(s) {
        return String(s ?? '').replaceAll('&', '&amp;')
                              .replaceAll('<', '&lt;')
                              .replaceAll('>', '&gt;')
                              .replaceAll('"', '&quot;')
                              .replaceAll("'", '&#39;');
    }

    async function loadRolesList() {
        try {
            const roles = await $.getJSON(ROLES_URL);
            allRoleNamesNorm = roles
                .map(r => r.normalizedName ?? r.NormalizedName ?? (r.name ? U(r.name) : null))
                .filter(Boolean);
        } catch {
            allRoleNamesNorm = [];
        }
    }

    function populateRoleFilter() {
        const union = new Set([
            ...allRoleNamesNorm,
            ...allUsers.flatMap(u => (u.roles || []).map(U))
        ]);
        const $sel = $('#roleFilter').empty();
        $sel.append(`<option value="">(Todos)</option>`);
        Array.from(union).filter(Boolean).sort().forEach(r =>
            $sel.append(`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`)
        );
    }

    function getSearchText() { return ($('#localSearch').val() || '').toLowerCase(); }

    function formatEstado(e) {
        const v = Number(e);
        switch (v) {
            case 1: return 'Activo';
            case 2: return 'Inactivo';
            default:
                return e == null ? 'Sin estado' : `(${e})`;
        }
    }

    function applyFilters() {
        const selected = $('#roleFilter').val();
        const q = getSearchText();
        return allUsers.filter(u => {
            const roles = Array.isArray(u.roles) ? u.roles.map(U) : [];
            const roleOk = !selected
                ? true
                : (selected === '__SIN_ROL__' ? roles.length === 0 : roles.includes(U(selected)));

            const estadoText = formatEstado(u.estado);

            const haystack = [
                u.userNameNorm || U(u.userName),
                u.email || '',
                u.phoneNumber || '',
                ...roles,
                estadoText
            ].join(' ').toLowerCase();

            return roleOk && (!q || haystack.includes(q));
        });
    }

    function renderTable(pageUsers, total, from, to, page, totalPages) {
        const $tb = $('#userTable').empty();

        if (!total) {
            $tb.html(`<tr><td colspan="8" class="text-muted">No hay usuarios.</td></tr>`);
            $('#resultsBadge').text(`Mostrando 0 de 0`);
            $pageInfo.text('0 / 0');
            $prevPageItem.addClass('disabled');
            $nextPageItem.addClass('disabled');
            return;
        }

        if (!pageUsers.length) {
            $tb.html(`<tr><td colspan="8" class="text-muted">Sin resultados en esta página.</td></tr>`);
        } else {
            pageUsers.forEach(u => {
                const rolesText = (u.roles && u.roles.length) ? u.roles.map(U).join(', ') : '(SIN ROL)';
                const estadoText = formatEstado(u.estado);
                $tb.append(`<tr>
                    <td>${escapeHtml(u.nombre || 'Sin definir')}</td>
                    <td>${escapeHtml(u.apellidos || 'Sin definir')}</td>
                    <td>${escapeHtml(u.userNameNorm || U(u.userName))}</td>
                    <td>${escapeHtml(u.email ?? '')}</td>
                    <td>${escapeHtml(u.phoneNumber ?? '')}</td>
                    <td>${escapeHtml(estadoText)}</td>
                    <td>${escapeHtml(rolesText)}</td>
                    <td>
                        <a class="btn btn-primary btn-sm" href="/Usuarios/Editar/${encodeURIComponent(u.id)}">Editar</a>
                        <button class="btn btn-danger btn-sm ms-1" type="button" onclick="eliminarUsuario(${u.id})">Eliminar</button>
                    </td>
                </tr>`);
            });
        }

        $('#resultsBadge').text(`Mostrando ${from}-${to} de ${total}`);
        $pageInfo.text(`${page} / ${totalPages}`);

        if (page <= 1) {
            $prevPageItem.addClass('disabled');
        } else {
            $prevPageItem.removeClass('disabled');
        }

        if (page >= totalPages) {
            $nextPageItem.addClass('disabled');
        } else {
            $nextPageItem.removeClass('disabled');
        }
    }

    function refreshTable() {
        const filtered = applyFilters();
        const total = filtered.length;

        if (!total) {
            renderTable([], 0, 0, 0, 0, 0);
            return;
        }

        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, total);
        const pageUsers = filtered.slice(startIndex, endIndex);

        renderTable(pageUsers, total, startIndex + 1, endIndex, currentPage, totalPages);
    }

    async function loadUsers() {
        try {
            // 1) Intento optimizado: /api/usuarios/with-role (por si existe)
            try {
                const res = await fetch(`${USERS_URL}/with-role`);
                if (res.ok) {
                    const rows = await res.json();
                    allUsers = rows.map(u => {
                        const userName = u.userName ?? u.UserName ?? u.user_name ?? '';
                        const phone = u.phoneNumber ?? u.PhoneNumber ?? u.phone_number ?? '';
                        const estado = u.estado ?? u.Estado ?? 1;
                        return {
                            id: u.id ?? u.Id,
                            nombre: u.nombre ?? u.Nombre ?? '',
                            apellidos: u.apellidos ?? u.Apellidos ?? '',
                            userName,
                            userNameNorm: U(userName),
                            email: u.email ?? u.Email ?? '',
                            phoneNumber: phone,
                            estado,
                            roles: u.role ? [U(u.role)] : []
                        };
                    });
                    populateRoleFilter();
                    currentPage = 1;
                    refreshTable();
                    return;
                }
            } catch { }

            // 2) Fallback: /api/usuarios
            const users = await $.getJSON(USERS_URL);
            const roleFetches = users.map(async (u) => {
                const baseUser = {
                    id: u.id ?? u.Id,
                    nombre: u.nombre ?? u.Nombre ?? '',
                    apellidos: u.apellidos ?? u.Apellidos ?? '',
                    userName: u.userName ?? u.UserName ?? u.user_name ?? '',
                    userNameNorm: U(u.userName ?? u.UserName ?? u.user_name ?? ''),
                    email: u.email ?? u.Email ?? '',
                    phoneNumber: u.phoneNumber ?? u.PhoneNumber ?? u.phone_number ?? '',
                    estado: u.estado ?? u.Estado ?? 1
                };
                try {
                    const arr = await $.getJSON(`${USERS_URL}/${baseUser.id}/roles`);
                    const roles = Array.isArray(arr) ? arr.map(U) : [];
                    return { ...baseUser, roles };
                } catch {
                    try {
                        const obj = await $.getJSON(`${USERS_URL}/${baseUser.id}/role`);
                        const roleName = obj?.role ?? obj?.Role;
                        const roles = roleName ? [U(roleName)] : [];
                        return { ...baseUser, roles };
                    } catch {
                        return { ...baseUser, roles: [] };
                    }
                }
            });
            allUsers = await Promise.all(roleFetches);
            populateRoleFilter();
            currentPage = 1;
            refreshTable();
        } catch (e) {
            console.error(e);
            $('#userTable').html(`<tr><td colspan="8" class="text-danger">Error cargando usuarios</td></tr>`);
            $('#resultsBadge').text(`Mostrando 0 de 0`);
        }
    }

    // ---------- EXPORTAR A EXCEL  ----------
    function csvEscape(val) {
        const s = (val ?? '').toString();
        if (/[",\n\r;]/.test(s)) {
            return `"${s.replace(/"/g, '""')}"`;
        }
        return s;
    }

    function buildCsv(rows) {
        const headers = ['Username', 'Email', 'Teléfono', 'Estado', 'Rol'];
        const lines = [headers.join(',')];
        rows.forEach(u => {
            const rol = (u.roles && u.roles.length) ? u.roles.join(' | ') : '(SIN ROL)';
            const estadoText = formatEstado(u.estado);
            lines.push([
                csvEscape(u.userNameNorm || U(u.userName)),
                csvEscape(u.email || ''),
                csvEscape(u.phoneNumber || ''),
                csvEscape(estadoText),
                csvEscape(rol)
            ].join(','));
        });
        return '\uFEFF' + lines.join('\r\n');
    }

    window.exportToExcel = function () {
        const rows = applyFilters(); // exporta todo el filtrado, no solo la página
        if (!rows.length) {
            alert('No hay datos para exportar.');
            return;
        }
        const csv = buildCsv(rows);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const fname = `usuarios_${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.csv`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    };

    // ---------- ELIMINAR USUARIO ----------
    async function eliminarUsuario(userId) {
        if (!confirm('⚠️ Vas a ELIMINAR este usuario y todos sus datos relacionados. Esta acción es irreversible. ¿Deseas continuar?')) {
            return;
        }

        const res = await fetch(`${USERS_URL}/${userId}`, { method: 'DELETE' });

        if (res.ok) {
            await loadUsers();
            alert('Usuario eliminado correctamente.');
        } else {
            try {
                const err = await res.json();
                alert(`Error al eliminar usuario: ${err.message || err.Message || 'No se pudo eliminar.'}`);
            } catch {
                alert('No se pudo eliminar el usuario (error desconocido).');
            }
        }
    }

    $(function () {
        // cache de elementos de paginación
        $pageSizeSelect = $('#pageSizeSelect');
        $pageInfo = $('#pageInfo');
        $prevPageBtn = $('#prevPageBtn');
        $nextPageBtn = $('#nextPageBtn');
        $prevPageItem = $('#prevPageItem');
        $nextPageItem = $('#nextPageItem');

        loadRolesList().then(loadUsers);

        $('#roleFilter').on('change', () => {
            currentPage = 1;
            refreshTable();
        });

        $('#localSearch').on('input', debounce(() => {
            currentPage = 1;
            refreshTable();
        }, 200));

        $('#localSearch').on('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.currentTarget.blur();
            }
        });

        $('#clearSearch').on('click', () => {
            $('#localSearch').val('');
            currentPage = 1;
            refreshTable();
            $('#localSearch').focus();
        });

        $('#exportBtn').on('click', () => window.exportToExcel());

        // Eventos de paginación
        $pageSizeSelect.on('change', () => {
            const val = Number($pageSizeSelect.val());
            pageSize = PAGE_SIZES.includes(val) ? val : 5;
            currentPage = 1;
            refreshTable();
        });

        $prevPageBtn.on('click', () => {
            if (currentPage > 1) {
                currentPage--;
                refreshTable();
            }
        });

        $nextPageBtn.on('click', () => {
            const total = applyFilters().length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage < totalPages) {
                currentPage++;
                refreshTable();
            }
        });
    });
</script>
