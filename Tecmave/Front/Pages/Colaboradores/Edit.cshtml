@page "{id:int}"
@model Front.Pages.Colaboradores.EditModel

@{
    ViewData["Title"] = "Editar colaborador";
}



<div id="loadingOverlay" style="display:none;">
    <div class="modal">
        <div class="modal-content">
            <p>Cargando, por favor espere un momento...</p>
        </div>
    </div>
</div>

<section class="section">
    <div class="container">

        <h3 class="mb-3">Editar colaborador</h3>

        <form id="formEditar">

            <!-- IDs -->
            <input type="hidden" id="idColaborador" value="@Model.Id" />
            <input type="hidden" id="idUsuario" />

            <!-- ================= USUARIO ================= -->
            <h5 class="mt-3">Datos del usuario</h5>

            <div class="mb-2">
                <label>Nombre</label>
                <input id="nombre" class="input" required />
            </div>

            <div class="mb-2">
                <label>Apellido</label>
                <input id="apellido" class="input" required />
            </div>

            <div class="mb-2">
                <label>Cédula</label>
                <input id="cedula" class="input" required />
            </div>

            

          

            <!-- ================= COLABORADOR ================= -->
            <h5 class="mt-4">Datos del colaborador</h5>

            <div class="mb-2">
                <label>Puesto</label>
                <input id="puesto" class="input" required />
            </div>

            <div class="mb-2">
                <label>Salario</label>
                <input id="salario" type="number" step="0.01" class="input" required />
            </div>

            <div class="mb-2">
                <label>Fecha contratación</label>
                <input id="fechaContratacion" type="date" class="input" required />
            </div>

            <!-- ================= BOTONES ================= -->
            <div class="mt-3">
                <button class="btn btn-primary">Guardar cambios</button>
                <a href="/Colaboradores" class="btn btn-secondary">Cancelar</a>
            </div>

        </form>

    </div>
</section>



<script>
    const ID_COLABORADOR = @Model.Id;

     const API_COLABORADOR = "https://tecmave-api.azurewebsites.net/colaboradores";
     const API_USUARIOS = "https://tecmave-api.azurewebsites.net/api/usuarios";

    let idUsuario = 0;

    $(document).ready(function () {
        cargarDatos();
        $("#formEditar").on("submit", guardarCambios);
    });

    async function cargarDatos() {
         mostrarLoading();
        try {
            
            const colab = await $.get(`${API_COLABORADOR}/${ID_COLABORADOR}`);

            $("#puesto").val(colab.puesto);
            $("#salario").val(colab.salario);
            $("#fechaContratacion").val(colab.fecha_contratacion);

            idUsuario = colab.id_usuario;
            $("#idUsuario").val(idUsuario);

            
            const usuario = await $.get(`${API_USUARIOS}/${idUsuario}`);

            $("#nombre").val(usuario.nombre);
            $("#apellido").val(usuario.apellidos);
            $("#cedula").val(usuario.cedula);
            

            

        } catch (e) {
            alert("Error cargando datos");
            console.error(e);
        } finally {
        ocultarLoading();
    }
   }

    async function guardarCambios(e) {
        e.preventDefault();

          mostrarLoading();

            const payload = {
        id_colaborador: ID_COLABORADOR,
    id_usuario: idUsuario,

    nombre: $("#nombre").val(),
    apellido: $("#apellido").val(),
    cedula: $("#cedula").val(),

    puesto: $("#puesto").val(),
    salario: parseFloat($("#salario").val()),
    fecha_contratacion: $("#fechaContratacion").val()
    };

        try {
            await $.ajax({
                url: `${API_COLABORADOR}/editar-completo`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(payload)
            });

            alert("Cambios guardados correctamente");
            window.location.href = "/Colaboradores";

        } catch (e) {
            alert("Error al guardar cambios");
            console.error(e);
         }finally {
         ocultarLoading();
     }
    }

     function mostrarLoading() { $("#loadingOverlay").show(); }
     function ocultarLoading() { $("#loadingOverlay").hide(); }

</script>
