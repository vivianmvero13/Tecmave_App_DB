@page
@model Front.Pages.Colaboradores.IndexModel
@{
    ViewData["Title"] = "Gestión de Colaboradores";
}

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<section class="section">
    <div class="container grid cols-2">

        <!-- Formulario de nuevo colaborador + usuario -->
        <div class="card">
            <h3>Nuevo Usuario + Colaborador</h3>

            <div class="form-row">
                <div>
                    <label>Nombre</label>
                    <input class="input" id="nombre" type="text" />
                </div>
                <div>
                    <label>Apellido</label>
                    <input class="input" id="apellido" type="text" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Email</label>
                    <input class="input" id="email" type="email" />
                </div>
                <div>
                    <label>Username</label>
                    <input class="input" id="UserName" type="text" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Rol</label>
                    <select class="input" id="rol">
                        <option value="">Seleccione Rol</option>
                        <option value="Admin">Admin</option>
                        <option value="Colaborador">Colaborador</option>
                        <option value="Gerente">Gerente</option>
                    </select>
                </div>
            </div>

            <hr />

            <div class="form-row">
                <div>
                    <label>Puesto</label>
                    <input class="input" id="puesto" type="text" />
                </div>
                <div>
                    <label>Salario</label>
                    <input class="input" id="salario" type="number" step="0.01" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Fecha Contratación</label>
                    <input class="input" id="fecha_contratacion" type="date" />
                </div>
            </div>

            <button id="btnAgregarUsuarioColaborador">Crear Usuario y Colaborador</button>
        </div>

        <!-- Tabla de colaboradores -->
        <div class="card">
            <h3>Lista de Colaboradores</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Puesto</th>
                        <th>Salario</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</section>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">

<!-- iziToast JS -->
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
<script>

    const API_COLABORADOR = "https://tecmave-api.azurewebsites.net/colaboradores";
    const API_USUARIOS = "https://tecmave-api.azurewebsites.net/api/usuarios";

    let cacheUsuarios = {};

    /* ============================
       CARGAR USUARIOS EN CACHE
    ==============================*/
    function cargarUsuarios() {
        return $.get(API_USUARIOS, function (usuarios) {
            cacheUsuarios = {};
            usuarios.forEach(u => cacheUsuarios[u.id] = u);
        }).fail(xhr => {
            Swal.fire("Error", "No se pudieron cargar los usuarios", "error");
        });
    }

    /* ============================
       CARGAR COLABORADORES TABLA
    ==============================*/
    function cargarColaboradores() {
        $.get(API_COLABORADOR, function (data) {

            $("table tbody").empty();

            data.forEach(c => {
                const u = cacheUsuarios[c.id_usuario];

                $("table tbody").append(`
                    <tr>
                        <td>${u ? `${u.nombre} ${u.apellidos}` : "Desconocido"}</td>
                        <td>${c.puesto}</td>
                        <td>${c.salario}</td>
                        <td>${c.fecha_contratacion}</td>
                        <td>
                            <button class="danger" onclick="eliminarColaborador(${c.id_colaborador})">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `);
            });

        }).fail(xhr => {
            Swal.fire("Error", "No se pudieron cargar los colaboradores", "error");
        });
    }

    /* ============================
           ELIMINAR COLABORADOR
    ==============================*/
    function eliminarColaborador(id) {

        Swal.fire({
            title: "¿Eliminar colaborador?",
            text: "Esta acción no se puede revertir.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
            confirmButtonColor: "#d33"
        }).then(result => {

            if (!result.isConfirmed) return;

            $.ajax({
                url: `${API_COLABORADOR}?id=${id}`,
                method: "DELETE",
                success: () => {

                    Swal.fire({
                        icon: "success",
                        title: "Eliminado",
                        text: "El colaborador fue eliminado",
                        timer: 1800,
                        showConfirmButton: false
                    });

                    cargarColaboradores();
                },
                error: (xhr) => {
                    Swal.fire("Error", xhr.responseText, "error");
                }
            });

        });
    }

    /* ============================
       CREAR USUARIO + COLABORADOR
    ==============================*/
                function agregarUsuarioColaborador() {

        const dto = {
            Nombre: $("#nombre").val(),
            Apellido: $("#apellido").val(),
            UserName: $("#UserName").val(),  // <-- ESTA ES LA CORRECCIÓN
            Email: $("#email").val(),
            Rol: $("#rol").val(),

            Colaboradores: {
                puesto: $("#puesto").val(),
                salario: parseFloat($("#salario").val()),
                fecha_contratacion: $("#fecha_contratacion").val()
            }
        };

        console.log("Enviando DTO:", dto);

        $.ajax({
            url: API_COLABORADOR,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(dto),
            success: () => {
                iziToast.success({
                    title: "Éxito",
                    message: "Usuario + Colaborador creado correctamente"
                });

                cargarColaboradores();
            },
            error: (xhr) => {
                iziToast.error({
                    title: "Error",
                    message: xhr.responseText
                });
                console.error("Error:", xhr.responseText);
            }
        });
    }




    /* ============================
            DOCUMENT READY
    ==============================*/
    $(document).ready(function () {
        cargarUsuarios().then(() => cargarColaboradores());

        $("#btnAgregarUsuarioColaborador")
            .on("click", agregarUsuarioColaborador);
    });

</script>
