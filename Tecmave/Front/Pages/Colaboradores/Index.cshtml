@page
@model Front.Pages.Colaboradores.IndexModel
@{
    ViewData["Title"] = "Colaboradores";
}

<section class="section">
    <div class="container">

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h3>Colaboradores</h3>

            <a href="/Colaboradores/Crear" class="btn btn-primary">
                + Nuevo colaborador
            </a>
        </div>

        
        <input type="text"
               id="filtroNombre"
               class="input mb-2"
               placeholder="Buscar por nombre..." />

       
        <div class="table-responsive mt-2">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Cédula</th>
                        <th>Puesto</th>
                        <th>Salario</th>
                        <th>Fecha</th>
                        <th style="width:160px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaColaboradores">
                    <tr>
                        <td colspan="7">Cargando colaboradores…</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</section>

<div id="loadingOverlay" style="display:none;">
    <div class="modal">
        <div class="modal-content">
            <p>Cargando, por favor espere un momento...</p>
        </div>
    </div>
</div>

<script>
    const API_COLABORADOR = "https://tecmave-api.azurewebsites.net/colaboradores";
    const API_USUARIOS = "https://tecmave-api.azurewebsites.net/api/usuarios";

    let colaboradores = [];
    let usuarios = {};

    async function cargarDatos() {

        const [colabs, users] = await Promise.all([
            $.get(API_COLABORADOR),
            $.get(API_USUARIOS)
        ]);

        usuarios = {};
        users.forEach(u => usuarios[u.id] = u);

        colaboradores = colabs;

        renderTabla(colaboradores);
    }

    function renderTabla(data) {

        const tbody = $("#tablaColaboradores");
        tbody.empty();

        if (data.length === 0) {
            tbody.append(`<tr><td colspan="7">No hay colaboradores</td></tr>`);
            return;
        }

        data.forEach(c => {
            const u = usuarios[c.id_usuario];

            tbody.append(`
                <tr>
                    <td>${c.id_colaborador}</td>
                    <td>${u ? `${u.nombre} ${u.apellidos}` : "N/A"}</td>
                    <td>${u?.cedula ?? "N/A"}</td>
                    <td>${c.puesto}</td>
                    <td>${c.salario}</td>
                    <td>${c.fecha_contratacion}</td>
                    <td>
                        <a href="/Colaboradores/Edit/${c.id_colaborador}" class="btn btn-sm btn-secondary">
                                 Editar
                             </a>
                        <button class="btn btn-danger btn-sm"
                            onclick="eliminar(${c.id_colaborador})">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    $("#filtroNombre").on("keyup", function () {
        const texto = $(this).val().toLowerCase();

        const filtrados = colaboradores.filter(c => {
            const u = usuarios[c.id_usuario];
            if (!u) return false;
            return `${u.nombre} ${u.apellido}`.toLowerCase().includes(texto);
        });

        renderTabla(filtrados);
    });

        function eliminar(id) {

        mostrarLoading();

        $.ajax({
            url: `${API_COLABORADOR}/${id}`,
            method: "DELETE",
            success: () => {
                cargarDatos();
            },
            error: () => {
                alert("No se pudo eliminar el colaborador");
            },
            complete: () => {
                ocultarLoading();
            }
        });
    }

    $(document).ready(cargarDatos);

    function mostrarLoading() { $("#loadingOverlay").show(); }
    function ocultarLoading() { $("#loadingOverlay").hide(); }
</script>
