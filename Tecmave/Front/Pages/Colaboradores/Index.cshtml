@page
@model Front.Pages.Colaboradores.IndexModel
@{
    Layout = "_Layout";
}

<h2>Colaboradores</h2>

<button id="btnNuevo" class="btn btn-primary mb-3">Nuevo colaborador</button>

<table class="table table-striped" id="tblColaboradores">
    <thead>
        <tr>
            <th>Cédula</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Teléfono</th>
            <th>Correo</th>
            <th>Puesto</th>
            <th>Salario</th>
            <th></th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="modal fade" id="modalCrear" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo colaborador</h5>
            </div>
            <div class="modal-body">

                <input id="cedula" class="form-control mb-2" placeholder="Cédula">
                <input id="nombre" class="form-control mb-2" placeholder="Nombre">
                <input id="apellido" class="form-control mb-2" placeholder="Apellido">
                <input id="telefono" class="form-control mb-2" placeholder="Teléfono">
                <input id="email" class="form-control mb-2" placeholder="Correo">
                <hr>
                <input id="puesto" class="form-control mb-2" placeholder="Puesto">
                <input id="salario" class="form-control mb-2" placeholder="Salario">

            </div>
            <div class="modal-footer">
                <button id="btnGuardar" class="btn btn-success">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    const api = "@Model.ApiBase/colaboradores";

    function cargar() {
        fetch(api)
            .then(r => r.json())
            .then(data => {
                let rows = "";
                data.forEach(c => {
                    rows += `
                    <tr>
                        <td>${c.cedula}</td>
                        <td>${c.nombre}</td>
                        <td>${c.apellido}</td>
                        <td>${c.telefono}</td>
                        <td>${c.email}</td>
                        <td>${c.puesto}</td>
                        <td>${c.salario}</td>
                        <td><a href="/Colaboradores/Editar?id=${c.id_colaborador}" class="btn btn-warning">Editar</a></td>
                    </tr>`;
                });
                document.querySelector("#tblColaboradores tbody").innerHTML = rows;
            });
    }

    function validar() {
        const rCed = /^\d{9}$/;
        const rTel = /^\d{8}$/;
        const rMail = /^[^@]+@[^@]+\.[a-zA-Z]{2,}$/;

        if (!rCed.test(cedula.value)) return false;
        if (!rTel.test(telefono.value)) return false;
        if (!rMail.test(email.value)) return false;

        return true;
    }

    btnNuevo.onclick = () => new bootstrap.Modal(modalCrear).show();

    btnGuardar.onclick = () => {
        if (!validar()) return alert("Datos inválidos");

        const body = {
            cedula: cedula.value,
            nombre: nombre.value,
            apellido: apellido.value,
            telefono: telefono.value,
            email: email.value,
            puesto: puesto.value,
            salario: parseFloat(salario.value),
            rol: "Colaborador"
        };

        fetch(api, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        })
        .then(r => {
            cargar();
            bootstrap.Modal.getInstance(modalCrear).hide();
        });
    };

    cargar();
</script>
