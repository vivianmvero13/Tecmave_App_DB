@page
@model Front.Pages.Colaboradores.IndexModel
@{
    ViewData["Title"] = "Colaboradores";
}

<section class="section">
    <div class="container">

        <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="card">
            <h3>Colaboradores</h3>

            <a href="/Colaboradores/Crear" class="btn btn-primary">
                + Nuevo colaborador
            </a>
        </div>

        <!-- FILTRO -->
        <input type="text"
               id="filtroNombre"
               class="input mb-2"
               placeholder="Buscar por nombre..." />
        <!-- TABLA -->
        <div class="table-responsive mt-2">
            <table class="table align-middle">
        <div class="card">
            <h3>Lista de Colaboradores</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Cédula</th>
                        <th>Puesto</th>
                        <th>Salario</th>
                        <th>Fecha</th>
                        <th style="width:160px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaColaboradores">
                    <tr>
                        <td colspan="7">Cargando colaboradores…</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</section>

<script>
    let colaboradores = [];
    let usuarios = {};
    const API_USUARIOS = "http://localhost:7096/api/usuarios";
    async function cargarDatos() {

        const [colabs, users] = await Promise.all([
            $.get(API_COLABORADOR),
            $.get(API_USUARIOS)
        ]);

        usuarios = {};
        users.forEach(u => usuarios[u.id] = u);

        colaboradores = colabs;

        renderTabla(colaboradores);
        }).fail(() => {
            Swal.fire("Error", "No se pudieron cargar los usuarios", "error");
    function renderTabla(data) {

        const tbody = $("#tablaColaboradores");
        tbody.empty();
    // ============================
        if (data.length === 0) {
            tbody.append(`<tr><td colspan="7">No hay colaboradores</td></tr>`);
            return;
        }

        data.forEach(c => {
            const u = usuarios[c.id_usuario];

            tbody.append(`
                <tr>
                    <td>${c.id_colaborador}</td>
                    <td>${u ? `${u.nombre} ${u.apellidos}` : "N/A"}</td>
                    <td>${u?.cedula ?? "N/A"}</td>
                    <td>${c.puesto}</td>
                    <td>${c.salario}</td>
                    <td>${c.fecha_contratacion}</td>
                    <td>
                     <a href="/Colaboradores/Edit/${c.id_colaborador}"
                            class="btn btn-warning btn-sm me-1">
                            Editar
                     </a>
                        <button class="btn btn-danger btn-sm"
                            onclick="eliminar(${c.id_colaborador})">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `);
        });
        }).fail(() => {
            Swal.fire("Error", "No se pudieron cargar los colaboradores", "error");
    $("#filtroNombre").on("keyup", function () {
        const texto = $(this).val().toLowerCase();
            confirmButtonText: "Sí, eliminar",
        const filtrados = colaboradores.filter(c => {
            const u = usuarios[c.id_usuario];
            if (!u) return false;
            return `${u.nombre} ${u.apellidos}`.toLowerCase().includes(texto);
                },
                error: (xhr) => {
        renderTabla(filtrados);
    });

    function eliminar(id) {
        if (!confirm("¿Eliminar colaborador?")) return;
                    return costoHora * 8 * diasMes;
        $.ajax({
            url: `${API_COLABORADOR}/${id}`,
            method: "DELETE",
            success: cargarDatos
                cargarUsuarios().then(() => cargarColaboradores());
            },
    // ============================
    $(document).ready(cargarDatos);
</script>    $(document).ready(function () {

        cargarUsuarios().then(() => cargarColaboradores());

        $("#btnAgregarUsuarioColaborador").on("click", agregarUsuarioColaborador);
    });
</script>
