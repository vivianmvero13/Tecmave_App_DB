@page
@model Front.Pages.Colaboradores.IndexModel
@{
    ViewData["Title"] = "Gestión de Colaboradores";
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .swal2-deny { display: none !important; }
    .swal2-cancel {
        background-color: #d33 !important;
        color: white !important;
        border: none !important;
        padding: 10px 25px !important;
        font-size: 16px !important;
        border-radius: 6px !important;
    }
    .swal2-confirm {
        background-color: #28a745 !important;
        color: white !important;
        border: none !important;
        padding: 10px 25px !important;
        font-size: 16px !important;
        border-radius: 6px !important;
    }
    .swal2-actions {
        gap: 20px !important;
    }
</style>

<section class="section">
    <div class="container grid cols-2">

        <div class="card">
            <h3>Colaboradores</h3>

            <div class="form-row">
                <div>
                    <label>Nombre</label>
                    <input class="input" id="nombre" type="text" />
                </div>
                <div>
                    <label>Apellido</label>
                    <input class="input" id="apellido" type="text" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Cédula</label>
                    <input class="input" id="cedula" type="text" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Dirección</label>
                    <input class="input" id="direccion" type="text" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Teléfono</label>
                    <input class="input" id="telefono" type="text" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Email</label>
                    <input class="input" id="email" type="email" />
                </div>
                <div>
                    <label>Username</label>
                    <input class="input" id="UserName" type="text" />
                </div>
            </div>

            <input type="hidden" id="rol" value="Colaborador" />

            <hr />

            <div class="form-row">
                <div>
                    <label>Puesto</label>
                    <input class="input" id="puesto" type="text" />
                </div>
                <div>
                    <label>Costo por hora</label>
                    <input class="input" id="salario" type="number" step="0.01" />
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Fecha Contratación</label>
                    <input class="input" id="fecha_contratacion" type="date" />
                </div>
            </div>

            <button id="btnAgregarUsuarioColaborador">Crear Usuario y Colaborador</button>
        </div>

        <div class="card">
            <h3>Lista de Colaboradores</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Cédula</th>
                        <th>Puesto</th>
                        <th>Salario</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</section>

<script>
    const API_COLABORADOR = "https://tecmave-api.azurewebsites.net/colaboradores";
    const API_USUARIOS = "https://tecmave-api.azurewebsites.net/api/usuarios";

    let cacheUsuarios = {};
    let colaboradorEnEdicion = null;

    // =============================
    // VALIDACIONES
    // =============================
    const cedulaInput = $("#cedula");
    const cedulaRegex = /^[1-9]\d{8}$/;

    function validarCedula() {
        const ced = cedulaInput.val().trim();
        if (!cedulaRegex.test(ced)) {
            Swal.fire({
                icon: "warning",
                title: "Cédula inválida",
                text: "La cédula debe tener 9 dígitos y no iniciar en 0.",
                timer: 2000,
                showConfirmButton: false
            });
            return false;
        }
        return true;
    }

    const telefonoInput = $("#telefono");
    const phoneRegex = /^[246789]\d{7}$/;

    function validarTelefono() {
        const tel = telefonoInput.val().trim();
        if (!phoneRegex.test(tel)) {
            Swal.fire({
                icon: "warning",
                title: "Teléfono inválido",
                text: "Debe contener 8 dígitos válidos de Costa Rica.",
                timer: 2000,
                showConfirmButton: false
            });
            return false;
        }
        return true;
    }

    const emailInput = $("#email");
    const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;

    function validarEmail() {
        const email = emailInput.val().trim();
        if (!emailRegex.test(email)) {
            Swal.fire({
                icon: "warning",
                title: "Correo inválido",
                text: "Debe escribir un correo válido.",
                timer: 2000,
                showConfirmButton: false
            });
            return false;
        }
        return true;
    }

    // =============================
    // CARGAR USUARIOS
    // =============================
    function cargarUsuarios() {
        return $.get(API_USUARIOS, function (usuarios) {
            cacheUsuarios = {};
            usuarios.forEach(u => cacheUsuarios[u.id] = u);
        });
    }

    // =============================
    // CARGAR COLABORADORES
    // =============================
    function cargarColaboradores() {
        $.get(API_COLABORADOR, function (data) {
            const tbody = $("table tbody");
            tbody.empty();

            data.forEach(c => {
                const u = cacheUsuarios[c.id_usuario];

                const fila = `
                    <tr>
                        <td>${u ? u.nombre + " " + u.apellidos : "Desconocido"}</td>
                        <td>${u ? u.cedula : "N/A"}</td>
                        <td>${c.puesto}</td>
                        <td>${c.salario}</td>
                        <td>${c.fecha_contratacion}</td>
                        <td>
                            <button class="warning" onclick="editarColaborador(${c.id_colaborador})">Editar</button>
                            <button class="danger" onclick="eliminarColaborador(${c.id_colaborador})">Eliminar</button>
                        </td>
                    </tr>`;

                tbody.append(fila);
            });
        });
    }

    // =============================
    // ELIMINAR COLABORADOR
    // =============================
    function eliminarColaborador(id) {
        Swal.fire({
            title: "¿Deseas eliminar este colaborador?",
            text: "Esta acción no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sí",
            cancelButtonText: "Cancelar"
        }).then(result => {

            if (result.isConfirmed) {
                $.ajax({
                    url: `${API_COLABORADOR}/${id}`,
                    method: "DELETE",
                    success: () => {
                        Swal.fire({
                            title: "Eliminado",
                            text: "El colaborador ha sido eliminado.",
                            icon: "success",
                            timer: 1600,
                            showConfirmButton: false
                        });
                        cargarUsuarios().then(() => cargarColaboradores());
                    }
                });
            }
        });
    }

    // =============================
    // GUARDAR COLABORADOR
    // =============================
    function guardarColaborador() {

        if (!validarCedula()) return;
        if (!validarTelefono()) return;
        if (!validarEmail()) return;

        const salarioMensual = parseFloat($("#salario").val()) * 8 *
            new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();

        const dto = {
            id_usuario: colaboradorEnEdicion ? colaboradorEnEdicion.id_usuario : undefined,
            nombre: $("#nombre").val(),
            apellido: $("#apellido").val(),
            cedula: $("#cedula").val(),
            direccion: $("#direccion").val(),
            telefono: $("#telefono").val(),
            user_name: $("#UserName").val(),
            email: $("#email").val(),
            rol: $("#rol").val(),
            colaboradores: {
                puesto: $("#puesto").val(),
                salario: salarioMensual,
                fecha_contratacion: $("#fecha_contratacion").val()
            }
        };

        if (colaboradorEnEdicion) {

            $.ajax({
                url: `${API_COLABORADOR}/${colaboradorEnEdicion.id_colaborador}`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(dto),
                success: () => {
                    Swal.fire({
                        title: "Actualizado",
                        text: "Colaborador actualizado correctamente.",
                        icon: "success",
                        timer: 1600,
                        showConfirmButton: false
                    });

                    limpiarFormulario();
                    colaboradorEnEdicion = null;
                    $("#btnAgregarUsuarioColaborador").text("Crear Usuario y Colaborador");
                    cargarUsuarios().then(() => cargarColaboradores());
                }
            });

        } else {

            $.ajax({
                url: API_COLABORADOR,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(dto),
                success: () => {
                    Swal.fire({
                        title: "Éxito",
                        text: "Colaborador creado correctamente.",
                        icon: "success",
                        timer: 1600,
                        showConfirmButton: false
                    });

                    limpiarFormulario();
                    cargarUsuarios().then(() => cargarColaboradores());
                }
            });
        }
    }

    // =============================
    // EDITAR COLABORADOR
    // =============================
    function editarColaborador(id) {
        $.get(`${API_COLABORADOR}/${id}`, function (c) {
            const u = cacheUsuarios[c.id_usuario];

            $("#nombre").val(u.nombre);
            $("#apellido").val(u.apellidos);
            $("#cedula").val(u.cedula);
            $("#direccion").val(u.direccion);
            $("#telefono").val(u.telefono);
            $("#UserName").val(u.user_name);
            $("#email").val(u.email);
            $("#puesto").val(c.puesto);

            const salarioHora = c.salario /
                (8 * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate());

            $("#salario").val(salarioHora);
            $("#fecha_contratacion").val(c.fecha_contratacion);

            colaboradorEnEdicion = {
                id_colaborador: c.id_colaborador,
                id_usuario: c.id_usuario
            };

            $("#btnAgregarUsuarioColaborador").text("Actualizar Colaborador");
        });
    }

    // =============================
    // LIMPIAR FORMULARIO
    // =============================
    function limpiarFormulario() {
        $("#nombre, #apellido, #cedula, #direccion, #telefono, #UserName, #email, #puesto, #salario, #fecha_contratacion").val("");
        colaboradorEnEdicion = null;
        $("#rol").val("Colaborador");
        $("#btnAgregarUsuarioColaborador").text("Crear Usuario y Colaborador");
    }

    // =============================
    // DOCUMENT READY
    // =============================
    $(document).ready(function () {
        cargarUsuarios().then(() => cargarColaboradores());
        $("#btnAgregarUsuarioColaborador").on("click", guardarColaborador);
    });
</script>
