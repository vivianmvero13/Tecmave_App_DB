@page
@model Front.Pages.Account.ResetPasswordModel
@{
    ViewData["Title"] = "Restablecer contraseña";
    Layout = "~/Pages/Shared/_AccountLayout.cshtml";
}

<div class="login-v2-form-header">
    <img src="~/img/tecmave_logo_innovacion.jpg"
         alt="Tecmave Logo"
         class="login-v2-form-logo">

    <h1>Restablecer Contraseña</h1>
    <p>Ingresa tu nueva contraseña para continuar.</p>
</div>

<form method="post" class="login-v2-form">

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <input type="hidden" asp-for="Email" />
    <input type="hidden" asp-for="Token" />

    <div class="login-v2-input-group">
        <label>Nueva contraseña</label>
        <input asp-for="NewPassword"
               id="newPassword"
               class="form-control"
               type="password"
               required />
        <span asp-validation-for="NewPassword" class="text-danger"></span>
        <small id="passwordHelp" style="color:red;"></small>
    </div>

    <div class="login-v2-input-group">
        <label>Confirmar contraseña</label>
        <input id="newPassword2"
               class="form-control"
               type="password"
               required />
        <small id="passwordMatchHelp" style="color:red;"></small>
    </div>

    <button type="submit" class="login-v2-button mt-3" id="btnSubmit">
        Restablecer
    </button>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <p class="text-success mt-3">@Model.Message</p>
    }

    <p class="text-center mt-3">
        <a href="/Account/Login" class="login-v2-create-account">Volver al login</a>
    </p>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>

        // Inputs
        const passwordInput = $("#newPassword");
        const password2Input = $("#newPassword2");
        const passwordHelp = $("#passwordHelp");
        const passwordMatchHelp = $("#passwordMatchHelp");
        const btnSubmit = $("#btnSubmit");

        // Función de validación (igual que en Register)
        function validatePasswordStrength(password) {
            const minLength = 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!#$%^&*(),.?":{}|<>_]/.test(password);

            let message = "";
            if (password.length < minLength) message += `Debe tener al menos ${minLength} caracteres. `;
            if (!hasUppercase) message += "Debe tener al menos una mayúscula. ";
            if (!hasNumber) message += "Debe tener un número. ";
            if (!hasSpecial) message += "Debe tener un carácter especial. ";

            return message;
        }

        // Cuando se escribe en la contraseña
        passwordInput.on("input", () => {
            passwordHelp.text(validatePasswordStrength(passwordInput.val()));
            validarSubmit();
        });

        // Confirmación de contraseña
        password2Input.on("input", () => {
            if (passwordInput.val() !== password2Input.val()) {
                passwordMatchHelp.text("Las contraseñas no coinciden.");
            } else {
                passwordMatchHelp.text("");
            }
            validarSubmit();
        });

        // Habilitar botón solo si todo es válido
        function validarSubmit() {
            const passOk = passwordHelp.text().length === 0;
            const pass2Ok = passwordMatchHelp.text().length === 0;

            btnSubmit.prop("disabled", !(passOk && pass2Ok));
        }

        // Iniciar con botón deshabilitado
        btnSubmit.prop("disabled", true);

    </script>
}
