@page
@using Front.Pages.Account;
@model Front.Pages.Account.RegisterModel
@{
    ViewData["Title"] = "Login";
    Layout = "~/Pages/Shared/_AccountLayout.cshtml";
}

<div class="login-v2-right">
    <div class="login-v2-form-container">
        <div class="login-v2-form-header">
            <img src="/img/tecmave_logo_innovacion.jpg" alt="Happy Hive Logo" class="login-v2-form-logo">
            <h1>Crear Cuenta</h1>
            <p>Regístrate para acceder a todos los servicios</p>
        </div>
  <form asp-route-returnUrl="@Model.ReturnUrl" method="post" class="login-v2-form">
            <div class="login-v2-input-group">
        <label asp-for="Register.Nombre">Nombre</label>
        <input asp-for="Register.Nombre" type="text" required />
    </div>
    <div class="login-v2-input-group">
        <label asp-for="Register.Apellido">Apellido</label>
        <input asp-for="Register.Apellido" type="text" required />
    </div>
    <div class="login-v2-input-group">
        <label asp-for="Register.Cedula">Cédula</label>
        <input asp-for="Register.Cedula" type="text" required />
    </div>
    <div class="login-v2-input-group">
        <label asp-for="Register.Direccion">Dirección</label>
        <input asp-for="Register.Direccion" type="text" required />
    </div>
    <div class="login-v2-input-group">
        <label asp-for="Register.PhoneNumber">Teléfono</label>
        <input asp-for="Register.PhoneNumber" type="tel" required />
    </div>
    <div class="login-v2-input-group">
        <label asp-for="Register.Email">Correo Electrónico</label>
        <input asp-for="Register.Email" type="email" required />
    </div>
    <div class="login-v2-input-group">
        <label asp-for="Register.Password">Contraseña</label>
        <input asp-for="Register.Password" type="password" required minlength="8" id="password" />
        <small id="passwordHelp" style="color:red;"></small>
    </div>
    <div class="login-v2-input-group">
        <label asp-for="Register.Password2">Confirmar Contraseña</label>
        <input asp-for="Register.Password2" type="password" required minlength="8" id="password2" />
        <small id="passwordMatchHelp" style="color:red;"></small>
    </div>
    <button type="submit" class="login-v2-button">Crear Cuenta</button>
    <p>
        ¿Ya tienes cuenta?
        <a href="/Account/Login" class="login-v2-create-account"> Inicia sesion</a>
    </p>
  </form>

    </div>
</div>

<script>
  
    const passwordInput = $("#password");
    const password2Input = $("#password2");
    const passwordHelp = $("#passwordHelp");
    const passwordMatchHelp = $("#passwordMatchHelp");

    function validatePasswordStrength(password) {
        const minLength = 8;
        const hasUppercase = /[A-Z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasSpecial = /[!#$%^&*(),.?":{}|<>_]/.test(password);

        let message = "";
        if (password.length < minLength) message += `Debe tener al menos ${minLength} caracteres. `;
        if (!hasUppercase) message += "Debe tener al menos una mayúscula. ";
        if (!hasNumber) message += "Debe tener al menos un número. ";
        if (!hasSpecial) message += "Debe tener al menos un carácter especial. ";

        return message;
    }

    passwordInput.on("input", () => {
        passwordHelp.text(validatePasswordStrength(passwordInput.val()));
        validarSubmit();
    });

    password2Input.on("input", () => {
        if (passwordInput.val() !== password2Input.val()) {
            passwordMatchHelp.text("Las contraseñas no coinciden.");
        } else {
            passwordMatchHelp.text("");
        }
        validarSubmit();
    });


    
    const telefonoInput = $("#Register_PhoneNumber");
    const telefonoHelp = $("<small style='color:red'></small>");
    telefonoInput.parent().append(telefonoHelp);

    const phoneRegex = /^[246789]\d{7}$/;

    telefonoInput.on("input", function () {
        const tel = telefonoInput.val().trim();

        if (!phoneRegex.test(tel)) {
            telefonoHelp.text("Formato inválido. Debe ser un número de Costa Rica de 8 dígitos.");
            telefonoInput.data("valid", false);
        } else {
            telefonoHelp.text("");
            telefonoInput.data("valid", true);
        }

        validarSubmit();
    });



    const cedulaInput = $("#Register_Cedula");
    const cedulaHelp = $("<small style='color:red'></small>");
    cedulaInput.parent().append(cedulaHelp);

    const cedulaRegex = /^[1-9]\d{8}$/;

    cedulaInput.on("input", function () {
        const cedula = cedulaInput.val().trim();

        // Validación de formato
        if (!cedulaRegex.test(cedula)) {
            cedulaHelp.text("Formato de cédula inválido. Ejemplo: 703000893");
            cedulaInput.data("valid", false);
            validarSubmit();
            return;
        }
            cedulaHelp.text("");
            cedulaInput.data("valid", true);
            validarSubmit();
/*
        cedulaHelp.text("Verificando cédula…");

        // ======= AJAX a tu API =======
        $.ajax({
            url: `http://localhost:7504/cedula=${cedula}`,
            method: "GET",
            success: function (data) {
                // Si la API devuelve datos válidos
                if (data && data.nombre) {
                    cedulaHelp.text(""); // válida
                    cedulaInput.data("valid", true);
                } else {
                    cedulaHelp.text("La cédula no existe en el registro civil.");
                    cedulaInput.data("valid", false);
                }
                validarSubmit();
            },
            error: function () {
                cedulaHelp.text("No se pudo verificar la cédula (API no responde).");
                cedulaInput.data("valid", false);
                validarSubmit();
            }
        });
        */
    });


    
    const btnSubmit = $(".login-v2-button");

    function validarSubmit() {
        const cedulaOk = cedulaInput.data("valid") === true;
        const telOk = telefonoInput.data("valid") === true;
        const passOk = passwordHelp.text().length === 0;
        const pass2Ok = passwordMatchHelp.text().length === 0;

        btnSubmit.prop("disabled", !(cedulaOk && telOk && passOk && pass2Ok));
    }

</script>
