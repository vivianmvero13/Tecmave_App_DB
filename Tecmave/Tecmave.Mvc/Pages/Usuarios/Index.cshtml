@page
@model Tecmave.Mvc.Pages.Usuarios.IndexModel
@{
    Layout = "_Layout";
}

<h1>Usuarios</h1>

<a class="btn btn-primary" asp-area="" asp-page="/Usuarios/Crear">Nuevo registro</a>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Usuarios Registrados | TECMAVE CR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/theme-lighten.css">
    <link rel="stylesheet" href="../assets/css/brand-red-hard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <div class="app">

        <header class="topbar">
            <button class="iconbtn" data-toggle-sidebar><i class="fa-solid fa-bars"></i></button>
            <div id="site-header" class="brand2">
                <img class="logo-xs" src="../assets/img/tecmave_logo_innovacion.jpg" alt="Tecmave" style="width:20px;height:20px;border-radius:6px;margin-right:6px;">
                <span>Usuarios Registrados | TECMAVE CR</span>
            </div>
            <div class="search">
                <input id="search" type="search" placeholder="Buscar por nombre o correo…">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M21 21l-4.3-4.3M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="1.6" />
                </svg>
            </div>
            <button class="iconbtn"><i class="fa-regular fa-bell"></i></button>
            <button class="iconbtn"><i class="fa-regular fa-user"></i> <span id="user-display-name">Admin</span></button>
        </header>

        <main class="main">
            <div class="container">
                <div class="flex justify-between items-center">
                    <h1>Usuarios</h1>
                    <a class="btn btn-primary" href="usuario-crear.html"><i class="fa-solid fa-user-plus"></i> Nuevo usuario</a>
                </div>

                <div id="alert" class="alert" style="display:none;"></div>

                <div class="table-responsive mt-4">
                    <table class="table table-primary">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre de usuario</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th style="width:160px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="userTable"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <footer class="footer-v2" id="site-footer">
        <div class="footer-v2-main">
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-col">
                        <img src="../assets/img/tecmave_logo_innovacion.jpg" alt="Tecmave Logo" class="footer-logo">
                        <p class="footer-slogan">Simply #1 Real Estate Theme</p>
                        <div class="footer-v2-socials">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-pinterest"></i></a>
                            <a href="#"><i class="fab fa-youtube"></i></a>
                            <a href="#"><i class="fas fa-rss"></i></a>
                        </div>
                    </div>
                    <div class="footer-col">
                        <h4>Quick Links</h4>
                        <ul class="footer-list">
                            <li><a href="index.html">Home</a></li>
                            <li><a href="#">List Layout</a></li>
                            <li><a href="informacion.html">Blog</a></li>
                            <li><a href="contacto.html">Contact</a></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Contact Us</h4>
                        <ul class="footer-list contact-info">
                            <li><i class="fas fa-map-marker-alt"></i> <span>3015 Grand Ave, Coconut Grove, Merrick Way, FL 12345</span></li>
                            <li><i class="fas fa-phone-alt"></i> <span>+123-456-789</span></li>
                            <li><i class="fas fa-envelope"></i> <span>sales@example.com</span></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Remain Updated</h4>
                        <form class="subscribe-form">
                            <input type="email" placeholder="Your email address">
                            <button type="submit">Sign up</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-v2-bottom">
            <div class="container">
                <p>© 2025 All rights reserved.</p>
                <p>Designed by TECMAVE</p>
            </div>
        </div>
    </footer>

    <script>
        const API = {
          base: 'https://localhost:7096',
          usuarios: '/Usuario',              // GET lista, POST crear, DELETE ?id=, etc.
          roles: '/Roles',                   // GET /Roles/{id}
          estados: '/Estados'                // GET /Estados/{id}
        };

        const tbody = document.getElementById('userTable');
        const search = document.getElementById('search');
        const alertBox = document.getElementById('alert');

        function showAlert(msg, type='info') {
          alertBox.textContent = msg;
          alertBox.className = 'alert ' + (type === 'error' ? 'alert-danger' : 'alert-info');
          alertBox.style.display = 'block';
          setTimeout(()=> alertBox.style.display='none', 3000);
        }

        async function getJSON(url) {
          const r = await fetch(url, { credentials: 'include' });
          if (!r.ok) throw new Error('HTTP ' + r.status + ' ' + url);
          return r.json();
        }

        async function fetchRolNombre(idRol) {
          if (idRol == null) return '-';
          try {
            const data = await getJSON(`${API.base}${API.roles}/${idRol}`);
            return data?.nombre ?? data?.name ?? '-';
          } catch { return '-'; }
        }

        async function fetchEstadoNombre(idEstado) {
          if (idEstado == null) return '-';
          try {
            const data = await getJSON(`${API.base}${API.estados}/${idEstado}`);
            return data?.nombre ?? '-';
          } catch { return '-'; }
        }

        function renderRows(items) {
          tbody.innerHTML = '';
          items.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${u.id ?? u.Id ?? ''}</td>
              <td>${u.userName ?? u.nombre ?? '-'}</td>
              <td>${u.email ?? u.correo ?? '-'}</td>
              <td data-col="rol"><span class="badge subtle">Cargando…</span></td>
              <td data-col="estado"><span class="badge subtle">Cargando…</span></td>
              <td>
                <div class="btn-group">
                  <a class="btn btn-xs" href="usuario-editar.html?id=${u.id ?? u.Id}"><i class="fa-regular fa-pen-to-square"></i> Editar</a>
                  <button class="btn btn-xs btn-danger" data-action="del" data-id="${u.id ?? u.Id}">
                    <i class="fa-regular fa-trash-can"></i> Eliminar
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);

            Promise.all([
              fetchRolNombre(u.id_rol ?? u.roleId),
              fetchEstadoNombre(u.id_estado ?? u.estadoId)
            ]).then(([rol, estado]) => {
              tr.querySelector('[data-col="rol"]').textContent = rol;
              tr.querySelector('[data-col="estado"]').textContent = estado;
            }).catch(()=> {
              tr.querySelector('[data-col="rol"]').textContent = '-';
              tr.querySelector('[data-col="estado"]').textContent = '-';
            });
          });
        }

        async function cargarUsuarios() {
          try {
            showAlert('Cargando usuarios…');
            const usuarios = await getJSON(`${API.base}${API.usuarios}`);
            renderRows(usuarios);
            alertBox.style.display = 'none';
          } catch (e) {
            showAlert('No se pudieron cargar usuarios', 'error');
            console.error(e);
          }
        }

        async function eliminarUsuario(id) {
          if (!confirm('¿Eliminar este usuario?')) return;
          try {
            const url = `${API.base}${API.usuarios}?id=${encodeURIComponent(id)}`;
            const r = await fetch(url, { method: 'DELETE', credentials: 'include' });
            if (!r.ok) throw new Error('HTTP ' + r.status);
            showAlert('Usuario eliminado');
            await cargarUsuarios();
          } catch (e) {
            showAlert('No se pudo eliminar el usuario', 'error');
            console.error(e);
          }
        }

        tbody.addEventListener('click', e => {
          const btn = e.target.closest('button[data-action="del"]');
          if (!btn) return;
          eliminarUsuario(btn.dataset.id);
        });

        search.addEventListener('input', async () => {
          try {
            const q = search.value.trim().toLowerCase();
            const usuarios = await getJSON(`${API.base}${API.usuarios}`);
            const filtrados = usuarios.filter(u => {
              const nombre = (u.userName ?? u.nombre ?? '').toLowerCase();
              const correo = (u.email ?? u.correo ?? '').toLowerCase();
              return nombre.includes(q) || correo.includes(q);
            });
            renderRows(filtrados);
          } catch (e) {
            console.error(e);
          }
        });

        document.addEventListener('DOMContentLoaded', cargarUsuarios);
    </script>

    <script src="../assets/js/dashboard.js"></script>
    <script defer src="../assets/js/nav-active.js"></script>
    <script defer src="../assets/js/role-ui.js"></script>
    <script defer src="../assets/js/carousel-polish.js"></script>
    <script defer src="../assets/js/app.js"></script>
</body>
</html>
